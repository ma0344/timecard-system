# フレックス清算機能ドキュメント

作成日: 2025-11-29
最終更新: 2025-11-29
関連担当: 未割当

## 1. 背景と目的

- 常勤者向けフレックスタイム制の実労働時間と所定労働時間の差分（清算差）を、ユーザー本人が即時把握できるようにする。
- 月度境界が設定値（period_start / period_end）依存のため、従来のカレンダー月ではなく「会社月度」で集計する必要があった。
- 清算月（偶数月）では 2 ヶ月合算での判断が求められ、従来 UI にはその指標が存在しなかった。
- 欠勤・有給・打刻漏れと合わせて、My Day ダッシュボードと月次一覧に同じ指標を掲示し、運用負荷を下げることが目標。

## 2. 概要

### 2.1 対象システム / ファイル

- API: `api/flex_summary.php`
  - 常勤判定、月度計算、実労働/有給/所定の分単位合計、清算月時の 2 ヶ月集計を返却。
- ダッシュボード: `myday_dashboard.html`
  - 「フレックス」カードを追加し、最新の月度差分と清算月の 2 ヶ月合算を表示。
- 勤務記録一覧: `attendance_list.html`
  - ヘッダー下部にフレックスサマリを掲示し、月選択 UI と連動。

### 2.2 用語

- 月度: 設定テーブルの `period_start` / `period_end` で決まる勤務月度。
- 清算月: 偶数月（2,4,6,8,10,12）。当月と前月の 2 ヶ月合算差分が必要。
- 所定労働時間: `settings` テーブルの `legal_hours_*` を基に日数別に決定。
- 実労働時間: `timecards` と `breaks` から取得した打刻ベースの稼働時間。
- 有給時間: `paid_leave_use_events.total_hours` を分換算したもの。

## 3. 要件

### 3.1 機能要件

1. 常勤ユーザーのみを対象とし、非対象の場合は UI を非表示にする。
2. 月度指定（`YYYY-MM`）を受け取り、該当月度の所定・実労働・有給・差分（分）を返す。
3. 清算月は `two_month` ブロックを返却し、前月分を合算した差分を算出する。
4. レスポンスに丸め設定（`rounding_type`, `rounding_unit`）を含め、UI 側で表示文言を作れるようにする。
5. My Day ダッシュボードはログイン直後と自動更新サイクルでカードを再描画する。
6. 勤務記録一覧は月選択変更時に API を再呼び出し、差分を最新化する。
7. API は 401/403 を返した場合、既存の `fetchWithAuth` でログイン画面へ遷移させる。

### 3.2 非機能要件

- パフォーマンス: 期間の集計クエリは 2 ヶ月（最大 62 日）以内に限定。1 リクエスト 200ms 以内を目安。
- 信頼性: DB 集計に失敗した場合は 500 を返し、UI はカード非表示またはエラーメッセージでフォールバック。
- セキュリティ: セッション認証（`check_login`）に従い、他ユーザーの情報が取得できないこと。
- 可観測性: 例外発生時はメッセージを JSON で返し、サーバーログから解析できるようにする。

## 4. 実装プラン

| フェーズ | 内容                         | 状態   | 備考                                         |
| -------- | ---------------------------- | ------ | -------------------------------------------- |
| P0       | 要件整理・UI レイアウト案    | 完了   | My Day / 勤務記録一覧両方の配置決定          |
| P1       | API `flex_summary.php` 実装  | 完了   | セッション認証・常勤判定・月度計算を実装     |
| P2       | My Day のカード描画          | 完了   | `refreshFlexSummary()` で初期ロード+自動更新 |
| P3       | 勤務記録一覧のヘッダーサマリ | 完了   | 月選択変更時の再取得・差分表示               |
| P4       | QA / バリデーション          | 進行中 | 実データでの検証、清算月 2 ヶ月差分確認      |
| P5       | ドキュメント整備             | 今回   | 本ドキュメントおよび Issue 化                |

## 5. 受け入れ基準 (Acceptance Criteria)

- 常勤ユーザーで My Day を開くとフレックスカードが表示され、今月差分と必要に応じて 2 ヶ月差分が正しい値で表示される。
- 非常勤ユーザーではフレックスカードが表示されず、API が `is_full_time=false` を返す。
- 勤務記録一覧の月選択を変更すると、応答の `month_label` がヘッダーに反映され、差分値が再計算される。
- 清算月では `two_month.delta_minutes` の値が UI に表示され、前月・当月の期間情報が詳細欄に記載される。
- API へのリクエストが失敗した場合、My Day や勤務記録一覧がエラー表示を出さず安全に非表示へフォールバックする。
- 丸め設定（`display.rounding_type` / `display.rounding_unit`）が UI 詳細欄に表示される。

## 6. 既知の課題 / リスク

- QA 未完了: 実データでの検証が不足しており、2 ヶ月清算ロジックの正しさを確認する必要がある。
- 休職・特別休暇など特殊な日区分が実労働集計にどう影響するか要確認。
- 清算差分の色分けは ±0 判定のみであり、閾値（例: ±10 分以内は中立）などの運用ルールは未定。
- 集計範囲が最大 62 日であるため、長期休暇が跨ると所定時間計算の妥当性を再確認する必要がある。

## 7. 今後のアクション

1. テストデータ（1 ヶ月 / 2 ヶ月ケース）を作成し、実労働と所定の突合を実施。
2. part-time 判定メッセージを UI 上で明示（必要なら情報カードを表示）。
3. 丸め設定が 0.5h などに変更された場合の表示フォーマットを QA。
4. API レスポンスのメトリクスを監視に組み込むか検討。

## 8. 参考資料

- `docs/ROADMAP_USER_UI.md` セクション F: My Day / 勤務記録強化
- `docs/issues/ATT-001_attendance_list_enhancements.md`
- `myday_dashboard.html` / `attendance_list.html` 内の `refreshFlexSummary()` 実装
- `api/flex_summary.php` ソースコード
