# My Day（個人ダッシュボード）機能の新規実装

ステータス: Closed
作成日: 2025-11-08
担当: 未割当
関連: api/me_summary.php

## 目的

打刻画面と一覧の間をつなぐ「今日の状況・アクション」起点を 1 画面に集約し、自己完結・即時対処を促進する。

## 要件（MVP）

- 今日の打刻ステータス（出勤/休憩/退勤）と当日の警告（退勤漏れなど）を表示
- 直近 3〜5 日の欠落サマリ（各行から対象日へジャンプ）
- クイックアクション：打刻画面へ／欠落日の修正申請へ／本日のメモ（任意）
- 未読通知の件数と最新 3 件（通知センターへ遷移）

## 受入基準

- モバイル片手操作可、初回表示 1 秒以内の体感（スケルトン可）
- クリック 2 回以内で「打刻」「欠落日ジャンプ」が可能

## API 案

- GET `api/me_summary.php`：today_status + recent_missing + unread_count をまとめて返す

## 具体的な UI/UX 要件・方針（2025/11 追記）

### モバイル最適化・直感的デザイン

- ステータス（出勤済・休憩中・退勤済・未打刻など）は色分け＋アイコンで一目で判別（例：出勤済=青、休憩中=黄、退勤済=グレー、未打刻=赤）
- 警告は赤やオレンジなど注意色で背景・バッジ表示し、文字も併記
- 画面上部に大きなステータスサークルやバッジ（色＋アイコン＋短いラベル）
- クイックアクションは親指で押しやすい下部固定ボタンや大きめのタッチ領域
- 44px 以上のタップ領域、片手操作・親指リーチを意識した配置
- 色覚多様性にも配慮し、色＋アイコン＋ラベルの三重表現
- 状態や警告の変化時にアニメーションや色の変化で即時フィードバック
- 未読通知はバッジやドットで強調

### クイックアクション・ボタン表示の動的制御

- 状態に応じて主要ボタンのみ表示（例：出勤前 → 出勤ボタンのみ、勤務中 → 休憩開始・退勤ボタンのみ、休憩中 → 休憩終了・退勤ボタンのみ）
- 状態に合わないアクションは非表示（グレーアウトではなく非表示）
- 日常的に使うボタンは 1 タップでアクセス、休日・有休などは「その他」や 2 タップ目以降のサブメニューに格納
- 画面下部に大きな 1〜2 個の主要ボタン＋「その他」ボタン、状態遷移ごとに内容が切り替わる

---

## 実装結果サマリ（クローズ記録 2025-11-10）

MVP 要件は全て実装・検証済み。

### 実装した主機能

- ステータス帯（出勤/休憩/退勤）＋動的クイックアクション表示制御
- 本人向けアラート（未退勤・未打刻）ピル表示／日付一覧モーダル／個別日モーダル → 該当日ジャンプ
- 今日のタイムライン（降順ソート、折りたたみ UI、開いた時のみフェッチ）
- 今日のメモ（localStorage 自動保存 600ms デバウンス、退勤時サーバ UPSERT、退勤成功後ローカルクリア）
- 通知未読バッジ（0 件時非表示）＋最新 3 件プレビュー（一行表示、未読優先、NEW バッジ）
- 初期ロード & 定期更新（60s）で status / alerts / timeline / notifications / memo キー再初期化（日付跨ぎ検出）

### 技術的ポイント

- fetchWithAuth で 401/403 時リダイレクト（共通化）
- Promise.allSettled による並列初期ロード & 定期更新、visibilitychange で復帰時即時更新
- タイムラインは折りたたみ未展開時にフェッチ抑止で不要トラフィック削減
- メモ UPSERT（`api/clock_out.php`）は失敗しても退勤処理を阻害しない（耐障害性）
- 通知プレビューは未読 → 既読の優先順序合成（最大 3 件）で軽量化
- 一行レイアウト用の CSS（ellipsis）適用済み

### 受入基準の達成状況

- 片手操作: 大ボタン/中央寄せ＋不要ボタン非表示でタップ最小化
- 打刻/欠落日ジャンプ: 2 タップ以内で可能（ピル → モーダル → ジャンプ or クイックアクション）
- 初回表示: 並列ロード／表示ブロッキング要素の分離（体感高速）。スケルトン簡易表示（"取得中" テキスト）による即時フィードバック

### 残課題 / 任意改善（ROADMAP_USER_UI.md にバックログ化）

- 集約 API（`api/me_summary.php`）導入で初期リクエスト削減
- 通知プレビューの種別アイコン・未読フィルタトグル
- メモ履歴参照 API (`day_memo_get.php`) 追加
- オフライン（PWA + キャッシュ）対応 / fetch AbortController 導入
- アクセシビリティ: スキップリンク / landmark 追加 / 状態変化の aria ライブ改善

### クローズ判定

要件・受入基準全て実装済み。追加改善は任意。Issue をクローズします。

---

（参照）目的・要件・受入基準・API 案は `docs/ROADMAP_USER_UI.md` 『A. My Day』に準拠。
