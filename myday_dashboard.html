<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Day - ダッシュボード</title>
  <link rel="stylesheet" href="css/common.css" />
  <style>
    html,
    body {
      height: 100%;
    }

    body {
      margin: 0;
      background: var(--bg);
      color: #333;
      font-family: 'Segoe UI', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    }

    .container {
      max-width: 480px;
      margin: 0 auto;
      min-height: 100dvh;
      display: flex;
      flex-direction: column;
      grid-template-rows: auto auto auto 1fr auto auto auto;
      padding: 1rem 1rem 1rem 1rem;
      box-sizing: border-box;
    }

    .header {
      display: grid;
      grid-template-columns: 1fr auto auto;
      align-items: center;
      justify-content: space-between;
    }

    h2 {
      margin: 0.4em 0;
      color: var(--accent);
    }

    /* ハンバーガー（punch.htmlから継承） */
    .alert-notification-badge {
      position: unset;
      align-self: center;
      justify-content: center;
      width: fit-content;
      min-width: 18px;
      height: 18px;
      line-height: 18px;
      text-align: center;
      margin-right: 5px;
    }

    /* カードベース */
    .card {
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 0.5rem 1rem;
      margin-top: 0.7rem
    }

    /* ステータス帯 */
    .status-card {
      align-items: center;
    }

    .status-card-header {
      display: grid;
      grid-template-columns: auto 1fr auto auto;
      align-items: center;
      gap: 0.8rem;
    }

    .status-dot {
      width: 18px;
      height: 18px;
      border-radius: 9px;
    }

    .status-dot.work {
      background: var(--accent);
    }

    .status-dot.break {
      background: var(--warn);
    }

    .status-dot.off {
      background: #9e9e9e;
    }

    .status-dot.alert {
      box-shadow: 0 0 0 4px rgba(229, 57, 53, .12);
    }

    .status-text {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--accent);
    }

    .status-sub {
      font-size: 0.9rem;
      color: #666;
    }

    /* 警告インジケータ（有無の提示→概要→詳細の粒度分け） */
    .alert-strip {
      display: none;
      gap: 6px;
      flex-wrap: wrap;
      margin-top: 0.7rem;
    }

    .alert-card {
      background: #ffebee;
      color: #c62828;
      border-color: #ffcdd2;
    }

    .alert-pill {
      background: #ffebee;
      /* 赤系の薄い背景 */
      color: #c62828;
      border-color: #ffcdd2;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 12px;
      height: fit-content;
      cursor: pointer;
      position: relative;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      user-select: none;
    }

    .alert-pill:hover {
      background: #ffdede;
    }

    .alert-pill::after {
      content: '\25B6';
      /* ▶ */
      font-size: 10px;
      color: #e65100;
      opacity: .7;
      transform: translateY(1px);
    }

    .alert-pill:active {
      transform: scale(.96);
    }

    /* 未打刻用のカラーバリエーション */
    .alert-pill.missing {
      background: #fff3e0;
      color: #e65100;
      border: 1px solid #ffe0b2;
    }

    .alert-pill.missing:hover {
      background: #ffe7c2;
    }

    .alert-pill.missing::after {
      color: #c62828;
    }

    .alert-strip.has-alerts {
      display: flex;
      height: fit-content;
    }

    /* alertDateModal内の行アイテムのスタイル */
    .alertDateModal-RowItem {
      width: 100%;
      text-align: left;
      padding: 8px 10px;
      border-radius: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: .9rem;
    }

    /* 警告行アイテムのカラー */
    .warningRowItem {
      border: 1px solid #ffe0b2;
      color: #e65100;
      background: #fffaf2;
    }

    /* 重要警告行のカラー */
    .criticalRowItem {
      border: 1px solid #ffcdd2;
      background: #ffebee;
      color: #c62828;
    }

    /* クイックアクションを画面中央付近に集約 */
    .actions {
      display: grid;
      gap: 12px;
      margin-inline: auto;
      width: min(100%, 520px);
    }

    .action-btn {
      height: var(--action-btn-h);
      border: none;
      border-radius: 8px;
      background: var(--accent);
      color: #fff;
      font-size: 1.25rem;
      font-weight: 600;
      box-shadow: var(--shadow);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform .06s ease, background .2s ease;
    }

    .action-btn:active {
      transform: scale(0.98);
    }

    .action-btn.secondary {
      background: #455a64;
    }

    .action-btn.warn {
      background: var(--warn);
    }

    .action-btn.muted {
      background: #90a4ae;
    }

    .action-btn.hidden {
      display: none !important;
    }

    /* メモカード */
    .memo-card-header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }

    #dayMemo {
      width: 100%;
      box-sizing: border-box;
      margin-top: 8px;
      font-size: 0.95rem;
      line-height: 1.5;
      padding: 10px 12px;
      border: 1px solid #b0bec5;
      border-radius: 8px;
      resize: vertical;
      min-height: 90px;
      max-height: 240px;
      background: #fafafa;
    }

    #dayMemo:focus {
      outline: 2px solid #90caf9;
      background: #fff;
    }

    .memo-meta {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 4px;
      font-size: 0.75rem;
      color: #607d8b;
      flex-wrap: wrap;
      gap: 4px;
    }

    .memo-status.ok {
      color: var(--ok);
    }

    .memo-status.err {
      color: var(--danger);
    }

    .sub-actions-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 12px;
    }

    .sub-actions-row .mini-btn {
      height: 40px;
      font-size: 1rem;
      padding: 0 14px;
      border: none;
      border-radius: 8px;
      background: #455a64;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      box-shadow: var(--shadow);
      display: flex;
      align-items: center;
    }

    .sub-actions-row .mini-btn.primary {
      background: var(--accent);
    }

    .sub-actions-row .mini-btn:active {
      transform: scale(.97);
    }

    /* タイムライン */
    .timeline-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      cursor: pointer;
    }

    .timeline-title {
      font-weight: 600;
      color: var(--accent);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .timeline-body {
      margin-top: 8px;
    }

    .timeline-list {
      --item-gap: 10px;
      --item-padding-vertical: 6px;
      --item-border-bottom: 1px;
      --item-font-size: 0.9rem;
      --line-height: 1.5;
      overflow-y: auto;
      list-style: none;
      margin: 0;
      padding: 0;
      line-height: var(--line-height);
      max-height: calc((var(--item-gap) + (var(--item-padding-vertical) * 2) + var(--item-font-size) + var(--item-border-bottom)) * 4);
    }

    .timeline-item {
      display: flex;
      gap: var(--item-gap);
      padding: var(--item-padding-vertical) 4px var(--item-padding-vertical) 2px;
      border-bottom: var(--item-border-bottom) solid #eee;
      ;
      font-size: var(--item-font-size);
      align-items: flex-start;
    }

    .timeline-item:last-child {
      border-bottom: none;
    }

    .timeline-item .ts {
      font-weight: 600;
      color: var(--accent);
      min-width: 64px;
    }

    .timeline-item .label {
      flex: 1;
    }

    .timeline-empty {
      font-size: 0.9rem;
      color: #666;
      padding: 4px 2px;
    }

    /* 通知プレビューカード */
    .notif-preview-card {
      display: none;
      position: absolute;
      top: 100%;
      right: 0;
      background: #fff;
      border: 1px solid #eee;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      z-index: 9999;
    }

    .notif-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }

    .notif-statusDot {
      background: #fff;
    }

    .notif-title {
      font-weight: 600;
      color: var(--accent);
      font-size: 1.05rem;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    /* フレックス清算カード */
    .flex-card {
      display: none;
      gap: 10px;
    }

    .flex-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    .flex-card-header-sub {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
    }

    .flex-card-title {
      font-weight: 600;
      font-size: 1.05rem;
      color: var(--accent);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .flex-card-sub {
      font-size: 0.85rem;
      color: #607d8b;
    }

    .flex-card-body {
      display: none;
      flex-direction: column;
      gap: 6px;
    }

    .flex-line {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      font-size: 0.95rem;
    }

    .flex-detail {
      font-size: 0.8rem;
      color: #607d8b;
      line-height: 1.4;
    }

    .flex-detail-line {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      font-size: 0.8rem;
      color: #607d8b;
    }

    .flex-delta {
      font-weight: 600;
    }

    .flex-delta.positive {
      color: #1b5e20;
    }

    .flex-delta.negative {
      color: #c62828;
    }

    .flex-delta.neutral {
      color: #455a64;
    }

    /* 高さチューニング：主要アクションを 50〜75% 帯に寄せる */
    /*height: clamp(8dvh, 18dvh, 24dvh);*/
    .band-spacer {
      flex-grow: 1;
    }

    @media (min-width: 560px) {

      /* タブレット等ではアクションの縦サイズをやや控えめに */
      /*height: clamp(6dvh, 12dvh, 20dvh);*/
      :root {
        --action-btn-h: clamp(52px, 5.5dvh, 72px);
      }

      .band-spacer {
        flex-grow: 1;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h2>My Day</h2>
      <span id="alert-badge" class="alert-pill alert-notification-badge">警告</span>
      <button id="menuToggle" class="hamburger" aria-label="メニュー" aria-expanded="false" aria-controls="sideMenu">
        <span class="bar"></span>
        <span class="bar"></span>
        <span class="bar"></span>
        <span id="menuNotifBadge" class="notif-badge"></span>
      </button>
    </div>
    <!-- ステータス帯 + 警告有無の提示 -->
    <section id="alertCard" class="card alert-card" aria-expanded="true" aria-live="polite" aria-label="警告" style="display:none;">
      <div id="alertCardHeader">
        <button id="alertToggle" class="expand-toggle" aria-controls="alertBody" aria-expanded="true" style="color: #c62828;">∨</button>
        <span id="alert-title">警告</span>
      </div>
      <div id="alertBody" class="alert-card-body" style="display:block;">
        <div id="alertStrip" class="alert-strip" aria-live="polite"></div>
      </div>
    </section>
    <section id="statusCard" class="card status-card" aria-live="polite" aria-expanded="false">
      <div id="statusCardHeader" class="status-card-header">
        <span id="statusDot" class="status-dot off"></span>
        <div>
          <div id="statusText" class="status-text">状態: 取得中…</div>
          <div id="statusSub" class="status-sub"></div>
        </div>
        <div id="todayDate" class="status-sub"></div>
        <div class="timeline-title">
          <button id="timelineToggle" class="expand-toggle" aria-controls="timelineBody" aria-expanded="false">＞</button>
          <span>タイムライン</span>
        </div>
      </div>
      <div id="timelineBody" class="timeline-body" style="display:none;" aria-live="polite"></div>
    </section>
    <!-- フレックス清算サマリ（常勤のみ） -->
    <section id="flexCard" class="card flex-card" aria-expanded="false" aria-live="polite" aria-label="フレックス清算状況">
      <div class="flex-card-header" id="flexHeader">
        <div class="flex-card-title">
          <button id="flexToggle" class="expand-toggle" aria-controls="flexBody" aria-expanded="false">＞</button>
          <span>フレックス</span>
        </div>
        <div class="flex-card-header-sub">
          <span id="flexMonthLabel" style="font-size: 0.8rem;"></span>
        </div>
      </div>
      <div id="flexBody" class="flex-card-body" aria-live="polite">
        <div id="flexCurrent" class="flex-line">
          <span>今月</span>
          <span id="flexCurrentDelta" class="flex-delta neutral">±0:00</span>
        </div>
        <div id="flexDetail" class="flex-detail">
          <div class="flex-detail-line">
            <span id="flexPeriodLabel">期間</span>
            <span id="flexPeriod">2025年1月16日～2025年2月15日</span>
          </div>
          <div class="flex-detail-line">
            <span id="flexWorkedMinutesLabel">実働 / 所定</span>
            <span id="flexWorkedMinutes">0:00 / 0:00</span>
          </div>
          <div class="flex-detail-line">
            <span id="flexPaidLeaveMinutesLabel">有給</span>
            <span id="flexPaidLeaveMinutes">0:00</span>
          </div>
        </div>
        <div id="flexTwoMonth" class="flex-line" style="display:none;">
          <span>フレックス算定</span>
          <span id="flexTwoMonthDelta" class="flex-delta neutral">±0:00</span>
        </div>
        <div id="flexDetail-TwoMonth" class="flex-detail" style="display:none;">
          <div class="flex-detail-line">
            <span id="flexSettlementMonthsLabel">算定期間</span>
            <span id="flexSettlementMonths">2025年1月度/2025年2月度</span>
          </div>
          <div class="flex-detail-line">
            <span id="flexTwoMonthWorkedMinutesLabel">実働 / 所定</span>
            <span id="flexTwoMonthWorkedMinutes">0:00 / 0:00</span>
          </div>
          <div class="flex-detail-line">
            <span id="flexTwoMonthPaidLeaveMinutesLabel">有給</span>
            <span id="flexTwoMonthPaidLeaveMinutes">0:00</span>
          </div>
        </div>
      </div>
    </section>
    <!-- 最新通知(最大3件)プレビュー -->
    <section id="notifPreviewCard" class="card" style="display:none;" aria-label="最新のお知らせ" aria-expanded="false">
      <div class="notif-card-header" id="notifCardHeader">
        <div class="notif-title">
          <button id="notifToggle" class="expand-toggle" aria-controls="notifPreviewList" aria-expanded="false">＞</button>
          <span class="notif-statusDot">最新通知</span><span id="notifCount" style="margin-left: 1em;">未読 0</span>
        </div>
        <div class="notifButtons" style="display: flex; gap: 8px;">
          <button id="openAllNotif" style="background:#455a64;color:#fff;border:none;border-radius:6px;padding:6px 12px;font-size:.8rem;cursor:pointer;">全て表示</button>
        </div>
      </div>
      <ul id="notifPreviewList" style="list-style:none;padding:0;margin:10px 0 0 0;display:none;gap:6px;"></ul>
    </section>
    <!-- アクション帯を画面中央付近に寄せるためのスペーサ（動的） -->
    <div class="band-spacer" aria-hidden="true"></div>
    <!-- クイックアクション（状態に応じて限定表示。不要なものは非表示） -->
    <section class="actions">
      <button id="actClockIn" class="action-btn">出勤</button>
      <button id="actBreakStart" class="action-btn warn hidden">休憩開始</button>
      <button id="actBreakEnd" class="action-btn warn hidden">休憩終了</button>
      <button id="actClockOut" class="action-btn secondary hidden">退勤</button>
      <button id="actOpenPunch" class="action-btn muted hidden">打刻ページを開く</button>
    </section>
    <!-- 下段：今日のメモ（端末に保存） + 導線 -->
    <section id="memoCard" class="card" aria-label="今日のメモ">
      <div class="memo-card-header">
        <div style="font-weight:600;color:#1976d2;font-size:1.05rem;">今日のメモ</div>
        <div id="memoHint" style="font-size:0.8rem;color:#607d8b;">端末に自動保存 / 退勤でクリア→サーバーに送信</div>
      </div>
      <textarea id="dayMemo" maxlength="1000" placeholder="本日の特記事項, タスク, 共有事項などをメモできます"></textarea>
      <div class="memo-meta">
        <span id="memoCount">0 / 1000</span>
        <span id="memoStatus" class="memo-status" aria-live="polite"></span>
      </div>
      <div class="sub-actions-row">
        <button id="openList" class="mini-btn">勤務・有給 管理</button>
        <button id="openPaidLeave" class="mini-btn primary">有給申請</button>
      </div>
    </section>
  </div>
  <!-- メニュー -->
  <div id="menuOverlay" class="menu-overlay" tabindex="-1"></div>
  <nav id="sideMenu" class="menu-drawer" aria-hidden="true" tabindex="-1">
    <div class="menu-header">メニュー</div>
    <ul class="menu-list">
      <li>
        <div class="menu-list" style="position:relative;display:flex;align-items:center;cursor:pointer;">
          <button type="button" id="menuOpenNotif" style="width: fit-content;">お知らせを開く</button>
          <span id="notifBadgeInMenu" class="notif-badge" style="position:unset; cursor: pointer;"></span>
        </div>
      </li>
      <li><a href="attendance_list.html">勤務・有給 管理</a></li>
      <li><a href="punch.html">打刻ページ</a></li>
      <li><a href="admin.html" id="menuAdmin" style="display:none;">管理者メニュー</a></li>
      <li><button type="button" id="menuLogout">ログアウト</button></li>
    </ul>
  </nav>
  <script>
    // 共通: 認証付き fetch
    async function fetchWithAuth(url, options) {
      const res = await fetch(url, options);
      if (res.status === 401 || res.status === 403) { window.location.href = 'login.html'; return null; }
      return res;
    }

    // ログイン/権限/氏名
    let userId = null; let isAdmin = false;
    let useVehicle = 1;
    (async () => {
      const res = await fetchWithAuth('api/check_login.php');
      const data = res && await res.json();
      if (!data || !data.loggedIn) { window.location.href = './login.html'; return; }
      userId = data.user_id; isAdmin = !!data.is_admin; useVehicle = (data && data.use_vehicle !== undefined) ? Number(data.use_vehicle) : 1;
      const menuAdmin = document.getElementById('menuAdmin');
      if (menuAdmin) menuAdmin.style.display = isAdmin ? 'block' : 'none';
      // 初期データ読み込み
      await Promise.allSettled([
        refreshStatus(),
        refreshNotifCount(),
        refreshAlerts(),
        refreshTimeline(),
        refreshNotifPreview(),
        refreshFlexSummary()
      ]);
      // メモ初期化（ユーザーID取得後）: スクリプト末尾まで実行完了後に実行
      setTimeout(() => initMemo(), 0);
    })();

    // 現在日付表示
    function updateTodayLabel() {
      const now = new Date();
      const pad = n => n.toString().padStart(2, '0');
      document.getElementById('todayDate').textContent = `${now.getFullYear()}年${pad(now.getMonth() + 1)}月${pad(now.getDate())}日`;
    }
    updateTodayLabel(); setInterval(updateTodayLabel, 60_000);

    // ステータス
    const state = { clockedIn: false, clockedOut: false, onBreak: false };
    const flexCard = document.getElementById('flexCard');
    const flexMonthLabel = document.getElementById('flexMonthLabel');
    const flexCurrentDelta = document.getElementById('flexCurrentDelta');
    const flexTwoMonthRow = document.getElementById('flexTwoMonth');
    const flexTwoMonthDelta = document.getElementById('flexTwoMonthDelta');
    const flexDetail = document.getElementById('flexDetail');
    const flexDetailTwoMonth = document.getElementById('flexDetail-TwoMonth');

    function minutesToHM(minutes) {
      const numeric = Number(minutes);
      if (!Number.isFinite(numeric)) return '0:00';
      const abs = Math.abs(Math.round(numeric));
      const sign = numeric < 0 ? '-' : '';
      const h = Math.floor(abs / 60);
      const m = String(abs % 60).padStart(2, '0');
      return `${sign}${h}:${m}`;
    }

    function formatDelta(minutes) {
      const numeric = Number(minutes);
      if (!Number.isFinite(numeric) || numeric === 0) return '±0:00';
      const abs = Math.abs(Math.round(numeric));
      const h = Math.floor(abs / 60);
      const m = String(abs % 60).padStart(2, '0');
      return `${numeric > 0 ? '+' : '-'}${h}:${m}`;
    }

    function updateFlexDelta(el, minutes) {
      if (!el) return;
      el.classList.remove('positive', 'negative', 'neutral');
      const numeric = Number(minutes);
      if (!Number.isFinite(numeric)) {
        el.textContent = '--:--';
        el.classList.add('neutral');
        return;
      }
      el.textContent = formatDelta(numeric);
      if (numeric > 0) {
        el.classList.add('positive');
      } else if (numeric < 0) {
        el.classList.add('negative');
      } else {
        el.classList.add('neutral');
      }
    }

    function formatDateJP(iso) {
      if (!iso || typeof iso !== 'string') return '';
      const parts = iso.split('-').map(Number);
      if (parts.length !== 3 || parts.some(Number.isNaN)) return iso;
      return `${parts[0]}年${parts[1]}月${parts[2]}日`;
    }

    function formatPeriodRange(period) {
      if (!period || !period.start || !period.end) return '';
      const start = formatDateJP(period.start);
      const end = formatDateJP(period.end);
      return start && end ? `${start}〜${end}` : '';
    }

    async function refreshFlexSummary() {
      if (!flexCard) return;
      try {
        const res = await fetchWithAuth('api/flex_summary.php');
        if (!res || !res.ok) throw new Error('flex fetch failed');
        const data = await res.json();
        if (!data || data.ok === false || data.is_full_time === false) {
          flexCard.style.display = 'none';
          return;
        }
        flexCard.style.display = 'block';
        flexMonthLabel.textContent = data.month_label || '';
        updateFlexDelta(flexCurrentDelta, data.delta_minutes);
        if (data.is_settlement_month && data.two_month) {
          flexTwoMonthRow.style.display = 'flex';
          updateFlexDelta(flexTwoMonthDelta, data.two_month.delta_minutes);
        } else {
          flexTwoMonthRow.style.display = 'none';
        }
        const flexWorkedMinutes = document.getElementById('flexWorkedMinutes');
        const flexPaidLeaveMinutes = document.getElementById('flexPaidLeaveMinutes');
        const flexPeriod = document.getElementById('flexPeriod');
        const flexSettlementMonths = document.getElementById('flexSettlementMonths');
        const flexTwoMonthWorkedMinutes = document.getElementById('flexTwoMonthWorkedMinutes');
        const flexTwoMonthPaidLeaveMinutes = document.getElementById('flexTwoMonthPaidLeaveMinutes');
        flexWorkedMinutes.textContent = ` ${minutesToHM(data.worked_minutes)} / ${minutesToHM(data.legal_minutes)}`;
        flexPaidLeaveMinutes.textContent = minutesToHM(data.paid_leave_minutes);
        flexPeriod.textContent = formatPeriodRange(data.period);
        var labels = ''
        if (data.is_settlement_month && data.two_month) {
          labels = Array.isArray(data.two_month.month_labels) ? data.two_month.month_labels.join(' / ') : '';
          flexSettlementMonths.textContent = labels;
          flexTwoMonthWorkedMinutes.textContent = ` ${minutesToHM(data.two_month.worked_minutes)} / ${minutesToHM(data.two_month.legal_minutes)}`;
          flexTwoMonthPaidLeaveMinutes.textContent = minutesToHM(data.two_month.paid_leave_minutes);
          if (flexDetailTwoMonth) flexDetailTwoMonth.style.display = 'block';
        } else {
          flexSettlementMonths.textContent = '';
          flexTwoMonthWorkedMinutes.textContent = '';
          flexTwoMonthPaidLeaveMinutes.textContent = '';
          if (flexDetailTwoMonth) flexDetailTwoMonth.style.display = 'none';
        }
      } catch (e) {
        flexCard.style.display = 'none';
      }
    }
    function applyStatusUI() {
      const dot = document.getElementById('statusDot');
      const text = document.getElementById('statusText');
      const sub = document.getElementById('statusSub');
      dot.className = 'status-dot';
      // デフォルト
      let label = '未出勤'; let subTxt = '';
      if (state.clockedOut) { dot.classList.add('off'); label = '退勤済み'; }
      else if (state.clockedIn && state.onBreak) { dot.classList.add('break'); label = '休憩中'; }
      else if (state.clockedIn) { dot.classList.add('work'); label = '勤務中'; }
      else { dot.classList.add('off'); }
      text.textContent = `状態: ${label}`;
      sub.textContent = subTxt;

      // アクション表示制御（不要は非表示）
      const actClockIn = document.getElementById('actClockIn');
      const actBreakStart = document.getElementById('actBreakStart');
      const actBreakEnd = document.getElementById('actBreakEnd');
      const actClockOut = document.getElementById('actClockOut');
      const actOpenPunch = document.getElementById('actOpenPunch');
      [actClockIn, actBreakStart, actBreakEnd, actClockOut, actOpenPunch].forEach(el => el.classList.add('hidden'));
      if (!state.clockedIn && !state.clockedOut) {
        actClockIn.classList.remove('hidden');
        actOpenPunch.classList.remove('hidden');
      } else if (state.clockedIn && !state.clockedOut && !state.onBreak) {
        actBreakStart.classList.remove('hidden');
        actClockOut.classList.remove('hidden');
        actOpenPunch.classList.remove('hidden');
      } else if (state.clockedIn && !state.clockedOut && state.onBreak) {
        actBreakEnd.classList.remove('hidden');
        actClockOut.classList.remove('hidden');
        actOpenPunch.classList.remove('hidden');
      } else if (state.clockedOut) {
        actOpenPunch.classList.remove('hidden');
      }
    }
    async function refreshStatus() {
      try {
        const res = await fetchWithAuth('api/timecard_status.php');
        const s = res && await res.json(); if (!s) return;
        state.clockedIn = !!s.clockedIn; state.clockedOut = !!s.clockedOut; state.onBreak = !!s.onBreak;
        applyStatusUI();
      } catch (e) { /* noop */ }
    }

    // 警告（有無→概要）
    async function refreshAlerts() {
      const strip = document.getElementById('alertStrip');
      const badge = document.getElementById('alert-badge');
      const alertCard = document.getElementById('alertCard');
      const alertCardTitle = document.getElementById('alert-title');
      badge.style.display = 'none';
      strip.classList.remove('has-alerts');
      strip.innerHTML = '';
      try {
        // ユーザー自身のアラートAPIから取得
        const res = await fetchWithAuth('api/my_alerts.php?days=7');
        const data = res && await res.json();
        const badgeText = '警告 ';
        const items = (data && data.items) || {};

        // 退勤未打刻の配列
        const arrIncomplete = Array.isArray(items.past_incomplete) ? items.past_incomplete : [];
        // 未打刻（配列 of 'YYYY-MM-DD'）
        const myMissingDates = Array.isArray(items.missing_dates) ? items.missing_dates : [];

        const totalCount = arrIncomplete.length + myMissingDates.length;
        if (totalCount > 0) {
          strip.classList.add('has-alerts');
          const labelText = totalCount > 99 ? '99+' : String(totalCount);
          badge.style.display = 'flex';
          badge.textContent = badgeText + labelText;
          alertCard.style.display = 'block';
          alertCardTitle.textContent = `警告 ${labelText}件`;

          // 表示候補（最大5件）：未退勤 + 未打刻 を日付降順でミックス
          const normalized = [
            ...arrIncomplete.map(it => ({ work_date: it.work_date, kind: 'incomplete' })),
            ...myMissingDates.map(d => ({ work_date: d, kind: 'missing' }))
          ].filter(x => x.work_date);
          normalized.sort((a, b) => a.work_date === b.work_date ? 0 : (a.work_date < b.work_date ? 1 : -1));
          const top5 = normalized.slice(0, 5);
          for (const it of top5) {
            const pill = document.createElement('span');
            pill.className = 'alert-pill' + (it.kind === 'missing' ? ' missing' : '');
            pill.textContent = it.work_date || '不明な日付';
            pill.title = '詳細を見る';
            pill.addEventListener('click', () => openSingleAlertModal(it));
            strip.appendChild(pill);
          }

          // バッジもクリックで日付選択モーダルへ（両者を渡す）
          badge.style.cursor = 'pointer';
          badge.onclick = () => openAlertDatePicker(normalized);
        } else {
          badge.style.display = 'none';
          badge.textContent = '';
          badge.onclick = null;
        }
      } catch (e) { /* ignore */ }
    }

    // 単一警告モーダル（ピルから）
    function openSingleAlertModal(alertItem) {
      const old = document.getElementById('alertModal'); if (old) old.remove();
      const wrap = document.createElement('div');
      wrap.id = 'alertModal';
      wrap.style = 'position:fixed;inset:0;background:rgba(0,0,0,.30);display:flex;align-items:center;justify-content:center;z-index:13000;';
      const workDate = alertItem.work_date || '該当日不明';
      const kind = alertItem.kind || 'incomplete';
      const msg = kind === 'missing'
        ? `${workDate} の<b style='font-size: 1.1rem;color:#e65100;'>勤務記録</b>がありません（未打刻）。`
        : `${workDate} の勤務記録に<b style='font-size: 1.1rem;color:#e65100;'>退勤の打刻</b>がありません。`;
      const typeText = kind === 'missing' ? '未打刻警告' : '未退勤警告';
      const __backUrl = 'back=timecard/myday_dashboard.html&backMode=auto';
      wrap.innerHTML = `<div style='background:#fff;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,.25);min-width:260px;max-width:92vw;padding:14px 18px;'>
                <div style='font-weight:600;color:#e65100;font-size:1.05rem;display:flex;align-items:center;gap:6px;'>
                    <span style="width:16px;height:16px;background:#fb8c00;border-radius:50%;display:inline-block;box-shadow:0 0 0 4px rgba(251,140,0,.15);"></span>
                    ${typeText}
                </div>
                <div style='margin-top:10px;font-size:.95rem;color:#333;line-height:1.5;'>${msg}</div>
                <div style='display:flex;gap:10px;margin-top:18px;justify-content:flex-end;'>
                    <button id='alertFix' style='flex:1;padding:10px 0;background:#1976d2;color:#fff;border:none;border-radius:8px;font-size:.95rem;font-weight:600;'>修正</button>
                    <button id='alertClose' style='flex:1;padding:10px 0;background:#90a4ae;color:#fff;border:none;border-radius:8px;font-size:.95rem;'>閉じる</button>
                </div>
            </div>`;
      document.body.appendChild(wrap);
      wrap.querySelector('#alertClose').onclick = () => wrap.remove();
      wrap.querySelector('#alertFix').onclick = () => {
        wrap.remove();
        // 修正画面遷移（勤務記録一覧へ日付クエリ付き）
        window.location.href = `attendance_list.html?date=${encodeURIComponent(workDate)}&${__backUrl}`;
      };
    }

    // 日付選択モーダル（バッジから）
    function openAlertDatePicker(alertItems) {
      const old = document.getElementById('alertDateModal'); if (old) old.remove();
      const menuOverlay = document.getElementById('menuOverlay');
      const listHtml = (alertItems || []).map(it => {
        const d = it.work_date || '不明';
        const kind = it.kind || 'incomplete';
        const label = kind === 'missing' ? '未打刻' : '未退勤';
        const rowClass = kind === 'missing' ? 'alertDateModal-RowItem warningRowItem' : 'alertDateModal-RowItem criticalRowItem';
        return `<button class='alert-date-row ${rowClass}' data-date='${d}' data-kind='${kind}' >
                    <span>${d}</span><span style='font-size:1rem;opacity:.7;'>${label}</span>
                </button>`;
      }).join('');
      const modal = document.createElement('div');
      modal.id = 'alertDateModal';
      modal.style = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:11000;background:#fff;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,.25);min-width:260px;max-width:92vw;padding:14px 16px;';
      modal.innerHTML = `
            <div style='display:flex;justify-content:space-between;font-weight:600;color:#e65100;font-size:1.05rem;margin-bottom:6px;'>
              <span>警告一覧</span><span class=muted> タップで詳細</span>
            </div>
            <div style='display:grid;gap:8px;max-height:50vh;overflow:auto;margin-top:4px;'>${listHtml || '<div style="font-size:.9rem;color:#666;">警告はありません</div>'}</div>
            <div style='display:flex;justify-content:flex-end;margin-top:14px;'>
              <button id='alertDateClose' style='padding:10px 18px;background:#90a4ae;color:#fff;border:none;border-radius:8px;font-size:.9rem;'>閉じる</button>
            </div>`;
      document.body.appendChild(modal);
      menuOverlay.style.display = 'block';
      modal.querySelector('#alertDateClose').onclick = () => {
        closeMenu();
      };
      modal.querySelectorAll('.alert-date-row').forEach(btn => {
        btn.onclick = () => {
          const date = btn.getAttribute('data-date');
          const kind = btn.getAttribute('data-kind') || 'incomplete';
          closeMenu();
          openSingleAlertModal({ work_date: date, kind });
        };
      });
    }

    // 通知（未読バッジ）
    async function refreshNotifCount() {
      try {
        const res = await fetchWithAuth('api/notifications_get.php?only_unread=1');
        if (!res) return; const data = await res.json();
        const unread = Number((data && data.unread) || 0);
        const badge = document.getElementById('menuNotifBadge');
        const textContent = unread > 0 ? unread > 99 ? '99+' : String(unread) : '';
        if (badge) {
          if (unread > 0) { badge.style.display = 'inline-block'; }
          else { badge.style.display = 'none'; }
          badge.textContent = textContent;
        }
        const badgeInMenu = document.getElementById('notifBadgeInMenu');
        if (badgeInMenu) {
          if (unread > 0) { badgeInMenu.style.display = 'inline-block'; }
          else { badgeInMenu.style.display = 'none'; }
          badgeInMenu.textContent = textContent;
        }
        const notifCount = document.getElementById('notifCount');
        if (notifCount) {
          notifCount.textContent = '未読 ' + (textContent === '' ? '0' : textContent);
        }
      } catch (e) { /* noop */ }
    }

    // 最新3件通知プレビュー（未読優先）
    async function refreshNotifPreview() {
      const card = document.getElementById('notifPreviewCard');
      const listEl = document.getElementById('notifPreviewList');
      if (!card || !listEl) return;
      listEl.innerHTML = '<li style="font-size:.85rem;color:#666;">読込中...</li>';
      try {
        const res = await fetchWithAuth('api/notifications_get.php');
        if (!res) { listEl.innerHTML = '<li style="font-size:.85rem;color:#666;">取得失敗</li>'; return; }
        const data = await res.json();
        const items = Array.isArray(data.items) ? data.items : [];
        // 未読を前にしつつ時刻順はAPIの並びを利用
        const unread = items.filter(i => i.status === 'unread');
        const read = items.filter(i => i.status !== 'unread');
        const merged = [...unread, ...read].slice(0, 3);
        if (!merged.length) {
          card.style.display = 'none';
          return;
        }
        card.style.display = 'block';
        listEl.innerHTML = '';
        for (const it of merged) {
          const li = document.createElement('li');
          li.style = 'background:#f7f9fc;border:1px solid #e0e6eb;padding:8px 10px;border-radius:8px;display:flex;flex-direction:column;gap:4px;cursor:pointer;';
          const title = escapeHtml(it.title || '無題');
          const createdAt = new Date(it.created_at || '');
          const timeOptions = { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' };
          const timeStr = createdAt.toLocaleString('ja-JP', timeOptions);
          const titleHTML = `<div style='font-weight:600;font-size:.9rem;color:${it.status === 'unread' ? '#1976d2' : '#37474f'};flex: 1; min-width: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;'>${title}${it.status === 'unread' ? '<span style="margin-left:6px;font-size:.65rem;background:#e53935;color:#fff;padding:2px 6px;border-radius:10px;">NEW</span>' : ''}</div>`;
          const timeHTML = `<div style='font-size:.65rem;color:#78909c;'>${timeStr}</div>`;
          li.innerHTML = `
                    <div style='display:flex;flex-direction:row;justify-content:space-between;align-items:flex-end;gap:4px;'>
                        ${titleHTML}
                        ${timeHTML}
                    </div>`;
          li.addEventListener('click', () => openNotifModal());
          listEl.appendChild(li);
        }
      } catch (e) {
        listEl.innerHTML = '<li style="font-size:.85rem;color:#666;">取得失敗</li>';
      }
      const openAllBtn = document.getElementById('openAllNotif');
      if (openAllBtn) openAllBtn.onclick = () => openNotifModal();
    }

    // 主要導線
    function openPunch() { window.location.href = 'punch.html'; }
    // 即時打刻用：各アクションボタンは確認ダイアログ経由でAPI呼び出し
    const btnClockIn = document.getElementById('actClockIn');
    const btnBreakStart = document.getElementById('actBreakStart');
    const btnBreakEnd = document.getElementById('actBreakEnd');
    const btnClockOut = document.getElementById('actClockOut');
    const btnOpenPunch = document.getElementById('actOpenPunch');
    btnOpenPunch.addEventListener('click', openPunch);

    // トースト表示領域生成
    const toastHost = document.createElement('div');
    toastHost.style = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:11000;display:flex;flex-direction:column;gap:12px;max-width:420px;width:90vw;align-items:center;pointer-events:none;';
    toastHost.setAttribute('aria-live', 'polite');
    document.body.appendChild(toastHost);
    function showToast(msg, type = 'info', timeout = 2600) {
      const div = document.createElement('div');
      div.textContent = msg;
      div.setAttribute('role', 'alert');
      div.style = 'background:' + (type === 'error' ? '#e53935' : '#1976d2') + ';color:#fff;padding:14px 20px;border-radius:10px;font-size:1.05rem;font-weight:600;letter-spacing:.5px;box-shadow:0 4px 18px rgba(0,0,0,.25);opacity:0;transform:translateY(-6px);transition:opacity .30s,transform .30s;pointer-events:auto;';
      toastHost.appendChild(div);
      requestAnimationFrame(() => { div.style.opacity = '1'; div.style.transform = 'translateY(0)'; });
      setTimeout(() => { div.style.opacity = '0'; div.style.transform = 'translateY(-6px)'; setTimeout(() => div.remove(), 320); }, timeout);
    }

    let punchInFlight = false;
    async function callPunch(endpoint, extraBody = {}) {
      if (punchInFlight) return;
      punchInFlight = true;
      // サーバー時刻で打刻（use_server_time=true）。datetimeは送らない
      const body = { userId, use_server_time: true, manual: 0, ...extraBody };
      try {
        const res = await fetchWithAuth(`api/${endpoint}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
        if (!res) { throw new Error('認証エラー'); }
        const data = await res.json().catch(() => ({}));
        if (!res.ok) { throw new Error(data.message || '打刻に失敗しました'); }
        showToast(data.message || '完了', 'info');
        await runRefreshTick();
        // 退勤成功時はメモをクリア
        if (endpoint === 'clock_out.php') {
          clearTodayMemo();
        }
      } catch (e) {
        showToast(e.message || 'エラーが発生しました', 'error', 3500);
      } finally {
        punchInFlight = false;
      }
    }

    // 退勤時距離入力モーダル
    function showVehicleDistanceModal(onSubmit) {
      const old = document.getElementById('vehDistModal'); if (old) old.remove();
      const wrap = document.createElement('div');
      wrap.id = 'vehDistModal';
      wrap.style = 'position:fixed;inset:0;background:rgba(0,0,0,.35);display:flex;align-items:flex-end;justify-content:center;z-index:12000;';
      wrap.innerHTML = `<div style='background:#fff;width:100%;max-width:480px;padding:16px 18px 20px;border-radius:18px 18px 0 0;box-shadow:0 -2px 16px rgba(0,0,0,.2);'>
                <div style='font-weight:600;color:#1976d2;font-size:1.1rem;margin-bottom:12px;'>退勤 - 距離入力</div>
                <label style='display:flex;align-items:center;gap:8px;font-size:1rem;'>距離(km)
                    <input id='vehDistanceInput' type='number' inputmode='numeric' min='0' step='1' value='0' style='flex:1;font-size:1.2rem;padding:6px 10px;border:1px solid #1976d2;border-radius:6px;text-align:right;' />
                </label>
                <div id='vehErr' style='color:#e53935;font-size:.85rem;min-height:18px;margin-top:4px;'></div>
                <div style='display:flex;gap:10px;margin-top:14px;'>
                   <button id='vehCancel' style='flex:1;padding:12px 0;background:#90a4ae;color:#fff;border:none;border-radius:6px;font-size:1rem;'>キャンセル</button>
                   <button id='vehOk' style='flex:2;padding:12px 0;background:#1976d2;color:#fff;border:none;border-radius:6px;font-size:1rem;font-weight:600;'>記録する</button>
                </div>
            </div>`;
      document.body.appendChild(wrap);
      const inp = wrap.querySelector('#vehDistanceInput'); inp.focus(); inp.select();
      wrap.querySelector('#vehCancel').onclick = () => wrap.remove();
      wrap.querySelector('#vehOk').onclick = () => {
        const v = inp.value; if (v === '' || isNaN(v) || Number(v) < 0) {
          wrap.querySelector('#vehErr').textContent = '0以上の数値を入力してください'; return;
        }
        wrap.remove(); onSubmit(Number(v));
      };
    }

    // 軽量確認ポップ（指位置付近）
    function showConfirm(buttonEl, label, onYes) {
      const rect = buttonEl.getBoundingClientRect();
      const confirmId = 'mydayConfirm';
      const prev = document.getElementById(confirmId); if (prev) prev.remove();
      const el = document.createElement('div');
      el.id = confirmId;
      el.style = `position:fixed;top:${Math.min(rect.top - 8, window.innerHeight - 140)}px;left:${Math.max(rect.left + rect.width / 2 - 140, 8)}px;width:280px;background:#fff;border:1px solid #1976d2;border-radius:10px;padding:12px 14px;z-index:11500;box-shadow:0 4px 18px rgba(0,0,0,.18);font-size:.95rem;`;
      el.innerHTML = `<div style='font-weight:600;color:#1976d2;margin-bottom:6px;'>${label}</div>
                <div style='display:flex;gap:8px;margin-top:6px;'>
                   <button id='cfNo' style='flex:1;padding:8px 0;background:#90a4ae;color:#fff;border:none;border-radius:6px;'>キャンセル</button>
                   <button id='cfYes' style='flex:1;padding:8px 0;background:#1976d2;color:#fff;border:none;border-radius:6px;font-weight:600;'>実行</button>
                </div>`;
      document.body.appendChild(el);
      el.querySelector('#cfNo').onclick = () => el.remove();
      el.querySelector('#cfYes').onclick = () => { el.remove(); onYes(); };
    }

    // アクションハンドラ
    btnClockIn.addEventListener('click', () => {
      showConfirm(btnClockIn, '出勤打刻しますか？', () => callPunch('clock_in.php'));
    });
    btnBreakStart.addEventListener('click', () => {
      showConfirm(btnBreakStart, '休憩開始を記録しますか？', () => callPunch('break_start.php'));
    });
    btnBreakEnd.addEventListener('click', () => {
      showConfirm(btnBreakEnd, '休憩終了を記録しますか？', () => callPunch('break_end.php'));
    });
    btnClockOut.addEventListener('click', () => {
      showConfirm(btnClockOut, '退勤打刻しますか？', () => {
        // 当日メモ（退勤時サーバー保存）
        const memoToSend = (memoTextarea && memoTextarea.value) ? memoTextarea.value : '';
        const extra = { memo_text: memoToSend };
        if (useVehicle === 1) {
          // 距離入力 → API
          showVehicleDistanceModal(distance => callPunch('clock_out.php', { vehicle_distance: distance, ...extra }));
        } else {
          callPunch('clock_out.php', extra);
        }
      });
    });
    document.getElementById('openList').addEventListener('click', () => { window.location.href = 'attendance_list.html'; });

    // 有給申請（punch.html の簡易モーダルへ移譲せず、ここでは画面遷移）
    // 有給申請: punch.html の簡易モーダル実装を移植（画面遷移せず当日ベース）
    function showPaidLeaveModal() {
      const old = document.getElementById('paidLeaveModal'); if (old) old.remove();
      const now = new Date();
      const pad = n => n.toString().padStart(2, '0');
      const todayStr = `${now.getFullYear()}-${pad(now.getMonth() + 1)}-${pad(now.getDate())}`;
      // 勤務時間設定を取得し 8h をフォールバック
      const defaultHours = 8; // 必要なら settings_get 結果を保持して差し替え
      const modal = document.createElement('div');
      modal.id = 'paidLeaveModal';
      modal.style = 'position:fixed;inset:0;background:rgba(0,0,0,.30);display:flex;align-items:center;justify-content:center;z-index:14000;';
      modal.innerHTML = `
                        <div style='background:#fff;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,.25);min-width:280px;max-width:92vw;padding:14px 18px;'>
                            <div style='font-weight:600;color:#1976d2;font-size:1.15rem;margin-bottom:10px;display:flex;align-items:center;gap:6px;'>有給申請</div>
                            <div style='display:grid;row-gap:10px;'>
                                <label style='display:grid;gap:6px;font-size:.95rem;'>日付 <input id='plDate' type='date' value='${todayStr}' style='font-size:1.15rem;padding:6px 8px;'></label>
                                <label style='display:grid;gap:6px;font-size:.95rem;'>時間（h） <div><input id='plHours' type='number' min='0.25' step='0.25' value='${defaultHours}' style='font-size:1.15rem;width:6.5em;text-align:right;padding:4px 6px;'> h</div></label>
                                <label style='display:grid;gap:6px;font-size:.95rem;'>理由（任意）<textarea id='plReason' rows='3' style='font-size:.95rem;padding:8px 10px;border:1px solid #b0bec5;border-radius:8px;'></textarea></label>
                                <div id='plMsg' style='min-height:1.2em;color:#e53935;font-size:.85rem;'></div>
                            </div>
                            <div style='margin-top:14px;display:flex;gap:10px;justify-content:flex-end;'>
                                <button id='plCancelBtn' style='flex:1;padding:10px 0;background:#90a4ae;color:#fff;border:none;border-radius:8px;font-size:.95rem;'>キャンセル</button>
                                <button id='plSubmitBtn' style='flex:1;padding:10px 0;background:#1976d2;color:#fff;border:none;border-radius:8px;font-size:.95rem;font-weight:600;'>申請する</button>
                            </div>
                        </div>`;
      document.body.appendChild(modal);
      const plDate = document.getElementById('plDate');
      const plHours = document.getElementById('plHours');
      const plReason = document.getElementById('plReason');
      const plMsg = document.getElementById('plMsg');
      const plSubmitBtn = document.getElementById('plSubmitBtn');
      const plCancelBtn = document.getElementById('plCancelBtn');
      plCancelBtn.onclick = () => modal.remove();
      plSubmitBtn.onclick = async () => {
        plMsg.style.color = '#e53935'; plMsg.textContent = '';
        const used_date = plDate.value; const hours = Number(plHours.value); const reason = plReason.value.trim();
        if (!used_date) { plMsg.textContent = '日付を入力してください'; return; }
        if (!(hours > 0)) { plMsg.textContent = '時間は0より大きい数で入力してください'; return; }
        plSubmitBtn.disabled = true; plCancelBtn.disabled = true; plMsg.style.color = '#1976d2'; plMsg.textContent = '送信中…';
        try {
          const res = await fetchWithAuth('api/leave_requests_create.php', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ used_date, hours, reason }) });
          if (!res) throw new Error('認証エラー');
          const data = await res.json().catch(() => ({}));
          if (!res.ok || data.error) throw new Error(data.error || '申請に失敗しました');
          plMsg.style.color = '#2e7d32'; plMsg.textContent = data.notified ? '申請を送信しました（承認者へ通知しました）。' : '申請を送信しました。';
          setTimeout(() => modal.remove(), 1200);
        } catch (err) { plMsg.style.color = '#e53935'; plMsg.textContent = err.message || 'エラーが発生しました'; plSubmitBtn.disabled = false; plCancelBtn.disabled = false; }
      };
    }
    document.getElementById('openPaidLeave').addEventListener('click', showPaidLeaveModal);

    // === 今日のメモ（ローカルストレージに自動保存） ===
    const memoState = { key: null, dirty: false, lastSaved: 0 };
    const memoTextarea = document.getElementById('dayMemo');
    const memoCountEl = document.getElementById('memoCount');
    const memoStatusEl = document.getElementById('memoStatus');
    function buildMemoKey() {
      if (!userId) return null;
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const da = String(d.getDate()).padStart(2, '0');
      return `mydayMemo:${userId}:${y}-${m}-${da}`;
    }
    function initMemo(force = false) {
      const key = buildMemoKey();
      if (!key) return;
      if (!force && memoState.key === key) return; // 既に今日のキー
      memoState.key = key;
      // Load
      const stored = localStorage.getItem(key);
      if (stored !== null) memoTextarea.value = stored; else memoTextarea.value = '';
      memoState.dirty = false;
      updateMemoMeta();
    }
    function updateMemoMeta(savedOk) {
      const len = memoTextarea.value.length;
      memoCountEl.textContent = `${len} / ${memoTextarea.maxLength}`;
      if (savedOk === true) {
        memoStatusEl.textContent = '保存済み';
        memoStatusEl.className = 'memo-status ok';
      } else if (savedOk === false) {
        memoStatusEl.textContent = '保存失敗';
        memoStatusEl.className = 'memo-status err';
      } else if (memoState.dirty) {
        memoStatusEl.textContent = '編集中…';
        memoStatusEl.className = 'memo-status';
      } else {
        memoStatusEl.textContent = '';
        memoStatusEl.className = 'memo-status';
      }
    }
    let memoSaveTimer = null;
    function scheduleMemoSave() {
      memoState.dirty = true;
      updateMemoMeta();
      if (memoSaveTimer) clearTimeout(memoSaveTimer);
      memoSaveTimer = setTimeout(persistMemo, 600); // 0.6s デバウンス
    }
    function persistMemo() {
      if (!memoState.key) return;
      try {
        localStorage.setItem(memoState.key, memoTextarea.value);
        memoState.lastSaved = Date.now();
        memoState.dirty = false;
        updateMemoMeta(true);
      } catch (e) {
        updateMemoMeta(false);
      }
    }
    if (memoTextarea) memoTextarea.addEventListener('input', scheduleMemoSave);
    function clearTodayMemo() {
      if (!memoState.key) return;
      try { localStorage.removeItem(memoState.key); } catch (_) { /* ignore */ }
      memoTextarea.value = '';
      memoState.dirty = false;
      updateMemoMeta(true);
    }

    // === 各種カードの開閉と内容更新 ===
    // 警告カード開閉
    const alertCard = document.getElementById('alertCard');
    const alertBody = document.getElementById('alertBody');
    const alertToggle = document.getElementById('alertToggle');
    const alertHeader = document.getElementById('alertCardHeader');
    alertHeader.addEventListener('click', () => toggleAlert());
    alertToggle.addEventListener('click', (e) => { e.stopPropagation(); toggleAlert(); });

    function toggleAlert() {
      const expanded = alertCard.getAttribute('aria-expanded') === 'true';
      if (expanded) {
        alertCard.setAttribute('aria-expanded', 'false');
        alertToggle.setAttribute('aria-expanded', 'false');
        alertToggle.textContent = '＞';
        alertBody.style.display = 'none';
      } else {
        alertCard.setAttribute('aria-expanded', 'true');
        alertToggle.setAttribute('aria-expanded', 'true');
        alertToggle.textContent = '∨';
        alertBody.style.display = 'block';
        refreshAlerts();
      }
    }

    // タイムライン開閉
    const statusCard = document.getElementById('statusCard');
    const timelineBody = document.getElementById('timelineBody');
    const timelineToggle = document.getElementById('timelineToggle');
    const statusCardHeader = document.getElementById('statusCardHeader');
    statusCardHeader.addEventListener('click', () => toggleTimeline());
    timelineToggle.addEventListener('click', (e) => { e.stopPropagation(); toggleTimeline(); });

    function toggleTimeline() {
      const expanded = statusCard.getAttribute('aria-expanded') === 'true';
      if (expanded) {
        statusCard.setAttribute('aria-expanded', 'false');
        timelineToggle.setAttribute('aria-expanded', 'false');
        timelineToggle.textContent = '＞';
        timelineBody.style.display = 'none';
      } else {
        statusCard.setAttribute('aria-expanded', 'true');
        timelineToggle.setAttribute('aria-expanded', 'true');
        timelineToggle.textContent = '∨';
        timelineBody.style.display = 'block';
        refreshTimeline();
      }
    }

    // フレックス開閉
    const flexCardExpand = document.getElementById('flexCard');
    const flexBody = document.getElementById('flexBody');
    const flexToggle = document.getElementById('flexToggle');
    const flexHeader = document.getElementById('flexHeader');
    flexHeader.addEventListener('click', () => toggleFlex());
    flexToggle.addEventListener('click', (e) => { e.stopPropagation(); toggleFlex(); });

    function toggleFlex() {
      const expanded = flexCardExpand.getAttribute('aria-expanded') === 'true';
      if (expanded) {
        flexCardExpand.setAttribute('aria-expanded', 'false');
        flexToggle.setAttribute('aria-expanded', 'false');
        flexToggle.textContent = '＞';
        flexBody.style.display = 'none';
      } else {
        flexCardExpand.setAttribute('aria-expanded', 'true');
        flexToggle.setAttribute('aria-expanded', 'true');
        flexToggle.textContent = '∨';
        flexBody.style.display = 'block';
        refreshFlexSummary();
      }
    }

    // 通知プレビュー開閉
    const notifCard = document.getElementById('notifPreviewCard');
    const notifHeader = document.getElementById('notifCardHeader');
    const notifToggle = document.getElementById('notifToggle');
    const notifList = document.getElementById('notifPreviewList');
    notifHeader.addEventListener('click', () => toggleNotifPreview());
    notifToggle.addEventListener('click', (e) => { e.stopPropagation(); toggleNotifPreview(); });

    function toggleNotifPreview() {
      const expanded = notifCard.getAttribute('aria-expanded') === 'true';
      if (expanded) {
        notifCard.setAttribute('aria-expanded', 'false');
        notifToggle.setAttribute('aria-expanded', 'false');
        notifToggle.textContent = '＞';
        notifList.style.display = 'none';
      } else {
        notifCard.setAttribute('aria-expanded', 'true');
        notifToggle.setAttribute('aria-expanded', 'true');
        notifToggle.textContent = '∨';
        notifList.style.display = 'grid';
        refreshNotifPreview();
      }
    }

    function formatHM(ts) {
      if (!ts) return '';
      const d = new Date(ts.replace(/ /, 'T')); // Safari 対応
      if (isNaN(d)) return ts;
      const hh = String(d.getHours()).padStart(2, '0');
      const mm = String(d.getMinutes()).padStart(2, '0');
      return `${hh}:${mm}`;
    }
    async function refreshTimeline() {
      if (statusCard.getAttribute('aria-expanded') !== 'true') return; // 閉じているときは取得しない
      timelineBody.innerHTML = '<div style="font-size:.85rem;color:#666;">読込中...</div>';
      try {
        const res = await fetchWithAuth('api/today_events.php');
        const data = res && await res.json();
        let items = (data && data.items) || [];
        // 新しいものが上に来るように降順ソート
        items = items.slice().sort((a, b) => {
          const ta = (a && a.time) || '';
          const tb = (b && b.time) || '';
          if (ta === tb) return 0;
          return ta < tb ? 1 : -1;
        });
        if (!items.length) { timelineBody.innerHTML = '<div class="timeline-empty">まだイベントはありません</div>'; return; }
        const ul = document.createElement('ul'); ul.className = 'timeline-list';
        for (const ev of items) {
          const li = document.createElement('li'); li.className = 'timeline-item';
          const timeStr = formatHM(ev.time);
          li.innerHTML = `<span class='ts'>${timeStr}</span><span class='label'>${ev.label || ev.type}</span>`;
          ul.appendChild(li);
        }
        timelineBody.innerHTML = '';
        timelineBody.appendChild(ul);
      } catch (e) {
        timelineBody.innerHTML = '<div class="timeline-empty">取得に失敗しました</div>';
      }
    }

    // ハンバーガーメニュー（punch.htmlの実装を踏襲）
    const menuToggle = document.getElementById('menuToggle');
    const sideMenu = document.getElementById('sideMenu');
    const menuOverlay = document.getElementById('menuOverlay');
    const menuOpenNotif = document.getElementById('menuOpenNotif');
    let previousFocusedElement = null;
    function getFocusableElements(container) {
      const selectors = ['a[href]', 'button:not([disabled])', 'input:not([disabled])', 'select:not([disabled])', 'textarea:not([disabled])', '[tabindex]:not([tabindex="-1"])'].join(',');
      return Array.from(container.querySelectorAll(selectors)).filter(el => el.offsetParent !== null || el === document.activeElement);
    }
    function focusFirstInMenu() {
      const focusables = getFocusableElements(sideMenu);
      if (focusables.length > 0) {
        focusables[0].focus();
      } else {
        sideMenu.focus();
      }
    }
    function trapFocusKeydown(e) {
      if (!sideMenu.classList.contains('open')) return;
      if (e.key !== 'Tab') return;
      const focusables = getFocusableElements(sideMenu);
      if (focusables.length === 0) {
        e.preventDefault();
        sideMenu.focus();
        return;
      }
      const first = focusables[0];
      const last = focusables[focusables.length - 1];
      const active = document.activeElement;
      if (e.shiftKey) {
        if (active === first || !sideMenu.contains(active)) {
          e.preventDefault();
          last.focus();
        }
      } else {
        if (active === last || !sideMenu.contains(active)) {
          e.preventDefault();
          first.focus();
        }
      }
    }
    function openMenu() {
      sideMenu.classList.add('open');
      menuOverlay.style.display = 'block';
      menuToggle.setAttribute('aria-expanded', 'true');
      sideMenu.setAttribute('aria-hidden', 'false');
      previousFocusedElement = document.activeElement;
      sideMenu.setAttribute('role', 'dialog');
      sideMenu.setAttribute('aria-modal', 'true');
      focusFirstInMenu();
      document.addEventListener('keydown', trapFocusKeydown, true);
    }
    function closeMenu() {
      alertDateModal = document.getElementById('alertDateModal');
      if (alertDateModal) { alertDateModal.remove(); }
      sideMenu.classList.remove('open');
      menuOverlay.style.display = 'none';
      menuToggle.setAttribute('aria-expanded', 'false');
      sideMenu.setAttribute('aria-hidden', 'true');
      sideMenu.removeAttribute('aria-modal');
      sideMenu.removeAttribute('role');
      document.removeEventListener('keydown', trapFocusKeydown, true);
      if (previousFocusedElement && document.contains(previousFocusedElement)) {
        previousFocusedElement.focus();
      } else {
        menuToggle.focus();
      }
    }
    menuToggle.addEventListener('click', () => { const expanded = menuToggle.getAttribute('aria-expanded') === 'true'; expanded ? closeMenu() : openMenu(); });
    menuOverlay.addEventListener('click', closeMenu);
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeMenu(); });

    // 簡易通知モーダル
    async function openNotifModal() {
      const old = document.getElementById('notifModal'); if (old) old.remove();
      const wrap = document.createElement('div');
      wrap.id = 'notifModal';
      wrap.style = 'position:fixed;inset:0;background:rgba(0,0,0,.25);display:flex;align-items:center;justify-content:center;z-index:10000;';
      wrap.innerHTML = `
        <div style='background:#fff;border-radius:8px;box-shadow:0 2px 16px #0002;min-width:280px;max-width:90vw;max-height:80vh;overflow:auto;'>
          <div style='padding:0.8em 1em;border-bottom:1px solid #eee;color:#1976d2;font-weight:bold;'>お知らせ</div>
          <div id='notifList' style='padding:0.6em 1em;min-width:260px;'></div>
          <div style='padding:0.6em 1em;display:flex;gap:0.6em;justify-content:flex-end;'>
            <button id='markRead' class='action-btn' style='height:36px;font-size:.95rem;padding:0 12px;'>すべて既読</button>
            <button id='closeNotif' class='action-btn muted' style='height:36px;font-size:.95rem;padding:0 12px;'>閉じる</button>
          </div>
        </div>`;
      document.body.appendChild(wrap);
      document.getElementById('closeNotif').onclick = () => wrap.remove();
      document.getElementById('markRead').onclick = async () => { await fetchWithAuth('api/notifications_read.php', { method: 'POST' }); await refreshNotifCount(); wrap.remove(); };
      try {
        const res = await fetchWithAuth('api/notifications_get.php');
        const data = res && await res.json();
        const list = document.getElementById('notifList');
        list.innerHTML = '';
        (data.items || []).forEach(it => {
          const div = document.createElement('div');
          div.style = 'border-bottom:1px solid #eee;padding:0.5em 0;';
          const title = `<div style="font-weight:600;color:#333;">${escapeHtml(it.title || '')}</div>`;
          const body = it.body ? `<div style="color:#555;margin-top:2px;">${escapeHtml(it.body).replace(/\n/g, '<br>')}</div>` : '';
          const link = it.link ? `<div style="margin-top:4px;"><a href="${it.link}" target="_blank">開く</a></div>` : '';
          div.innerHTML = title + body + link + `<div style="color:#999;font-size:0.85em;margin-top:2px;">${it.created_at || ''}</div>`;
          list.appendChild(div);
        });
        if (!list.innerHTML) { list.textContent = '通知はありません'; }
      } catch (e) { /* ignore */ }
    }
    function escapeHtml(s) { const m = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', '\'': '&#39;' }; return String(s || '').replace(/[&<>"']/g, c => m[c]); }
    if (menuOpenNotif) menuOpenNotif.onclick = () => { closeMenu(); openNotifModal(); };

    // 定期リフレッシュ（可視時のみ実行・再開時に即時反映）
    let __mydayRefreshTimer = null;
    async function runRefreshTick() {
      if (document.hidden) return;
      try {
        // 日付跨ぎでキーが変わったら再初期化
        const currentKey = buildMemoKey();
        if (currentKey !== memoState.key) initMemo(true);
        await Promise.allSettled([
          refreshStatus(),
          refreshNotifCount(),
          refreshAlerts(),
          refreshTimeline(),
          refreshNotifPreview(),
          refreshFlexSummary()
        ]);
      } catch (_) { /* noop */ }
    }
    function startAutoRefresh() {
      if (__mydayRefreshTimer) clearInterval(__mydayRefreshTimer);
      __mydayRefreshTimer = setInterval(runRefreshTick, 60000); // 60秒ごと
    }
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden) {
        // 画面が再び可視になったら即時更新
        runRefreshTick();
      }
    });

    // 起動
    startAutoRefresh();

    // ログアウト
    const menuLogout = document.getElementById('menuLogout');
    if (menuLogout) menuLogout.onclick = async function () {
      await fetchWithAuth('api/logout.php', { method: 'POST' });
      window.location.href = 'login.html';
    };

  </script> // 承認完了後の再取得ハンドリング（ダッシュボード側） function handleApprovalRefreshDashboard() { try { const params = new URLSearchParams(location.search); const decided = params.get('leave_decided'); if (decided === '1') { try { console.log('有給申請の承認が反映されました（ダッシュボード）'); } catch (e) {} if (typeof refreshFlexSummary === 'function') { refreshFlexSummary(); } } } catch (e) {} } // フォーカス復帰で最新化 window.addEventListener('focus', () => { try { if (typeof refreshFlexSummary === 'function') refreshFlexSummary(); } catch (e) {} }); document.addEventListener('DOMContentLoaded', handleApprovalRefreshDashboard);
</body>

</html>