<!DOCTYPE html>
<html lang="ja">

<head style="height: 0px;">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>勤務記録一覧</title>
  <link rel="stylesheet" href="css/common.css">
  <style>
    html {
      height: 100dvh;
      margin-top: 0px;
    }

    body {
      height: 100dvh;
      width: 100dvw;
      position: fixed;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f5f6fa;
      margin: 0;
    }

    .fixed-header {
      position: sticky;
      top: 0px;
      z-index: 100;
      background: #fff;
      padding: 0;
      display: block;
      justify-content: space-between;
      align-items: center;
    }

    @media (max-width: 600px) {
      .fixed-header {
        border-radius: 0;
        height: auto;
        padding: 0;
        justify-content: space-between;
      }
    }

    .header-title {
      font-size: 1.3em;
      width: -webkit-fill-available;
      color: #1976d2;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5em;
      padding: 10px 1em 0 1em;
    }

    @media (max-width: 600px) {
      .header-title {
        padding: 8px 0.5em 0 0.5em;
      }
    }

    .header-btns {
      display: grid;
      grid-auto-columns: 1fr;
      grid-auto-flow: column;
      position: sticky;
      bottom: 0;
      background: #fff;
      padding: 10px 0 10px 0;
      justify-content: center;
      z-index: 200;
      align-items: center;
      max-width: 480px;
      margin: 0 auto;
      height: 70px;
      gap: 0.7em;
    }

    #listLabelItem {
      position: sticky;
      top: 2.1rem;
      flex-direction: row;
      align-items: center;
      padding: 0em 0.2em 0.2em 0em;
      margin: -1px 0 4px 0;
      background: #ffffff;
    }

    #listLabelBox {
      display: flex;
      flex-direction: row;
      align-items: center;
      width: 100%;
      padding: 0em 0em 0em 0em;
    }

    .fixed-footer {
      position: sticky;
      bottom: 0;
      left: 0;
      /*width: 100%;*/
      z-index: 100;
      background: #fff;
      padding: 0 0 0 0;
      justify-content: space-between;
      align-items: center;
    }

    .footer-btns {
      display: grid;
      grid-auto-columns: 1fr;
      grid-auto-flow: column;
      gap: 0.7em;
      position: sticky;
      bottom: 0;
      background: #fff;
      padding: 0px 0 0px 0;
      justify-content: center;
      z-index: 200;
      align-items: center;
      max-width: 480px;
      margin: 10px auto;
    }

    .footer-btn {
      font-size: 1.3em;
      padding: 0.5em 1.2em;
      border-radius: 4px;
      background: #1976d2;
      color: #fff;
      border: none;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(25, 118, 210, 0.08);
    }

    @media (max-width: 600px) {
      .footer-btn {
        padding: 0.4em 0.5em;
      }
    }

    .footer-btn:active {
      background: #1565c0;
    }

    #statsBox {
      display: grid;
      grid-template-columns: 1fr;
      grid-template-rows: 1fr 1fr;
      row-gap: 10px;
      grid-auto-flow: column;
      height: auto;
      padding-top: 0.5em;
      padding-bottom: 0.8em;
      color: #1976d2;
      font-weight: bold;
      text-align: center;
      line-height: 28.8px;
    }

    .statsBoxLabel {
      display: grid;
      grid-auto-columns: 1fr;
      font-size: 30px;
    }

    .statsBoxValue {
      display: grid;
      grid-auto-columns: 1fr;
      font-size: 30px;
      line-height: 28.8px;
    }

    .flex-summary {
      display: flex;
      align-items: center;
      margin: 0.2em 1rem 0.2em 0rem;
      padding: 0em 0em;
      color: #0d47a1;
    }

    .flex-summary-header {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .flex-summary-header-sub {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .flex-summary-title {
      font-weight: bold;
      font-size: 1.3rem;
      color: var(--accent)
    }

    .flex-summary-sub {
      font-size: 0.85rem;
      color: #546e7a;
    }

    .flex-summary-body {
      display: none;
      flex-direction: column;
      gap: 6px;
      margin-top: 4px;
    }

    .flex-summary-line {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      font-size: 0.8rem;
    }

    .flex-summary-detail {
      font-size: 0.8rem;
      margin: 0.2em 1.5rem 0.2em 1.5rem;
      color: #455a64;
      line-height: 1.4;
    }

    @media (max-width: 600px) {
      .statsBoxLabel {
        font-size: 5vw;
        line-height: 4.8vw;
      }

      .statsBoxValue {
        font-size: 5vw;
        line-height: 4.8vw;
      }

      .flex-summary {
        margin: 0.4em 0.6em 0.2em 0.6em;
      }
    }

    input[type="month" i] {
      font-size: 1.5em;
      border: 1px solid #b0bec5;
      border-radius: 4px;
      padding: 2px 0;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
      /*margin-bottom: -16px;*/
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 16px rgba(0, 0, 0, 0.08);
      padding: 0;
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    .toggle-area {
      display: flex;
      column-gap: 0.5em;
      justify-content: flex-end;
      padding: 0 0.5em 0.4em 0.5em;
    }

    #listToggles {
      display: flex;
      gap: 0.5em;
      flex-wrap: wrap;
    }

    .scroll-area {
      overflow-y: scroll;
      padding: 0 1rem 0 1rem;
      background: #fff;
    }

    /* 展開中の行を前面に出す（固定ヘッダラベルより上） */
    .record-row.active {
      position: relative;
      z-index: 100;
    }

    /* 上合わせ用の自然な余白確保（スクロール不足のフォールバックに活用） */
    .record-row.active {
      scroll-margin-top: 48px;
      scroll-margin-bottom: 24px;
    }

    /* 編集モードではアクティブ以外の行を非表示 */
    .editing-mode .record-row:not(.active) {
      display: none;
    }

    .footer-btn {
      font-size: 1.1em;
      padding: 0.8em 2em;
      background: #1976d2;
      color: #fff;
      border: none;
      border-radius: 4px;
      box-shadow: 0 2px 8px rgba(25, 118, 210, 0.08);
      cursor: pointer;
    }

    .footer-btn:active {
      background: #1565c0;
    }

    @media (max-width: 600px) {
      .container {
        max-width: 100vw;
        height: 100%;
        margin: 0 auto;
        border-radius: 0;
        box-shadow: 0 2px 16px rgba(0, 0, 0, 0.08);
        padding: 0;
      }

      .scroll-area {
        padding: 0 0.2rem 0 0.2rem;
      }

      .header-btns {
        padding: 0.8em 0 0.8em 0;
        height: 70px;
      }

      input[type="month" i] {
        font-size: 1em;
        border: 1px solid #b0bec5;
        border-radius: 4px;
        padding: 2px 0;
        width: 30%;
      }
    }

    h2 {
      text-align: center;
      color: #1976d2;
      margin-bottom: 1rem;
    }

    .record-list {
      list-style: none;
      padding: 0 0.5rem;
      margin-top: 0;
    }

    /* 月区切りヘッダー（スクロール追従） */
    .month-divider {
      position: sticky;
      top: 0;
      z-index: 30;
      background: #eceff1;
      color: #37474f;
      font-weight: 600;
      border: 1px solid #cfd8dc;
      border-left: none;
      border-right: none;
      padding: 4px 10px;
      margin: 0 0 0px 0;
      display: flex;
      align-items: center;
      letter-spacing: .5px;
      font-size: 1.1em;
    }

    .month-divider+.month-divider {
      /* 連続挿入抑止（万一フィルタで空月など） */
      margin-top: 0;
    }

    .record-row {
      border-bottom: 1px solid #e0e0e0;
      padding: 0.7rem 0;
      display: block;
      /* blockに変更 */
      background: #fff;
      transition: background 0.2s;
    }

    .record-row.highlight {
      background: #fff8e1 !important;
      position: relative;
    }

    .record-row.highlight::before {
      content: '';
      position: absolute;
      inset: 0;
      border: 2px solid #fb8c00;
      border-radius: 4px;
      pointer-events: none;
    }

    /* background: #e3f2fd; */
    .record-main {
      display: flex;
      flex-direction: row;
      align-items: center;
      flex: 1 1 0%;
      gap: 0;
      width: 100%;
      white-space: nowrap;
    }

    .record-date {
      font-weight: bold;
      min-width: 4.5em;
      max-width: 4.5em;
      width: 4.5em;
      flex-shrink: 0;
      flex-grow: 0;
    }

    .day-status-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.65em;
      font-weight: 600;
      line-height: 1.1em;
      padding: 2px 6px;
      border-radius: 12px;
      background: #eceff1;
      color: #455a64;
      min-width: 3.2em;
      cursor: default;
      position: relative;
    }

    .day-status-badge[data-st="work"] {
      background: #e3f2fd;
      color: #0d47a1;
    }

    .day-status-badge[data-st="off"] {
      background: #ffebee;
      color: #b71c1c;
    }

    .day-status-badge[data-st="am_off"],
    .day-status-badge[data-st="pm_off"] {
      background: #fff8e1;
      color: #e65100;
    }

    .day-status-badge[data-st="ignore"] {
      background: #eeeeee;
      color: #616161;
      text-decoration: line-through;
    }

    .day-status-badge[data-st="paid"] {
      background: #e8f5e9;
      color: #1b5e20;
    }

    .day-status-badge .src-flag {
      font-size: 0.55em;
      font-weight: 400;
      position: absolute;
      bottom: -9px;
      right: 2px;
      color: #607d8b;
    }

    .classification-ui {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
      margin-top: 6px;
    }

    .classification-ui button {
      font-size: 0.65em;
      padding: 4px 6px;
      border: 1px solid #1976d2;
      background: #fff;
      color: #1976d2;
      border-radius: 4px;
      cursor: pointer;
    }

    .classification-ui button.active {
      background: #1976d2;
      color: #fff;
    }

    .classification-ui button:disabled {
      opacity: .35;
      cursor: not-allowed;
    }

    .record-times {
      display: flex;
      flex: 1 1 0%;
      justify-content: space-between;
      gap: 0;
      margin-right: 0em;
    }

    .record-col {
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 3.5em;
      flex: 1 1 0%;
    }

    @media (max-width: 600px) {
      .record-col {
        min-width: 3em;
      }
    }

    .record-col:nth-child(2) {
      /* 終業 */
      margin-right: 0.3em;
    }

    .record-col:nth-child(3) {
      /* 休憩 */
      margin-left: 0.3em;
    }

    .record-col .label {
      font-size: 0.9em;
      color: #666;
    }

    .record-col .value {
      font-size: 1.2em;
      font-weight: bold;
      color: #1976d2;
      text-align: center;
      margin-top: 0.1em;
    }

    .record-summary {
      font-size: 0.9em;
      color: #1976d2;
      margin-left: 1em;
    }

    /* background: #f1f8e9; */
    .expand-panel {
      padding: 1em 0.7em 0em 0.7em;
      z-index: 20;
      position: static;
      width: 100%;
      box-sizing: border-box;
      display: block;
      clear: both;
    }

    .expand-panel .edit-row {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.7em;
    }

    @media (max-width: 600px) {
      .expand-panel .edit-row {
        gap: 0.5em;
        justify-content: space-between;
      }
    }

    .expand-panel .edit-row label {
      align-items: center;
      min-width: 0;
    }

    .expand-panel input[type="date"],
    input[type="month"] {
      width: 8em;
      font-size: 1.5em;
      padding: 0em 0em 0em 0em;
      height: 1.65em;
      border: 0.5px solid;
      border-radius: 0.2em;
      background: #fff;
      box-shadow: 0 0 8px 1px #1976d229;
      color: #1976d2;
      outline: none;
      transition: border 0.2s, box-shadow 0.2s;
      text-align: center;
      position: relative;
    }

    @media (max-width: 600px) {
      .expand-panel input[type="time"] {
        font-size: 1.8em;
        height: 1.34em;
        width: 7em;
      }
    }

    @media (max-width: 600px) {
      input[type="month"] {
        font-size: 1.2em;
        border: 1px solid #b0bec5;
        border-radius: 4px;
        padding: 2px 0;
      }
    }

    .expand-panel input[type="time"] {
      width: 5em;
      font-size: 1.5em;
      padding: 0em 0em 0em 0em;
      height: 1.65em;
      border: 0.5px solid;
      border-radius: 0.2em;
      background: #fff;
      box-shadow: 0 0 8px 1px #1976d229;
      color: #1976d2;
      outline: none;
      transition: border 0.2s, box-shadow 0.2s;
      text-align: center;
      position: relative;
    }

    @media (max-width: 600px) {
      .expand-panel input[type="time"] {
        font-size: 1.8em;
        height: 1.34em;
        width: 3.5em;
      }
    }

    .expand-panel input[type="number"] {
      width: 3.5em;
      height: 1.34em;
      font-size: 1.5em;
      padding: 0em 0em 0em 0em;
      border: 0.5px solid;
      border-radius: 0.2em;
      background: #fff;
      box-shadow: 0 0 8px 1px #1976d229;
      color: #1976d2;
      outline: none;
      transition: border 0.2s, box-shadow 0.2s;
      position: relative;
      text-align: right;
    }

    @media (max-width: 600px) {
      .expand-panel input[type=number] {
        font-size: 1.8em;
        height: 1.34em;
        width: 2.5em;
        padding: 0 0.5em 0 0;
      }
    }

    .expand-panel input[type="time"]:focus {
      border: 1.5px solid rgba(25, 118, 210, 0.08);
      box-shadow: 0 0 0 2px #90caf991;
      background: #fff;
    }

    .break-edit-row {
      display: flex;
      align-items: center;
      gap: 0.5em;
      margin-bottom: 0.3em;
    }

    .break-edit-row button {
      background: #e57373;
      color: #fff;
      border: none;
      border-radius: 3px;
      padding: 0.2em 0.7em;
      font-size: 1.3em;
      cursor: pointer;
    }

    .default-btn,
    .save-btn,
    .cancel-btn {
      font-size: 1.3em;
      padding: 0.7em 1.5em;
      min-width: 5.5em;
      border-radius: 4px;
      margin-top: 0.7em;
      background: #1976d2;
      color: #fff;
      border: none;
      box-shadow: 0 2px 8px rgba(25, 118, 210, 0.08);
    }

    @media (max-width: 600px) {

      .default-btn,
      .save-btn,
      .cancel-btn {
        font-size: 1.1em;
        padding: 1em 0.5em;
        min-width: 7em;
        cursor: pointer;
      }
    }

    .add-break-btn,
    .delete-btn {
      font-size: 1.2em;
      height: 2em;
      padding: 0em;
      min-width: 6.5em;
      border-radius: 4px;
      margin-top: 0.7em;
      background: #1976d2;
      color: #fff;
      border: none;
      box-shadow: 0 2px 8px rgba(25, 118, 210, 0.08);
    }

    @media (max-width: 600px) {

      .add-break-btn,
      .delete-btn {
        font-size: 1.1em;
      }
    }

    .edit-btns {
      display: flex;
      gap: 1em;
      align-items: center;
      justify-content: flex-end;
    }

    .break-delete-btns {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 0.5em;
    }

    .default-btn:disabled,
    .add-break-btn:disabled,
    .save-btn:disabled,
    .cancel-btn:disabled,
    .delete-btn:disabled {
      background: #b0bec5 !important;
      color: #fff !important;
      cursor: not-allowed !important;
      box-shadow: none !important;
      opacity: 0.6;
      border: none;
    }

    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.15);
      z-index: 10;
    }

    /* 管理者専用要素制御 */
    .admin-only {
      display: none;
    }

    body.is-admin .admin-only {
      display: inline-flex;
    }

    /* 押し込み式トグルボタン */
    #listToggles .toggle-btn {
      appearance: none;
      -webkit-appearance: none;
      border: 1px solid #cfd8dc;
      background: linear-gradient(#ffffff, #f7f9fc);
      color: #455a64;
      border-radius: 8px;
      padding: 6px 10px;
      font-size: 0.9em;
      line-height: 1;
      cursor: pointer;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.06), 0 0 0 1px rgba(255, 255, 255, 0.6) inset;
      transition: background .15s ease, box-shadow .15s ease, transform .02s ease;
      user-select: none;
    }

    #listToggles .toggle-btn:hover {
      background: linear-gradient(#ffffff, #eef3f7);
    }

    #listToggles .toggle-btn:active {
      transform: translateY(1px);
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, .12), 0 0 0 1px rgba(255, 255, 255, 0.6) inset;
    }

    #listToggles .toggle-btn.active {
      background: #e3f2fd;
      border-color: #90caf9;
      color: #0d47a1;
      box-shadow: inset 0 2px 6px rgba(0, 0, 0, .14), 0 0 0 1px rgba(255, 255, 255, 0.7) inset;
    }

    #listToggles .toggle-btn:focus-visible {
      outline: none;
      box-shadow: 0 0 0 2px #90caf9aa, inset 0 2px 4px rgba(0, 0, 0, .08);
    }

    .notif-unread {
      margin-top: 6px;
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .mark-one {
      padding: 0.2em 0.6em;
      font-size: 0.9em;
      border: 1px solid #1976d2;
      border-radius: 4px;
      background: #fff;
      color: #1976d2;
    }

    .back-Btn {
      margin-right: 6px;
      padding: 4px 10px;
      border: 1px solid #cfd8dc;
      background: #fff;
      color: #455a64;
      border-radius: 6px;
      cursor: pointer;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="fixed-header">
      <div class="header-title">
        <span id="yearLabel" style="display: none;"></span>
        <a>勤務記録一覧</a>
        <div style="display:flex;align-items:center;gap:6px;">
          <input type="month" id="monthSelect" />
          <button id="menuToggle" class="hamburger" aria-label="メニュー" aria-expanded="false" aria-controls="sideMenu">
            <span class="bar"></span>
            <span class="bar"></span>
            <span class="bar"></span>
            <span id="menuNotifBadge" class="notif-badge"></span>
          </button>
        </div>
      </div>
      <div id="statsBox">
        <div class="statsBoxLabel">
          <span id="workDaysLabel" style="grid-row: 1; grid-column: 1;">出勤日数</span>
          <span id="totalWorkHoursLabel" style="grid-row: 1; grid-column: 2;">勤務時間</span>
          <span id="totalOvertimeHoursLabel" style="grid-row: 1; grid-column: 3;">超勤時間</span>
          <span id="paidLeaveMinutesLabel" style="grid-row: 1; grid-column: 4;">有給時間</span>
          <span id="missingCountLabel" style="grid-row: 1; grid-column: 5; display:none;">未打刻</span>
        </div>
        <div class="statsBoxValue">
          <span id="workDaysValue" style="grid-row: 2; grid-column: 1;"></span>
          <span id="totalWorkHoursValue" style="grid-row: 2; grid-column: 2;"></span>
          <span id="totalOvertimeHoursValue" style="grid-row: 2; grid-column: 3;"></span>
          <span id="paidLeaveMinutesValue" style="grid-row: 2; grid-column: 4;"></span>
          <span id="missingCountValue" style="grid-row: 2; grid-column: 5;display:none;"></span>
        </div>
      </div>
      <div id="flexDetail" class="flex-summary-detail">
        <div class="flex-summary-line">
          <span id="flexWorkedMinutesLabel">実働 / 所定</span>
          <span id="flexWorkedMinutes">0:00 / 0:00</span>
        </div>
        <div class="flex-summary-line">
          <span id="flexPaidLeaveMinutesLabel">有給</span>
          <span id="flexPaidLeaveMinutes">0:00</span>
        </div>
      </div>
      <section id="flexSummaryBox" class="flex-summary" aria-expanded="false" aria-live="polite">
        <div class="flex-summary-header" id="flexHeader">
          <button id="flexToggle" class="expand-toggle" aria-controls="flexBody" aria-expanded="false">＞</button>
          <span class="flex-summary-title">フレックス</span>
        </div>
        <div id="flexBody" class="flex-summary-body" aria-live="polite">
          <div id="flexCurrent" class="flex-summary-line">
            <span>今月</span>
            <span id="flexCurrentDelta" class="flex-delta neutral">±0:00</span>
          </div>
          <div id="flexDetail" class="flex-summary-detail">
            <div class="flex-summary-line">
              <span id="flexPeriodLabel">期間</span>
              <span id="flexPeriod">2025年1月16日～2025年2月15日</span>
            </div>
          </div>
          <div id="flexTwoMonth" class="flex-summary-line" style="display:none;">
            <span>フレックス算定</span>
            <span id="flexTwoMonthDelta" class="flex-delta neutral">±0:00</span>
          </div>
          <div id="flexDetail-TwoMonth" class="flex-summary-detail" style="display:none;">
            <div class="flex-summary-line">
              <span id="flexSettlementMonthsLabel">算定期間</span>
              <span id="flexSettlementMonths">2025年1月度/2025年2月度</span>
            </div>
            <div class="flex-summary-line">
              <span id="flexTwoMonthWorkedMinutesLabel">実働 / 所定</span>
              <span id="flexTwoMonthWorkedMinutes">0:00 / 0:00</span>
            </div>
            <div class="flex-summary-line">
              <span id="flexTwoMonthPaidLeaveMinutesLabel">有給</span>
              <span id="flexTwoMonthPaidLeaveMinutes">0:00</span>
            </div>
          </div>
        </div>
      </section>
      <div class="toggle-area" id="toggleArea">
        <label for="listToggles">表示切替:</label>
        <div id="listToggles">
          <button type="button" class="toggle-btn" data-type="work">勤務</button>
          <button type="button" class="toggle-btn" data-type="off">全休</button>
          <button type="button" class="toggle-btn" data-type="paid">有給</button>
          <button type="button" class="toggle-btn" data-type="ignore">除外</button>
          <button type="button" class="toggle-btn" data-type="missing">未</button>
        </div>
      </div>
    </div>
    <div class="scroll-area">
      <ul class="record-list" id="recordList">
        <!-- 勤務記録行がここに動的に挿入されます -->
      </ul>
    </div>
    <div class="fixed-footer">
      <div class="footer-btns">
        <button class="footer-btn" id="paidLeaveBtn">有給入力</button>
        <button class="footer-btn" id="addRecordBtn">＋新規追加</button>
      </div>
    </div>
  </div>
  <div id="overlay" class="overlay" style="display:none;"></div>
  <div id="menuOverlay" class="menu-overlay" tabindex="-1"></div>
  <nav id="sideMenu" class="menu-drawer" aria-hidden="true" tabindex="-1">
    <div class="menu-header">メニュー</div>
    <ul class="menu-list">
      <li><button type="button" id="menuOpenNotif">お知らせを開く</button></li>
      <li><a href="myday_dashboard.html">ダッシュボード</a></li>
      <li><a href="punch.html">打刻画面へ</a></li>
      <li><a href="admin.html" id="menuAdmin" style="display:none;">管理者メニュー</a></li>
      <li><button type="button" id="menuLogout">ログアウト</button></li>
    </ul>
  </nav>
  <script>
    // グローバル設定: 編集モードは将来ONにできるフラグ（現在は未使用）
    // 有効化したい場合は window.__enableEditingMode = true; を設定してください。
    window.__enableEditingMode = false;

    // DOM参照（遅延初期化）
    // - 関数宣言が先に出てくる都合で、const だと TDZ で落ちやすいので let にする
    let recordList = null;

    function setTextById(id, text) {
      const el = document.getElementById(id);
      if (el) el.textContent = text;
    }

    function saveScroll() {
      const sa = document.querySelector('.scroll-area');
      window.__preserveScrollY = sa ? sa.scrollTop : (window.scrollY || document.documentElement.scrollTop || 0);
    }

    function restoreScroll() {
      const y = (typeof window.__preserveScrollY === 'number') ? window.__preserveScrollY : null;
      if (y === null) return;
      try {
        const sa = document.querySelector('.scroll-area');
        if (sa && typeof sa.scrollTo === 'function') sa.scrollTo({ top: y });
        else if (sa) sa.scrollTop = y; else window.scrollTo({ top: y });
      } catch (_) {
        try { const sa2 = document.querySelector('.scroll-area'); if (sa2) sa2.scrollTop = y; else window.scrollTo(0, y); } catch (__e) { }
      }
      window.__preserveScrollY = null;
    }

    function closeInlinePanel() {
      const active = document.querySelector('li.inline-panel-row');
      if (active && active.parentNode) active.parentNode.removeChild(active);
      const sa = document.querySelector('.scroll-area');
      if (sa) sa.classList.remove('editing-mode');
      // addRecordBtn などのフラグを巻き戻す（パネルが別経路で閉じられた場合に備える）
      try { addPanelActive = false; } catch (_) { }
      // 末尾スペーサ削除
      if (window.__inlineSpacerEl && window.__inlineSpacerEl.parentNode) {
        try { window.__inlineSpacerEl.parentNode.removeChild(window.__inlineSpacerEl); } catch (_) { }
        window.__inlineSpacerEl = null;
      }
      // overlayクリックハンドラを残さない
      try {
        const ov = document.getElementById('overlay');
        if (ov) ov.onclick = null;
      } catch (_) { }
      hideOverlay();
    }

    function insertActiveRowAfter(anchorLi, activeLi) {
      // 挿入位置: アンカー行の直後（アンカーが無い場合は先頭）
      if (!recordList) return;
      if (anchorLi && anchorLi.parentNode === recordList) {
        if (anchorLi.nextSibling) recordList.insertBefore(activeLi, anchorLi.nextSibling);
        else recordList.appendChild(activeLi);
      } else {
        recordList.insertBefore(activeLi, recordList.firstChild);
      }
    }

    function alignActiveRowToListLabel(activeLi) {
      // ラベル上端とアクティブ行上端を揃えるスクロール調整（scroll-area基準、下端不足は末尾スペーサで補う）
      requestAnimationFrame(() => {
        try {
          const sa = document.querySelector('.scroll-area');
          const label = document.getElementById('listLabelItem');
          if (sa && label && activeLi) {
            const saRect = sa.getBoundingClientRect();
            const activeTop = activeLi.getBoundingClientRect().top - saRect.top;
            const labelTop = label.getBoundingClientRect().top - saRect.top;
            const delta = activeTop - labelTop;
            if (Math.abs(delta) > 1) {
              let target = sa.scrollTop + delta;
              const maxScroll = sa.scrollHeight - sa.clientHeight;
              if (target > maxScroll) {
                const need = Math.ceil(target - maxScroll + 8);
                const recordListEl = document.getElementById('recordList') || (sa ? sa.querySelector('#recordList') : null);
                if (recordListEl) {
                  const spacer = document.createElement('li');
                  spacer.className = 'spacer-li';
                  spacer.style.height = need + 'px';
                  spacer.style.border = 'none';
                  spacer.style.background = 'transparent';
                  spacer.setAttribute('aria-hidden', 'true');
                  recordListEl.appendChild(spacer);
                  window.__inlineSpacerEl = spacer;
                  target = Math.min(sa.scrollTop + delta, sa.scrollHeight - sa.clientHeight);
                }
              }
              sa.scrollTo({ top: target, behavior: 'smooth' });
            }
          } else if (activeLi && typeof activeLi.scrollIntoView === 'function') {
            activeLi.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
        } catch (_) { }
      });
    }

    function paidPanelBuildModel(date) {
      const info = window.__paidLeave ? window.__paidLeave[date] : null;
      return {
        date,
        hours: info ? (info.hours || '') : '',
        reasonEsc: info && info.reason ? escapeHtml(info.reason) : ''
      };
    }

    function paidPanelBuildHTML(model) {
      const reasonRow = model.reasonEsc ? `<div><b>理由:</b> ${model.reasonEsc}</div>` : '';
      return `
              <div style='margin:0 0 8px 0;padding:6px 8px;border:1px solid #a5d6a7;background:#e8f5e9;color:#1b5e20;border-radius:6px;font-size:.85em;'>この日は有給（${model.hours}h）です</div>
              <div style='display:grid;row-gap:6px;font-size:.95em;'>
                <div><b>日付:</b> ${model.date}</div>
                <div><b>区分:</b> 有給</div>
                ${reasonRow}
              </div>
              <div style='display:flex;gap:8px;margin-top:10px;'>
                <button class='cancel-btn'>閉じる</button>
              </div>
            `;
    }

    function inlinePanelRenderPaid(ctx) {
      const { date, panel, closePanel, bindCancelButtons } = ctx;
      const model = paidPanelBuildModel(date);
      panel.innerHTML = paidPanelBuildHTML(model);
      bindCancelButtons(panel, closePanel);
    }

    function ignorePanelBuildModel(date) {
      return { date };
    }

    function ignorePanelBuildHTML(model) {
      return `
              <div style='margin:0 0 8px 0;padding:6px 8px;border:1px solid #b0bec5;background:#eceff1;color:#37474f;border-radius:6px;font-size:.85em;'>この日は集計対象外です</div>
              <div style='display:grid;row-gap:6px;font-size:.95em;'>
                <div><b>日付:</b> ${model.date}</div>
                <div><b>区分:</b> 除外</div>
              </div>
              <div style='display:flex;gap:8px;margin-top:10px;'>
                <button class='cancel-btn'>閉じる</button>
              </div>`;
    }

    function inlinePanelRenderIgnore(ctx) {
      const { date, panel, closePanel, bindCancelButtons } = ctx;
      const model = ignorePanelBuildModel(date);
      panel.innerHTML = ignorePanelBuildHTML(model);
      bindCancelButtons(panel, closePanel);
    }

    function lockedPanelBuildModel(date, rec) {
      const rec2 = rec || (window.__recordMap ? window.__recordMap[date] : null);
      return {
        date,
        pin: rec2 ? formatTime(rec2.clockIn) : '',
        pout: rec2 ? formatTime(rec2.clockOut) : '',
        brMin: rec2 ? Math.floor(calcTotalBreak(rec2.breaks || [])) : 0
      };
    }

    function lockedPanelBuildHTML(model) {
      return `
              <div style='margin:0 0 8px 0;padding:6px 8px;border:1px solid #ef9a9a;background:#ffebee;color:#b71c1c;border-radius:6px;font-size:.85em;'>ロックされています。編集はできません。</div>
              <div style='display:grid;row-gap:8px;font-size:.95em;'>
                <div><b>日付:</b> ${model.date}</div>
                <div style='display:flex;gap:8px;align-items:center;'>
                  <label>出勤</label><input type='time' value='${model.pin}' disabled>
                  <label>退勤</label><input type='time' value='${model.pout}' disabled>
                  <label>休憩(分)</label><input type='number' value='${model.brMin}' disabled style='width:6em;'>
                </div>
              </div>
              <div style='display:flex;gap:8px;margin-top:10px;'>
                <button class='cancel-btn'>閉じる</button>
              </div>`;
    }

    function inlinePanelRenderLocked(ctx) {
      const { date, panel, closePanel, bindCancelButtons, rec } = ctx;
      const model = lockedPanelBuildModel(date, rec);
      panel.innerHTML = lockedPanelBuildHTML(model);
      bindCancelButtons(panel, closePanel);
    }

    function offPanelBuildModel(date) {
      return { date, locked: isLocked(date) };
    }

    function offPanelBuildHTML(model) {
      return `
              <div style='margin:0 0 8px 0;padding:6px 8px;border:1px solid #ffe082;background:#fff8e1;color:#5d4037;border-radius:6px;font-size:.85em;'>この日は全休です</div>
              <div style='display:grid;row-gap:6px;font-size:.95em;'>
                <div><b>日付:</b> ${model.date}</div>
                <div><b>区分:</b> 全休</div>
              </div>
              <div style='display:flex;gap:8px;margin-top:10px;'>
                <button class='default-btn restore-btn' ${model.locked ? 'disabled title="ロック中"' : ''}>勤務へ戻す</button>
                <button class='cancel-btn'>閉じる</button>
              </div>`;
    }

    function inlinePanelRenderOff(ctx) {
      const { date, panel, closePanel, bindCancelButtons, reloadAndReopenInlinePanel } = ctx;
      const model = offPanelBuildModel(date);
      panel.innerHTML = offPanelBuildHTML(model);
      bindCancelButtons(panel, closePanel);
      const backBtn = panel.querySelector('.restore-btn');
      if (backBtn && !model.locked) {
        backBtn.onclick = async () => {
          const res = await fetch('api/day_status_self_clear.php', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ date }) });
          if (res.ok) {
            await reloadAndReopenInlinePanel({ reopenDate: date, reopenMode: 'work' });
          } else {
            alert('勤務へ戻すに失敗しました');
          }
        };
      }
    }

    function workPanelReadInputs(panel) {
      const vin = panel.querySelector('#editIn')?.value || null;
      const vout = panel.querySelector('#editOut')?.value || null;
      const vbr = Number(panel.querySelector('#editBreak')?.value || 0);
      return { clockIn: vin, clockOut: vout, breakMinutes: vbr };
    }

    function workPanelBuildBreaksFromMinutes(minutes) {
      const br = Number(minutes || 0);
      // 簡易化: 休憩は総分から単一ブレイクへ反映（既存の詳細休憩UIは後続で統合）
      return br > 0 ? [{ start: null, end: null, minutes: br }] : [];
    }

    function workPanelBuildUpdateBody(date, rec2, inputs) {
      return {
        date: date,
        clockIn: inputs.clockIn,
        clockOut: inputs.clockOut,
        breaks: workPanelBuildBreaksFromMinutes(inputs.breakMinutes),
        vehicleDistance: rec2 && rec2.vehicleDistance ? rec2.vehicleDistance : 0
      };
    }

    async function workPanelSubmitUpdate(body) {
      return await fetch('api/attendance_update.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
    }

    function workPanelBuildHTML({ locked, date, pin, pout, brMin }) {
      return `
              ${locked ? `<div style='margin:0 0 8px 0;padding:6px 8px;border:1px solid #ef9a9a;background:#ffebee;color:#b71c1c;border-radius:6px;font-size:.85em;'>この期間はロックされています。編集できません。</div>` : ''}
              <div style='display:grid;row-gap:8px;font-size:.95em;'>
                <div><b>日付:</b> ${date}</div>
                <div style='display:flex;gap:8px;align-items:center;'>
                  <label>出勤</label><input id='editIn' type='time' value='${pin}' ${locked ? 'disabled' : ''}>
                  <label>退勤</label><input id='editOut' type='time' value='${pout}' ${locked ? 'disabled' : ''}>
                  <label>休憩(分)</label><input id='editBreak' type='number' value='${brMin}' min='0' ${locked ? 'disabled' : ''} style='width:6em;'>
                </div>
              </div>
              <div style='display:flex;gap:8px;margin-top:10px;'>
                <button class='save-btn' ${locked ? 'disabled' : ''}>保存</button>
                <button class='cancel-btn'>閉じる</button>
              </div>`;
    }

    function workPanelBuildModel(date, rec) {
      const rec2 = rec || (window.__recordMap ? window.__recordMap[date] : null);
      return {
        locked: isLocked(date),
        date,
        rec2,
        pin: rec2 ? formatTime(rec2.clockIn) : '',
        pout: rec2 ? formatTime(rec2.clockOut) : '',
        brMin: rec2 ? Math.floor(calcTotalBreak(rec2.breaks || [])) : 0
      };
    }

    function inlinePanelRenderWork(ctx) {
      const { date, panel, closePanel, bindCancelButtons, reloadAndReopenInlinePanel, rec } = ctx;
      const model = workPanelBuildModel(date, rec);
      panel.innerHTML = workPanelBuildHTML(model);
      const saveBtn = panel.querySelector('.save-btn');
      bindCancelButtons(panel, closePanel);
      if (saveBtn && !model.locked) {
        saveBtn.onclick = async () => {
          const inputs = workPanelReadInputs(panel);
          const body = workPanelBuildUpdateBody(date, model.rec2, inputs);
          const res = await workPanelSubmitUpdate(body);
          if (res.ok) {
            // Option B: 再取得後に同日へ再挿入
            await reloadAndReopenInlinePanel({ reopenDate: date, reopenMode: 'work' });
          } else {
            alert('保存に失敗しました');
          }
        };
      }
      // フォーカス
      const focusEl = panel.querySelector('#editIn'); if (focusEl) try { focusEl.focus(); } catch (_) { }
    }

    function addPanelRenderClassification(panel, dateStr) {
      const wrap = panel ? panel.querySelector('#addClassification') : null;
      if (!wrap) return;
      wrap.innerHTML = classificationControls(dateStr);
    }

    function addPanelUpdateLockWarn(panel, dateStr) {
      const warn = panel ? panel.querySelector('#addLockWarn') : null;
      if (!warn) return;
      warn.style.display = isLocked(dateStr) ? 'block' : 'none';
    }

    function addPanelToDateObj(dateStr, timeStr) {
      if (!dateStr || !timeStr) return null;
      return new Date(`${dateStr}T${timeStr.length === 5 ? timeStr + ':00' : timeStr}`);
    }

    function addPanelValidateInputs(panel, addRec) {
      const dateVal = panel.querySelector('#addDate')?.value;
      const inVal = panel.querySelector('#addIn')?.value;
      const outVal = panel.querySelector('#addOut')?.value;
      if (!dateVal || !inVal || !outVal) return false;
      if (isLocked(dateVal)) return false;
      if (records.some(r => r.date === dateVal)) return false;

      const inDate = addPanelToDateObj(dateVal, inVal);
      const outDate = addPanelToDateObj(dateVal, outVal);
      if (inDate && outDate && inDate >= outDate) return false;

      for (let i = 0; i < addRec.breaks.length; i++) {
        const b = addRec.breaks[i];
        const bStart = b.start ? addPanelToDateObj(dateVal, b.start) : null;
        const bEnd = b.end ? addPanelToDateObj(dateVal, b.end) : null;
        if (!b.start || !b.end) return false;
        if (bStart && bEnd) {
          if (bStart >= bEnd) return false;
          if (inDate && bStart < inDate) return false;
          if (outDate && bEnd > outDate) return false;
        }
      }

      const monthVal = document.getElementById('monthSelect')?.value;
      if (monthVal && !dateVal.startsWith(monthVal)) return false;
      return true;
    }

    function addPanelUpdateSaveBtn(panel, addRec) {
      const btn = panel ? panel.querySelector('.save-btn') : null;
      if (!btn) return;
      btn.disabled = !addPanelValidateInputs(panel, addRec);
    }

    function addPanelRenderBreaks(panel, addRec, { onChanged, onRequestRerender }) {
      const breakEditList = panel ? panel.querySelector('#addBreakEditList') : null;
      if (!breakEditList) return;
      breakEditList.innerHTML = '';
      addRec.breaks.forEach((b, i) => {
        const row = document.createElement('div');
        row.className = 'break-edit-row';
        row.innerHTML = `
                    <span>${i + 1}.</span>
                    <input type='time' value='${b.start || ''}' class='break-start'> ～
                    <input type='time' value='${b.end || ''}' class='break-end'>
                    <button type='button' title='削除'>×</button>`;
        const startInput = row.querySelector('.break-start');
        const endInput = row.querySelector('.break-end');
        if (startInput) startInput.onchange = e => { b.start = e.target.value; if (onChanged) onChanged(); };
        if (endInput) endInput.onchange = e => { b.end = e.target.value; if (onChanged) onChanged(); };
        const delBtn = row.querySelector('button');
        if (delBtn) {
          delBtn.onclick = e => {
            e.stopPropagation();
            addRec.breaks.splice(i, 1);
            if (onRequestRerender) onRequestRerender();
            if (onChanged) onChanged();
          };
        }
        breakEditList.appendChild(row);
      });
    }

    function addPanelBuildModel(date) {
      return { date, clockIn: '', clockOut: '', breaks: [], vehicleDistance: 0 };
    }

    function addPanelBuildHTML(model) {
      return `
              <div style='display:grid;row-gap:10px;'>
                <label style='display:inline-grid;gap:4px;'>日付
                  <input type='date' id='addDate' value='${model.date}'>
                </label>
                <div id='addLockWarn' style='display:none;margin:0;padding:6px 8px;border:1px solid #ffcc80;background:#fff3e0;color:#e65100;border-radius:6px;font-size:.85em;'>この日は期間ロック中のため保存できません</div>
                <div style='display:flex;flex-wrap:wrap;gap:8px;align-items:center;'>
                  <label>始業</label><input type='time' id='addIn'>
                  <label>終業</label><input type='time' id='addOut'>
                  <label>車距離</label><input type='number' min='0' step='1' id='addVehicleDistance' value='0' style='width:6em;'><span>km</span>
                </div>
                <div id='addClassification' style='margin-top:2px;'></div>
                <div>
                  <b>休憩:</b>
                  <div id='addBreakEditList' style='margin-top:0.4em;'></div>
                  <div style='margin-top:6px;'><button class='add-break-btn' type='button'>＋休憩を追加</button></div>
                </div>
                <div style='display:flex;gap:8px;justify-content:flex-end;'>
                  <button class='save-btn' type='button' disabled>保存</button>
                  <button class='cancel-btn' type='button'>キャンセル</button>
                </div>
              </div>
            `;
    }

    function inlinePanelRenderAdd(ctx) {
      const { date, panel, closePanel } = ctx;
      addPanelActive = true;
      const addRec = addPanelBuildModel(date);
      panel.innerHTML = addPanelBuildHTML(addRec);

      const onChanged = () => addPanelUpdateSaveBtn(panel, addRec);
      const rerenderBreaks = () => addPanelRenderBreaks(panel, addRec, { onChanged, onRequestRerender: rerenderBreaks });

      const addBreakBtn = panel.querySelector('.add-break-btn');
      if (addBreakBtn) {
        addBreakBtn.onclick = () => { addRec.breaks.push({ start: '', end: '' }); rerenderBreaks(); onChanged(); };
      }

      panel.querySelector('#addDate')?.addEventListener('input', e => {
        addRec.date = e.target.value;
        addPanelRenderClassification(panel, addRec.date);
        addPanelUpdateLockWarn(panel, addRec.date);
        onChanged();
      });
      panel.querySelector('#addIn')?.addEventListener('input', e => { addRec.clockIn = e.target.value; onChanged(); });
      panel.querySelector('#addOut')?.addEventListener('input', e => { addRec.clockOut = e.target.value; onChanged(); });
      panel.querySelector('#addVehicleDistance')?.addEventListener('input', e => { addRec.vehicleDistance = Number(e.target.value) || 0; onChanged(); });

      rerenderBreaks();
      addPanelRenderClassification(panel, addRec.date);
      addPanelUpdateLockWarn(panel, addRec.date);
      onChanged();

      const cancelBtn = panel.querySelector('.cancel-btn');
      if (cancelBtn) cancelBtn.onclick = e => { if (e) e.stopPropagation(); closePanel(); };

      const saveBtn = panel.querySelector('.save-btn');
      if (saveBtn) {
        saveBtn.onclick = async () => {
          if (!addPanelValidateInputs(panel, addRec)) { alert('入力内容に誤りがあります。'); return; }
          const res = await fetch('api/attendance_update.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ date: addRec.date, clockIn: addRec.clockIn, clockOut: addRec.clockOut, breaks: addRec.breaks, vehicleDistance: addRec.vehicleDistance })
          });
          if (res.ok) {
            addPanelActive = false;
            const monthVal = document.getElementById('monthSelect').value;
            clearForceVisibleDate();
            if (shouldAutoBack()) { backNavigate(); return; }
            await loadRecordsByPeriod(monthVal);
          } else {
            alert('新規追加に失敗しました');
          }
        };
      }

      const inEl = panel.querySelector('#addIn');
      if (inEl) { try { inEl.focus(); } catch (_) { } }
    }

    function unknownPanelBuildModel(mode) {
      return { mode };
    }

    function unknownPanelBuildHTML(model) {
      return `
      <div style='color:#777;'>このモード(${model.mode})のインラインパネルは未実装です。</div>
      <div style='display:flex;gap:8px;margin-top:10px;'>
        <button class='cancel-btn'>閉じる</button>
      </div>`;
    }

    function inlinePanelRenderUnknown(ctx) {
      const { mode, panel, closePanel, bindCancelButtons } = ctx;
      const model = unknownPanelBuildModel(mode);
      panel.innerHTML = unknownPanelBuildHTML(model);
      bindCancelButtons(panel, closePanel);
    }

    function inlinePanelCreateShell(panelDate) {
      const li = document.createElement('li');
      li.className = 'record-row active inline-panel-row';
      li.innerHTML = `
      <div class="record-main">
        <span class="record-date">${formatDateDAtoSpan(formatDateDA(panelDate))}</span>
        <div class="record-times"></div>
      </div>
      <div class="expand-panel"></div>`;
      const panel = li.querySelector('.expand-panel');
      return { li, panel };
    }

    function inlinePanelBindOverlayClose(closeFn) {
      const ov = document.getElementById('overlay');
      if (ov) ov.onclick = closeFn;
    }

    function inlinePanelBindCancelButtons(panelEl, closeFn) {
      if (!panelEl) return;
      panelEl.querySelectorAll('.cancel-btn').forEach(btn => {
        btn.onclick = (e) => { if (e) e.stopPropagation(); closeFn(); };
      });
    }

    function inlinePanelCreateCloseHandler() {
      return () => {
        addPanelActive = false;
        clearForceVisibleDate();
        saveScroll();
        closeInlinePanel();
        restoreScroll();
        if (shouldAutoBack()) { backNavigate(); }
      };
    }

    function inlinePanelOpen(panelDate) {
      // 多重開きを避ける
      closeInlinePanel();
      // 編集モード（将来用フラグ）
      const sa = document.querySelector('.scroll-area');
      if (sa && window.__enableEditingMode) sa.classList.add('editing-mode');
      showOverlay();

      const { li, panel } = inlinePanelCreateShell(panelDate);
      const closePanel = inlinePanelCreateCloseHandler();
      inlinePanelBindOverlayClose(closePanel);
      return { li, panel, closePanel };
    }

    function inlinePanelFindAnchorRowByDate(d) {
      const byData = document.querySelector(`li.record-row[data-date="${d}"]`);
      if (byData) return byData;
      const lis = document.querySelectorAll('li.record-row');
      return Array.from(lis).find(el => (el.textContent || '').includes(d)) || null;
    }

    async function reloadAndReopenInlinePanel({ reopenDate, reopenMode }) {
      saveScroll();
      // フィルタに関わらず対象日を表示して再オープンできるようにする
      window.__forceVisibleDate = reopenDate;
      const monthVal = getSelectedMonthVal();
      await loadRecordsByPeriod(monthVal);
      closeInlinePanel();
      const anchor = inlinePanelFindAnchorRowByDate(reopenDate);
      const rec3 = window.__recordMap ? window.__recordMap[reopenDate] : null;
      if (anchor) insertInlinePanelFor(anchor, reopenDate, reopenMode, rec3);
      restoreScroll();
    }

    const INLINE_PANEL_RENDERERS = {
      paid: inlinePanelRenderPaid,
      ignore: inlinePanelRenderIgnore,
      locked: inlinePanelRenderLocked,
      off: inlinePanelRenderOff,
      work: inlinePanelRenderWork,
      add: inlinePanelRenderAdd
    };

    async function insertInlinePanelFor(anchorLi, date, mode, rec) {
      if (!anchorLi || !date) return;

      const { li, panel, closePanel } = inlinePanelOpen(date);

      const renderer = INLINE_PANEL_RENDERERS[mode] || inlinePanelRenderUnknown;
      renderer({ date, mode, rec, panel, closePanel, reloadAndReopenInlinePanel, bindCancelButtons: inlinePanelBindCancelButtons });
      insertActiveRowAfter(anchorLi, li);
      alignActiveRowToListLabel(li);
    }
    // --- 戻り導線（back, backMode） ---
    function sanitizeBackUrl(url) {
      if (!url) return null;
      try {
        const u = new URL(url, window.location.origin);
        if (u.origin !== window.location.origin) return null; // 同一オリジンのみ
        return u.pathname + u.search + u.hash;
      } catch (_) { return null; }
    }
    function initBackNavFromUrl() {
      try {
        const params = new URLSearchParams(window.location.search);
        const back = params.get('back');
        const backMode = (params.get('backMode') || 'manual').toLowerCase();
        window.__backUrl = sanitizeBackUrl(back);
        window.__backMode = (backMode === 'auto') ? 'auto' : 'manual';
      } catch (_) {
        window.__backUrl = null; window.__backMode = 'manual';
      }
    }
    function shouldAutoBack() { return !!window.__backUrl && window.__backMode === 'auto'; }
    function backNavigate() {
      if (window.__backUrl) { window.location.href = window.__backUrl; }
      else if (window.history && typeof window.history.back === 'function') { window.history.back(); }
    }
    function renderBackButton() {
      if (!window.__backUrl || window.__backMode === 'auto') return;
      const headerTitle = document.querySelector('.header-title');
      if (!headerTitle) return;
      if (document.getElementById('backBtn')) return;
      const btn = document.createElement('button');
      btn.id = 'backBtn';
      btn.className = 'back-Btn';
      btn.type = 'button';
      btn.textContent = '← 戻る';
      btn.addEventListener('click', () => backNavigate());
      headerTitle.insertBefore(btn, headerTitle.firstChild);
    }
    // fetchラッパー: 未ログインならlogin.htmlへ遷移
    async function fetchWithAuth(url, options) {
      const res = await fetch(url, options);
      if (res.status === 401) {
        window.location.href = 'login.html';
        return null;
      }
      return res; // 403などは呼び出し側で必要なら処理
    }
    // ダミーデータ削除・APIから取得
    let records = [];
    // 勤怠ルール設定値
    let settings = {
      period_start: 1,
      period_end: 31,
      rounding_type: 'floor',
      rounding_unit: 1,
      work_hours: 8,
      work_minutes: 0
    };
    const flexSummaryBox = document.getElementById('flexSummaryBox');
    const flexBody = document.getElementById('flexBody');
    const flexToggle = document.getElementById('flexToggle');
    const flexHeader = document.getElementById('flexHeader');
    const flexCurrentDelta = document.getElementById('flexCurrentDelta');
    const flexTwoMonthRow = document.getElementById('flexTwoMonth');
    const flexTwoMonthDelta = document.getElementById('flexTwoMonthDelta');
    const flexDetail = document.getElementById('flexDetail');
    const flexDetailTwoMonth = document.getElementById('flexDetail-TwoMonth');
    const flexWorkedMinutes = document.getElementById('flexWorkedMinutes');
    const flexPaidLeaveMinutes = document.getElementById('flexPaidLeaveMinutes');
    const flexPeriod = document.getElementById('flexPeriod');
    const flexSettlementMonths = document.getElementById('flexSettlementMonths');
    const flexTwoMonthWorkedMinutes = document.getElementById('flexTwoMonthWorkedMinutes');
    const flexTwoMonthPaidLeaveMinutes = document.getElementById('flexTwoMonthPaidLeaveMinutes');
    let flexSummaryRequestToken = 0;
    flexHeader.addEventListener('click', () => toggleFlex());
    flexToggle.addEventListener('click', (e) => { e.stopPropagation(); toggleFlex(); });

    // フレックス開閉

    function toggleFlex() {
      const expanded = flexBody.getAttribute('aria-expanded') === 'true';
      if (expanded) {
        flexBody.setAttribute('aria-expanded', 'false');
        flexToggle.setAttribute('aria-expanded', 'false');
        flexToggle.textContent = '＞';
        flexBody.style.display = 'none';
      } else {
        const monthVal = document.getElementById('monthSelect').value;
        clearForceVisibleDate();
        flexBody.setAttribute('aria-expanded', 'true');
        flexToggle.setAttribute('aria-expanded', 'true');
        flexToggle.textContent = '∨';
        flexBody.style.display = 'block';
        refreshFlexSummary(monthVal);
      }
    }

    function flexMinutesToHM(minutes) {
      const numeric = Number(minutes);
      if (!Number.isFinite(numeric)) return '0:00';
      const abs = Math.abs(Math.round(numeric));
      const sign = numeric < 0 ? '-' : '';
      const h = Math.floor(abs / 60);
      const m = String(abs % 60).padStart(2, '0');
      return `${sign}${h}:${m}`;
    }

    function flexFormatDelta(minutes) {
      const numeric = Number(minutes);
      if (!Number.isFinite(numeric) || numeric === 0) return '±0:00';
      const abs = Math.abs(Math.round(numeric));
      const h = Math.floor(abs / 60);
      const m = String(abs % 60).padStart(2, '0');
      return `${numeric > 0 ? '+' : '-'}${h}:${m}`;
    }

    function flexUpdateDelta(el, minutes) {
      if (!el) return;
      el.className = 'flex-delta';
      const numeric = Number(minutes);
      if (!Number.isFinite(numeric)) {
        el.textContent = '--:--';
        el.classList.add('neutral');
        return;
      }
      if (numeric === 0) {
        el.textContent = '±0:00';
        el.classList.add('neutral');
        return;
      }
      el.textContent = flexFormatDelta(numeric);
      el.classList.add(numeric > 0 ? 'positive' : 'negative');
    }

    function flexDateLabel(iso) {
      if (!iso || typeof iso !== 'string') return '';
      const parts = iso.split('-').map(Number);
      if (parts.length !== 3 || parts.some(Number.isNaN)) return iso;
      return `${parts[0]}年${parts[1]}月${parts[2]}日`;
    }

    function flexFormatPeriodRange(period) {
      if (!period || !period.start || !period.end) return '';
      const start = flexDateLabel(period.start);
      const end = flexDateLabel(period.end);
      return start && end ? `${start}〜${end}` : '';
    }

    async function fetchFlexSummary(monthVal) {
      const query = monthVal ? `?month=${encodeURIComponent(monthVal)}` : '';
      const res = await fetchWithAuth(`api/flex_summary.php${query}`);
      if (!res || !res.ok) throw new Error('flex fetch failed');
      return await res.json();
    }

    function shouldShowFlexSummary(data) {
      return !!(data && data.ok !== false && data.is_full_time !== false);
    }

    function resetFlexTwoMonthUI() {
      if (flexTwoMonthRow) flexTwoMonthRow.style.display = 'none';
      if (flexSettlementMonths) flexSettlementMonths.textContent = '';
      if (flexTwoMonthWorkedMinutes) flexTwoMonthWorkedMinutes.textContent = '';
      if (flexTwoMonthPaidLeaveMinutes) flexTwoMonthPaidLeaveMinutes.textContent = '';
      if (flexDetailTwoMonth) flexDetailTwoMonth.style.display = 'none';
    }

    function hideFlexSummaryUI() {
      if (flexSummaryBox) flexSummaryBox.style.display = 'none';
      resetFlexTwoMonthUI();
    }

    function renderFlexSummary(data) {
      if (!flexSummaryBox) return;
      flexSummaryBox.style.display = 'block';
      flexUpdateDelta(flexCurrentDelta, data.delta_minutes);
      if (flexWorkedMinutes) flexWorkedMinutes.textContent = ` ${flexMinutesToHM(data.worked_minutes)} / ${flexMinutesToHM(data.legal_minutes)}`;
      if (flexPaidLeaveMinutes) flexPaidLeaveMinutes.textContent = flexMinutesToHM(data.paid_leave_minutes);
      if (flexPeriod) flexPeriod.textContent = flexFormatPeriodRange(data.period);
    }

    function renderFlexTwoMonth(data) {
      if (data && data.is_settlement_month && data.two_month) {
        const labels = Array.isArray(data.two_month.month_labels) ? data.two_month.month_labels.join(' / ') : '';
        if (flexTwoMonthRow) flexTwoMonthRow.style.display = 'flex';
        flexUpdateDelta(flexTwoMonthDelta, data.two_month.delta_minutes);
        if (flexSettlementMonths) flexSettlementMonths.textContent = labels;
        if (flexTwoMonthWorkedMinutes) flexTwoMonthWorkedMinutes.textContent = ` ${flexMinutesToHM(data.two_month.worked_minutes)} / ${flexMinutesToHM(data.two_month.legal_minutes)}`;
        if (flexTwoMonthPaidLeaveMinutes) flexTwoMonthPaidLeaveMinutes.textContent = flexMinutesToHM(data.two_month.paid_leave_minutes);
        if (flexDetailTwoMonth) flexDetailTwoMonth.style.display = 'block';
      } else {
        resetFlexTwoMonthUI();
      }
    }

    async function refreshFlexSummary(monthVal) {
      if (!flexSummaryBox) return;
      const token = ++flexSummaryRequestToken;
      try {
        const data = await fetchFlexSummary(monthVal);
        if (token !== flexSummaryRequestToken) return;

        if (!shouldShowFlexSummary(data)) {
          hideFlexSummaryUI();
          return;
        }

        renderFlexSummary(data);
        renderFlexTwoMonth(data);
      } catch (e) {
        if (token !== flexSummaryRequestToken) return;
        hideFlexSummaryUI();
      }
    }
    // 設定取得
    async function loadSettings() {
      const res = await fetchWithAuth('api/settings_get.php');
      if (!res) return;
      if (res.ok) settings = await res.json();
    }

    // 指定年月から「前月period_start日」～「選択月period_end日」までの範囲を計算
    function calcPeriodRange(monthVal) {
      // monthVal: "YYYY-MM"
      const [y, m] = monthVal.split("-").map(Number);
      // 前月
      let startYear = y;
      let startMonth = m - 1;
      if (startMonth <= 0) {
        startYear -= 1;
        startMonth += 12;
      }
      const pad = n => n.toString().padStart(2, '0');
      // 月末超過をクランプ
      const daysIn = (yy, mm) => new Date(yy, mm, 0).getDate(); // mm: 1-12, 日数
      const startDay = Math.min(Number(settings.period_start) || 1, daysIn(startYear, startMonth));
      const endDay = Math.min(Number(settings.period_end) || 31, daysIn(y, m));
      const start = `${startYear}-${pad(startMonth)}-${pad(startDay)}`;
      const end = `${y}-${pad(m)}-${pad(endDay)}`;
      return { start, end };
    }
    // 期間を日付配列に展開
    function enumerateDates(start, end) {
      const arr = [];
      const s = new Date(start + 'T00:00:00');
      const e = new Date(end + 'T00:00:00');
      for (let d = new Date(s); d <= e; d.setDate(d.getDate() + 1)) {
        const yy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const dd = String(d.getDate()).padStart(2, '0');
        arr.push(`${yy}-${mm}-${dd}`);
      }
      return arr;
    }

    function createEmptyAuxData() {
      return { dayStatuses: {}, lockedRanges: [], paidLeave: {} };
    }

    async function fetchAttendanceRecords({ start, end }) {
      const options = {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ start, end })
      };
      const res = await fetchWithAuth('api/attendance_list.php', options);
      if (!res) return null;
      if (!res.ok) return { ok: false, records: [] };
      const records = await res.json();
      return { ok: true, records };
    }

    async function fetchAuxData({ start, end }) {
      try {
        const [stRes, lockRes, plRes] = await Promise.all([
          fetchWithAuth(`api/day_status_effective_get.php?start=${start}&end=${end}`),
          fetchWithAuth(`api/period_lock_effective_get.php?start=${start}&end=${end}`),
          fetchWithAuth(`api/paid_leave_history.php?start=${start}&end=${end}`)
        ]);

        const aux = createEmptyAuxData();
        // 日ステータス
        if (stRes && stRes.ok) {
          const stData = await stRes.json();
          (stData.items || []).forEach(it => { if (it && it.date) aux.dayStatuses[it.date] = it; });
        }
        // ロック
        if (lockRes && lockRes.ok) {
          const lockData = await lockRes.json();
          aux.lockedRanges = lockData.locked_ranges || [];
        }
        // 有給履歴
        if (plRes && plRes.ok) {
          const plData = await plRes.json();
          (plData.items || []).forEach(it => { if (it && it.date) aux.paidLeave[it.date] = it; });
        }
        return aux;
      } catch (e) {
        return createEmptyAuxData();
      }
    }

    function applyPeriodDerivedState(periodRange, nextRecords) {
      window.__periodRange = periodRange;
      window.__dayList = enumerateDates(periodRange.start, periodRange.end);
      window.__recordMap = {};
      (nextRecords || []).forEach(r => { if (r && r.date) window.__recordMap[r.date] = r; });
    }

    function applyAuxState(aux) {
      const safeAux = aux || createEmptyAuxData();
      window.__dayStatuses = safeAux.dayStatuses || {};
      window.__lockedRanges = safeAux.lockedRanges || [];
      window.__paidLeave = safeAux.paidLeave || {};
    }

    async function renderPeriodUI(monthVal) {
      setYearLabel();
      renderStatsBox();
      render();
      await refreshFlexSummary(monthVal);
    }

    async function loadRecordsByPeriod(monthVal) {
      const periodRange = calcPeriodRange(monthVal);
      const attendance = await fetchAttendanceRecords(periodRange);
      if (!attendance) return;

      if (attendance.ok) {
        const aux = await fetchAuxData(periodRange);
        records = attendance.records;
        applyPeriodDerivedState(periodRange, attendance.records);
        applyAuxState(aux);
      } else {
        records = [];
        // 互換: 取得失敗時は periodRange/dayList/recordMap は更新しない
        applyAuxState(createEmptyAuxData());
      }

      await renderPeriodUI(monthVal);
    }

    // 勤怠統計情報の表示
    function renderStatsBox() {
      let workDays = 0;
      let totalWorkMin = 0;
      let totalOverMin = 0;
      let missingCount = 0;
      const baseMin = Number(settings.work_hours) * 60 + Number(settings.work_minutes);
      const dayList = window.__dayList || [];
      const now = new Date();
      const pad = n => n.toString().padStart(2, '0');
      const paidLeaves = window.__paidLeave || {};
      // paidLeavesの時間情報を合計
      let totalPaidLeaveMinutes = 0;
      for (const d in paidLeaves) {
        const pl = paidLeaves[d];
        if (pl && typeof pl.minutes === 'number') {
          totalPaidLeaveMinutes += pl.minutes;
        }
      }
      const todayStr = `${now.getFullYear()}-${pad(now.getMonth() + 1)}-${pad(now.getDate())}`;
      for (const d of dayList) {
        const st = (window.__dayStatuses && window.__dayStatuses[d]) ? window.__dayStatuses[d].status : 'work';
        if (st === 'off' || st === 'ignore') continue; // 集計から除外
        const rec = window.__recordMap ? window.__recordMap[d] : null;
        if (rec && rec.clockIn && rec.clockOut) {
          workDays++;
          const s = parseTimeStr(rec.clockIn);
          const e = parseTimeStr(rec.clockOut);
          if (s && e) {
            let min = (e.h * 60 + e.m) - (s.h * 60 + s.m);
            min -= calcTotalBreak(rec.breaks || []);
            if (min > 0) totalWorkMin += min;
            if (min > baseMin) totalOverMin += min - baseMin;
          }
        } else {
          // 未打刻件数（未来日は除外、有給は別扱い済み）
          const isMissing = (!rec) && (st === 'work' || st === 'am_off' || st === 'pm_off');
          const isPaid = !!(window.__paidLeave && window.__paidLeave[d]);
          if (isMissing && !isPaid && d <= todayStr) missingCount++;
        }
      }
      const totalWorkStr = `${Math.floor(totalWorkMin / 60)}:${(totalWorkMin % 60).toString().padStart(2, "0")}`;
      const totalOverStr = totalOverMin > 0 ? `${Math.floor(totalOverMin / 60)}:${(totalOverMin % 60).toString().padStart(2, "0")}` : "0";
      setTextById("workDaysValue", workDays.toString() + "日");
      setTextById("totalWorkHoursValue", totalWorkStr);
      setTextById("totalOvertimeHoursValue", totalOverStr);
      setTextById("paidLeaveMinutesValue", `${Math.floor(totalPaidLeaveMinutes / 60)}:${(totalPaidLeaveMinutes % 60).toString().padStart(2, "0")}`);
      setTextById("missingCountValue", String(missingCount));
    }
    function parseTimeStr(str) {
      // "HH:MM" or "YYYY-MM-DD HH:MM:SS" → {h, m}
      if (!str) return null;
      let t = str.trim();
      if (t.length > 5) t = t.slice(-8, -3); // "YYYY-MM-DD HH:MM:SS" → "HH:MM"
      const [h, m] = t.split(":");
      if (h === undefined || m === undefined) return null;
      return { h: parseInt(h, 10), m: parseInt(m, 10) };
    }
    function calcTotalBreak(breaks) {
      let total = 0;
      for (const b of breaks) {
        const s = parseTimeStr(b.start);
        const e = parseTimeStr(b.end);
        if (s && e) {
          total += (e.h * 60 + e.m) - (s.h * 60 + s.m);
        }
      }
      return total;
    }
    // 勤怠ルール設定値・設定取得（重複定義を削除）
    // ...既に上部で定義済みのためここは削除...
    // 丸め関数
    function roundMinutes(min) {
      const unit = Number(settings.rounding_unit) || 1;
      if (unit <= 1) return min;
      if (settings.rounding_type === 'ceil') return Math.ceil(min / unit) * unit;
      if (settings.rounding_type === 'round') return Math.round(min / unit) * unit;
      return Math.floor(min / unit) * unit;
    }
    // 労働時間（分）計算
    function calcWorkMin(clockIn, clockOut, breaks) {
      const s = parseTimeStr(clockIn);
      const e = parseTimeStr(clockOut);
      if (!s || !e) return 0;
      let min = (e.h * 60 + e.m) - (s.h * 60 + s.m);
      min -= calcTotalBreak(breaks);
      if (min < 0) min = 0;
      return roundMinutes(min);
    }
    recordList = document.getElementById('recordList');
    let addPanelActive = false;
    window.__dayStatuses = window.__dayStatuses || {}; // date -> {status, source, note}

    // 現在ログインユーザーID取得（分類UI用: admin APIは使わず自分のみ）
    (async function () {
      try {
        const who = await fetchWithAuth('api/check_login.php');
        if (who && who.ok) {
          const wj = await who.json();
          window.__currentUserId = wj.user_id;
          // 雇用区分フラグ（1=常勤, 0=パート）
          window.__fullTimeFlag = (wj && typeof wj.full_time !== 'undefined') ? Number(wj.full_time) : 1;
        }
      } catch (e) { }
    })();

    function getSelectedMonthVal() {
      return document.getElementById('monthSelect')?.value || '';
    }

    function getTodayISODate() {
      const today = new Date();
      const pad = n => String(n).padStart(2, '0');
      return `${today.getFullYear()}-${pad(today.getMonth() + 1)}-${pad(today.getDate())}`;
    }

    // 新規追加・有給申請など「日付初期値」を共通化
    // - monthVal が当月なら今日、それ以外は YYYY-MM-01
    function getInitialAddDate(monthVal) {
      const mv = (typeof monthVal === 'string') ? monthVal : getSelectedMonthVal();
      const todayStr = getTodayISODate();
      if (mv && todayStr.startsWith(mv)) return todayStr;
      if (mv) return `${mv}-01`;
      return todayStr;
    }

    document.getElementById('addRecordBtn').onclick = () => {
      if (addPanelActive) return;
      if (!recordList) return;

      const monthVal = getSelectedMonthVal();
      const initialDate = getInitialAddDate(monthVal);

      // 挿入位置はラベル直後（無ければ先頭にダミーアンカー）
      let anchor = document.getElementById('listLabelItem');
      if (!anchor) {
        // 初回ロード直後などで未描画なら描画してから探す
        if (!recordList.firstChild) {
          try { render(); } catch (_) { }
        }
        anchor = document.getElementById('listLabelItem');
      }
      if (!anchor) {
        anchor = recordList.firstChild;
      }
      if (!anchor) {
        const dummy = document.createElement('li');
        dummy.style.display = 'none';
        recordList.appendChild(dummy);
        anchor = dummy;
      }
      saveScroll();
      insertInlinePanelFor(anchor, initialDate, 'add');
      restoreScroll();
    };

    function formatTime(str) {
      if (!str) return '-';
      if (str.length > 5) return str.slice(-8, -3); // "YYYY-MM-DD HH:MM:SS" → "HH:MM"
      if (str.length === 5) return str; // "HH:MM"
      if (str.length === 2 || str.length === 1) return str.padStart(2, '0') + ':00'; // "9"→"09:00"
      return '-';
    }
    // フィルタ制御
    // トグルフィルタ: 選択セット（work/off/paid/ignore/missing）
    let __filterSet = (() => { try { return JSON.parse(localStorage.getItem('attListFilterSet') || 'null'); } catch (_) { return null; } })() || ['work', 'off', 'paid', 'ignore', 'missing'];
    function saveFilterSet() { localStorage.setItem('attListFilterSet', JSON.stringify(__filterSet)); }
    function toggleFilter(type) {
      if (__filterSet.includes(type)) { __filterSet = __filterSet.filter(t => t !== type); } else { __filterSet.push(type); }
      if (__filterSet.length === 0) { __filterSet = ['work']; } // 最低1個
      saveFilterSet();
      syncToggleUI();
      render();
    }
    function syncToggleUI() {
      const wrap = document.getElementById('listToggles');
      if (!wrap) return;
      wrap.querySelectorAll('.toggle-btn').forEach(btn => {
        const t = btn.getAttribute('data-type');
        const on = __filterSet.includes(t);
        btn.classList.toggle('active', on);
        btn.setAttribute('aria-pressed', on ? 'true' : 'false');
        btn.setAttribute('role', 'button');
      });
    }
    function dayType(date) {
      const st = (window.__dayStatuses && window.__dayStatuses[date]) ? window.__dayStatuses[date].status : 'work';
      const hasRec = window.__recordMap && !!window.__recordMap[date];
      if (window.__paidLeave && window.__paidLeave[date]) return 'paid';
      if (st === 'off') return 'off';
      if (st === 'ignore') return 'ignore';
      if (!hasRec && (st === 'work' || st === 'am_off' || st === 'pm_off')) return 'missing';
      return 'work';
    }

    function passFilter(date) {
      // 深リンクやアラートからのジャンプ時は、対象日だけは常に表示してパネルを出せるようにする
      if (window.__forceVisibleDate && date === window.__forceVisibleDate) return true;
      // 互換のため、ハイライト日付でも許可（forceVisible導入前の動作を維持）
      if (window.__highlightDate && date === window.__highlightDate) return true;
      // 未来日（未到達日）の未打刻は表示しない（有給などは例外: dayType が paid で保持）
      const today = new Date();
      const pad = n => n.toString().padStart(2, '0');
      const todayStr = `${today.getFullYear()}-${pad(today.getMonth() + 1)}-${pad(today.getDate())}`;
      if (dayType(date) === 'missing' && date > todayStr) return false;
      return __filterSet.includes(dayType(date));
    }

    // 強制表示の解除（パネルを閉じたタイミング等で呼ぶ）
    function clearForceVisibleDate() {
      window.__forceVisibleDate = null;
    }

    // render()/ハイライト/クリック等で共通の「その日のパネルを開く」処理
    function openInlinePanelForDate(anchorLi, date) {
      const t = dayType(date);
      const rec = window.__recordMap ? window.__recordMap[date] : null;
      const isLock = isLocked(date);
      saveScroll();
      if (t === 'missing') insertInlinePanelFor(anchorLi, date, 'add');
      else if (t === 'off') insertInlinePanelFor(anchorLi, date, 'off');
      else if (t === 'paid') insertInlinePanelFor(anchorLi, date, 'paid');
      else if (t !== 'work') insertInlinePanelFor(anchorLi, date, isLock ? 'locked' : 'ignore');
      else insertInlinePanelFor(anchorLi, date, 'work', rec);
      restoreScroll();
    }

    function createListLabelElement() {
      const listLabel = document.createElement('li');
      listLabel.id = 'listLabelItem';
      listLabel.className = 'month-divider';
      const listLabelBox = document.createElement('div');
      listLabelBox.id = 'listLabelBox';
      listLabelBox.innerHTML = `
            <span style="min-width: 4.5em; max-width: 4.5em; width: 4.5em; flex-shrink: 0; flex-grow: 0; text-align: center;">日付</span>
            <div style="display: flex; flex: 1 1 0%; justify-content: space-between; gap: 0; margin-right: 0em;">
              <div class="record-col">
                <span style="min-width: 3.5em; flex: 1 1 0%; text-align: center;">始業</span>
              </div>
              <div class="record-col">
                <span style="min-width: 3.5em; flex: 1 1 0%; text-align: center;">終業</span>
              </div>
              <div class="record-col">
                <span style="min-width: 3.5em; flex: 1 1 0%; text-align: center;">休憩</span>
              </div>
              <div class="record-col">
                <span style="min-width: 3.5em; flex: 1 1 0%; text-align: center;">労働</span>
              </div>
              <div class="record-col">
                <span style="min-width: 3.5em; flex: 1 1 0%; text-align: center;">車距離</span>
              </div>
            </div>
          `;
      listLabel.appendChild(listLabelBox);
      return listLabel;
    }

    function createMonthDividerElement(monthPart) {
      const [yy, mm] = monthPart.split('-');
      const monthLi = document.createElement('li');
      monthLi.id = `month-divider-${monthPart}`;
      monthLi.className = 'month-divider';
      monthLi.textContent = `${yy}年${parseInt(mm, 10)}月`;
      return monthLi;
    }

    function appendMonthDividerIfNeeded(monthPart, currentMonth, listLabel) {
      if (monthPart === currentMonth) return currentMonth;
      const nextMonth = monthPart;
      const monthLi = createMonthDividerElement(monthPart);
      recordList.appendChild(monthLi);
      const monthLiHeight = monthLi.clientHeight;
      const lb = document.getElementById('listLabelItem');
      if (!lb) recordList.appendChild(listLabel);
      else lb.style.top = monthLiHeight + 'px';
      return nextMonth;
    }

    function buildNonWorkTimesHTML(date, t) {
      let timesHTML = `
                            <div class="record-col">
                              <div class="value"></div>
                            </div>
                            <div class="record-col">
                              <div class="value"></div>
                            </div>
                            <div class="record-col">
                              <div class="value"></div>
                            </div>`;
      if (t === 'missing') {
        const locked = isLocked(date);
        timesHTML = `
                    <div class="record-col" style="min-width:unset">
                      <div class="value" style="color:#e65100;display:flex;flex-direction:row;align-items:center;gap:4px;min-width:unset">（未）
                        <button type='button' class='mini-add-btn' data-date='${date}' style='font-size:.55em;padding:2px 6px;border:1px solid #1976d2;border-radius:4px;background:#fff;color:#1976d2;cursor:pointer;'>＋</button>
                        <button type='button' class='mini-off-btn' id='off-${date}' data-date='${date}' ${locked ? 'disabled title="ロック中"' : ''} style='font-size:.55em;padding:2px 6px;border:1px solid #ef9a9a;border-radius:4px;background:#fff;color:#c62828;cursor:pointer;white-space:nowrap'>全休</button>
                      </div>
                    </div>
                    <div class="record-col">
                      <div class="value"></div>
                    </div>
                    <div class="record-col">
                      <div class="value"></div>
                    </div>
                    <div class="record-col">
                      <div class="value"></div>
                    </div>`;
      } else if (t === 'paid') {
        const info = window.__paidLeave[date];
        const hrs = info ? info.hours : null;
        const reason = info && info.reason ? info.reason : '';
        timesHTML = `
        <div class='record-col'>
          <div class='value' style='color:#1b5e20;font-size:.8em;display:flex;flex-direction:column;align-items:center;gap:2px;'>${hrs ? hrs + 'h' : ''}${reason ? `<span style='font-size:.55em;color:#2e7d32;'>${escapeHtml(reason)}</span>` : ''}</div>
        </div>
        <div class='record-col'>
          <div class='value'></div>
        </div>
        <div class='record-col'>
          <div class='value'></div>
        </div>
        <div class='record-col'>
          <div class='value'></div>
        </div>`;
      }
      return timesHTML;
    }

    function buildNonWorkRowHTML(date, spanDate, t) {
      const badgeSt = (window.__dayStatuses[date]?.status) || 'work';
      const timesHTML = buildNonWorkTimesHTML(date, t);
      const badgeCode = t === 'paid' ? 'paid' : badgeSt;
      return `
                        <div class="record-main">
                          <span class="record-date">${spanDate}<br>
                            <span class="day-status-badge" data-st="${badgeCode}" title="${t === 'paid' ? ('有給' + (window.__paidLeave[date]?.reason ? ('\n' + escapeHtml(window.__paidLeave[date].reason)) : '')) : badgeTitle(date)}">${t === 'paid' ? '有給' : statusLabel(badgeSt)}${t === 'paid' ? '' : `<span class="src-flag">${(window.__dayStatuses[date]?.source === 'override') ? 'O' : ''}</span>`}
                            </span>
                          </span>
                          <div class="record-times">${timesHTML}</div>
                        </div>`;
    }

    function buildWorkRowHTML(date, spanDate, rec) {
      const workMin = calcWorkMin(rec?.clockIn, rec?.clockOut, rec?.breaks || []);
      const workStr = workMin ? `${Math.floor(workMin / 60)}:${(workMin % 60).toString().padStart(2, '0')}` : '';
      const baseMin = Number(settings.work_hours) * 60 + Number(settings.work_minutes);
      let overStr = '';
      if (workMin > baseMin) {
        const overMin = workMin - baseMin;
        overStr = ` <span style='color:#e57373;font-weight:bold;'>（+${Math.floor(overMin / 60)}:${(overMin % 60).toString().padStart(2, '0')}）</span>`;
      }
      return `
            <div class="record-main">
                <span class="record-date">${spanDate}<br><span class="day-status-badge" data-st="${(window.__dayStatuses[date]?.status) || 'work'}" title="${badgeTitle(date)}">${statusLabel((window.__dayStatuses[date]?.status) || 'work')}<span class="src-flag">${(window.__dayStatuses[date]?.source === 'override') ? 'O' : ''}</span></span></span>
                <div class="record-times">
                    <div class="record-col"><div class="value">${formatTime(rec?.clockIn)}</div></div>
                    <div class="record-col"><div class="value">${formatTime(rec?.clockOut)}</div></div>
                    <div class="record-col"><div class="value">${Math.floor(calcTotalBreak(rec?.breaks || []))}<span style="font-size:0.5em;">分</span></div></div>
                    <div class="record-col"><div class="value">${workStr}${overStr}</div></div>
                    <div class="record-col"><div class="value">${rec?.vehicleDistance ?? 0}<span style="font-size:0.5em;">km</span></div></div>
                </div>
            </div>`;
    }

    function buildRecordRowElement(date) {
      const rec = window.__recordMap ? window.__recordMap[date] : null;
      const t = dayType(date);
      const li = document.createElement('li');
      li.className = 'record-row';
      li.dataset.date = date;
      const spanDate = formatDateDAtoSpan(formatDateDA(date));
      if (t !== 'work') {
        li.innerHTML = buildNonWorkRowHTML(date, spanDate, t);
      } else {
        li.innerHTML = buildWorkRowHTML(date, spanDate, rec);
      }
      li.onclick = () => openInlinePanelForDate(li, date);
      return li;
    }

    function openHighlightedDateIfAny(liByDate) {
      if (!window.__highlightDate) return;
      const targetDate = window.__highlightDate;
      const anchor = liByDate.get(targetDate);
      if (!anchor) return;
      // ハイライト解除でフィルタに埋もれないよう、forceVisibleへ移す
      window.__forceVisibleDate = targetDate;
      requestAnimationFrame(() => {
        try {
          openInlinePanelForDate(anchor, targetDate);
        } catch (_) { }
        window.__highlightDate = null;
      });
    }

    function restorePreservedScrollY(preservedY) {
      if (preservedY === null) return;
      try {
        const sa = document.querySelector('.scroll-area');
        if (sa && typeof sa.scrollTo === 'function') {
          sa.scrollTo({ top: preservedY });
        } else if (sa) {
          sa.scrollTop = preservedY;
        } else {
          window.scrollTo({ top: preservedY });
        }
      } catch (_) {
        try {
          const sa2 = document.querySelector('.scroll-area');
          if (sa2) sa2.scrollTop = preservedY;
          else window.scrollTo(0, preservedY);
        } catch (__e) { /* ignore */ }
      }
      window.__preserveScrollY = null;
    }

    function renderRows(dayList, listLabel) {
      const liByDate = new Map();
      let currentMonth = null; // YYYY-MM 単位で追跡し、変化時にヘッダー挿入
      (dayList || []).forEach((d) => {
        if (!passFilter(d)) return;
        const monthPart = d.slice(0, 7); // YYYY-MM
        currentMonth = appendMonthDividerIfNeeded(monthPart, currentMonth, listLabel);
        const li = buildRecordRowElement(d);
        recordList.appendChild(li);
        liByDate.set(d, li);
        // ハイライト対象日付ならクラス付与
        if (window.__highlightDate && d === window.__highlightDate) {
          li.classList.add('highlight');
        }
      });
      return liByDate;
    }

    function getPreservedScrollY() {
      return (typeof window.__preserveScrollY === 'number') ? window.__preserveScrollY : null;
    }

    function clearRecordList() {
      if (!recordList) return;
      recordList.innerHTML = '';
    }

    function postRender(liByDate, preservedY) {
      // ハイライト行の自動展開（旧 expandedIdx ではなくインライン展開に統一）
      openHighlightedDateIfAny(liByDate);
      restorePreservedScrollY(preservedY);
    }

    function render() {
      if (!recordList) return;
      const preservedY = getPreservedScrollY();
      clearRecordList();
      const dayList = window.__dayList || [];
      const listLabel = createListLabelElement();

      const liByDate = renderRows(dayList, listLabel);
      postRender(liByDate, preservedY);
    }
    // フィルタUI初期化（トグル）
    (function initListToggles() {
      const wrap = document.getElementById('listToggles');
      if (!wrap) return;
      syncToggleUI();
      wrap.addEventListener('click', (e) => {
        const btn = e.target.closest('.toggle-btn');
        if (!btn) return;
        const type = btn.getAttribute('data-type');
        toggleFilter(type);
      });
    })();
    // オーバーレイ制御
    const __overlayEl = document.getElementById('overlay');
    function showOverlay() { if (__overlayEl) __overlayEl.style.display = 'block'; }
    function hideOverlay() { if (__overlayEl) __overlayEl.style.display = 'none'; }
    function statusLabel(code) {
      const isFullTime = (typeof window.__fullTimeFlag === 'number') ? (window.__fullTimeFlag === 1) : true;
      switch (code) {
        case 'work': return '勤務';
        case 'off': return '全休';
        case 'am_off': return isFullTime ? '午前休' : '午前休（旧）';
        case 'pm_off': return isFullTime ? '午後休' : '午後休（旧）';
        case 'ignore': return '除外';
        default: return code;
      }
    }
    function badgeTitle(date) {
      const st = window.__dayStatuses[date];
      if (!st) return '勤務（既定）';
      let base = statusLabel(st.status);
      if (st.source === 'override') base += '（上書き）';
      if ((window.__fullTimeFlag === 0) && (st.status === 'am_off' || st.status === 'pm_off')) {
        base += '\n※ パートは半休区分の新規/変更不可（既存データのみ表示）';
      }
      if (st.note) base += `\n${st.note}`;
      return base;
    }
    function classificationControls(date) {
      // ロック判定: ロック期間内は表示しない
      if (isLocked(date)) return '';
      const current = (window.__dayStatuses[date]?.status) || 'work';
      const isFullTime = (typeof window.__fullTimeFlag === 'number') ? (window.__fullTimeFlag === 1) : true;
      // パートで現在 half-day が既に設定されている legacy ケース: 表示はするが警告とボタン抑制
      const legacyHalf = (!isFullTime && (current === 'am_off' || current === 'pm_off'));
      const opts = [
        { code: 'work', label: '勤務' },
        // パートは半休ボタンを表示しない
        ...(isFullTime ? [{ code: 'am_off', label: '午前休' }, { code: 'pm_off', label: '午後休' }] : []),
        { code: 'off', label: '全休' },
        { code: 'ignore', label: '除外' }
      ];
      let warn = '';
      if (legacyHalf) {
        warn = `<div class="legacy-warn" style="flex-basis:100%;font-size:.55em;color:#e65100;background:#fff3e0;padding:4px 6px;border:1px solid #ffb74d;border-radius:4px;">過去の半休区分（${current === 'am_off' ? '午前休' : '午後休'}）: パート区分では今後変更/新規指定できません。クリアまたは全休へ変更可能。</div>`;
      }
      return `<div class="classification-ui" data-date="${date}">
                    ${opts.map(o => `<button type="button" data-code="${o.code}" class="cls-btn ${o.code === current ? 'active' : ''}" ${legacyHalf && (o.code === 'am_off' || o.code === 'pm_off') ? 'disabled' : ''}>${o.label}</button>`).join('')}
                    <button type="button" data-clear="1" style="margin-left:6px;border:1px solid #b0bec5;background:#fafafa;color:#546e7a;">クリア</button>
                    ${warn}
                </div>`;
    }
    async function handleClassificationButtonClick(e) {
      const btn = e.target.closest('.classification-ui button.cls-btn');
      if (!btn) return false;

      const wrap = btn.closest('.classification-ui');
      const date = wrap?.getAttribute('data-date');
      const code = btn.getAttribute('data-code');
      if (!date || !code) return true;

      if (code === 'work') {
        await classifyClear(date);
      } else {
        const apiCode = (code === 'off')
          ? 'off_full'
          : (code === 'am_off')
            ? 'off_am'
            : (code === 'pm_off')
              ? 'off_pm'
              : (code === 'ignore')
                ? 'ignore'
                : 'working';
        await classifySet(date, apiCode);
      }
      return true;
    }

    async function handleClassificationClearClick(e) {
      const clr = e.target.closest('.classification-ui button[data-clear="1"]');
      if (!clr) return false;

      const wrap = clr.closest('.classification-ui');
      const date = wrap?.getAttribute('data-date');
      if (!date) return true;

      await classifyClear(date);
      return true;
    }

    async function handleMiniOffClick(e) {
      const offBtn = e.target.closest('.mini-off-btn');
      if (!offBtn) return false;

      // 欠落行: 全休クイックボタン（行クリック等への影響を避けるため既存と同様 stopPropagation）
      e.stopPropagation();
      const date = offBtn.getAttribute('data-date');
      if (!date) return true;
      if (offBtn.disabled) return true;

      await classifySet(date, 'off_full');
      hideOverlay();
      return true;
    }

    // 分類ボタンのイベント委譲
    document.addEventListener('click', async (e) => {
      if (await handleClassificationButtonClick(e)) return;
      if (await handleClassificationClearClick(e)) return;
      if (await handleMiniOffClick(e)) return;
    });
    async function classifySet(date, overrideCode) {
      try {
        const res = await fetchWithAuth('api/day_status_self_set.php', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ date, status: overrideCode }) });
        if (res && res.ok) {
          const monthVal = getSelectedMonthVal();
          await loadRecordsByPeriod(monthVal);
        } else { alert('区分変更に失敗しました'); }
      } catch (e) { alert('区分変更エラー'); }
    }
    async function classifyClear(date) {
      try {
        const res = await fetchWithAuth('api/day_status_self_clear.php', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ date }) });
        if (res && res.ok) {
          const monthVal = getSelectedMonthVal();
          await loadRecordsByPeriod(monthVal);
        } else { alert('クリアに失敗しました'); }
      } catch (e) { alert('クリアエラー'); }
    }
    function isLocked(date) {
      if (!window.__lockedRanges) return false;
      for (const r of window.__lockedRanges) {
        if (date >= r.start && date <= r.end) return true;
      }
      return false;
    }
    function formatDateDA(dateStr) {
      // "YYYY-MM-DD" → "DD日（曜）"（月は月ヘッダーで表示）
      if (!dateStr) return '';
      const parts = dateStr.split('-');
      if (parts.length !== 3) return dateStr;
      const day = parseInt(parts[2], 10);
      const wd = ['日', '月', '火', '水', '木', '金', '土'][new Date(dateStr).getDay()];
      return `${day}日（${wd}）`;
    }

    function formatDateDAtoSpan(dateStr) {
      // dd日（曜）を受け取って分解し"dd<span style="font-size:0.5em;">日</span><（曜）"にする
      if (!dateStr) return '';
      const match = dateStr.match(/^(\d{1,2})(日)(（.）)$/);
      if (!match) {
        return dateStr;
      }
      return `<span style="font-size:1.1em;">${match[1]}</span><span style="font-size:0.5em;">日</span><span style="font-size:0.8em;">${match[3]}</span> `;
    }
    // 年月をタイトル左に表示
    function setYearLabel() {
      const monthInput = document.getElementById('monthSelect');
      if (monthInput && monthInput.value) {
        const [yy, mm] = monthInput.value.split('-');
        setTextById('yearLabel', `${yy}年${parseInt(mm, 10)}月度 `);
        return;
      }
      if (records.length > 0) {
        const ymd = records[0].date ? records[0].date.split('-') : [];
        if (ymd.length === 3) {
          setTextById('yearLabel', `${ymd[0]}年${parseInt(ymd[1], 10)}月度 `);
        } else {
          setTextById('yearLabel', '');
        }
      } else {
        setTextById('yearLabel', '');
      }
    }
    // 初回ロード
    (async function () {
      // 戻り導線の初期化＆ボタン描画
      initBackNavFromUrl();
      await loadSettings();
      const now = new Date();
      const pad = n => n.toString().padStart(2, '0');
      const thisYm = `${now.getFullYear()}-${pad(now.getMonth() + 1)}`;
      const monthInput = document.getElementById('monthSelect');
      if (!monthInput) return;
      monthInput.addEventListener('change', function () { loadRecordsByPeriod(this.value); });
      // クエリ: 指定日があればその年月に合わせて初期ロードし、新規追加パネルを開く
      const urlParams = new URLSearchParams(window.location.search);
      const qpDate = urlParams.get('date');
      var targetYM = '';
      if (qpDate && /\d{4}-\d{2}-\d{2}/.test(qpDate)) {
        // ダッシュボードなどからの指定日遷移: ハイライト→自動展開（render 内で処理）
        window.__highlightDate = qpDate;
        // フィルタに関わらず対象日を表示させる（パネルが開くまで維持）
        window.__forceVisibleDate = qpDate;
        targetYM = calculateDisplayMonthFromDate(qpDate);
        // 自動展開後はレンダ側でスクロール＆オーバーレイ表示を実施
      } else {
        // 通常表示
        const dayNum = now.getDate();
        const year = now.getFullYear();
        const month = now.getMonth() + 1;
        const dateStr = `${year}-${pad(month)}-${pad(dayNum)}`;
        let displayMonth = month;
        targetYM = calculateDisplayMonthFromDate(dateStr);
      }
      monthInput.value = targetYM;
      await loadRecordsByPeriod(targetYM);
      renderBackButton();
    })();

    // 入力日から表示対象月を計算して返す （YYYY-MM形式）
    // period_endの属する月を基準に表示月を決定する変則月度式
    // dateStr.getDate()が1日～settings.period_endまでは当月度表示
    // dateStr.getDate()がsettings.period_endより大きければ翌月度表示
    // 例: 2024-05-15, period_end=20 → 2024-05
    //     2024-05-25, period_end=20 → 2024-06
    function calculateDisplayMonthFromDate(dateStr) {
      const parts = dateStr.split('-');
      if (parts.length !== 3) return null;
      const year = parseInt(parts[0], 10);
      const month = parseInt(parts[1], 10);
      const day = parseInt(parts[2], 10);
      const periodEnd = Number(settings.period_end || 0);
      let displayYear = year;
      let displayMonth = month;
      if (day > periodEnd) {
        // 翌月表示
        displayMonth += 1;
        if (displayMonth > 12) {
          displayMonth = 1;
          displayYear += 1;
        }
      }
      return `${displayYear}-${displayMonth.toString().padStart(2, '0')}`;
    }

    function adjustScrollAreaHeight() {
      const body = document.body;
      const header = document.querySelector('.fixed-header');
      const footer = document.querySelector('.fixed-footer');
      const container = document.querySelector('.container');
      const scrollArea = document.querySelector('.scroll-area');
      // ヘッダー・フッターの実際の高さを取得
      const headerH = header ? header.getBoundingClientRect().height : 0;
      const footerH = footer ? footer.getBoundingClientRect().height : 0;
      const vh = body.clientHeight;
      // 実際の高さで計算
      //const headerPaddingVert = header ? (parseInt(getComputedStyle(header).paddingTop, 10) || 0) + (parseInt(getComputedStyle(header).paddingBottom, 10) || 0) : 0;
      //const footerPaddingVert = footer ? (parseInt(getComputedStyle(footer).paddingTop, 10) || 0) : 0;
      // マージン・パディングを考慮した最大高さ
      const maxH = vh - headerH - footerH;
      scrollArea.style.maxHeight = maxH + 'px';
      scrollArea.style.height = maxH + 'px';
    }
    window.addEventListener('resize', adjustScrollAreaHeight);

    // 管理者メニュー表示切り替え
    fetch('api/check_login.php')
      .then(res => res.json())
      .then(data => {
        const isAdmin = !!data.is_admin;
        if (isAdmin) document.body.classList.add('is-admin');
        const menuAdmin = document.getElementById('menuAdmin');
        if (menuAdmin) menuAdmin.style.display = isAdmin ? 'block' : 'none';
      });

    // 有給申請モーダル（最小実装）
    function createModalBase({ id, innerHTML }) {
      const old = document.getElementById(id);
      if (old) old.remove();

      const modal = document.createElement('div');
      modal.id = id;
      modal.style = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);z-index:1000;display:flex;align-items:center;justify-content:center;';
      modal.innerHTML = innerHTML;
      return modal;
    }

    function buildPaidLeaveModalHTML({ defaultDate, defaultHours }) {
      return `
        <div style="background:#fff;padding:1.2em 1.2em 1em 1.2em;border-radius:8px;box-shadow:0 2px 16px #0002;min-width:280px;max-width:92vw;">
          <div style='font-size:1.2em;margin-bottom:0.8em;color:#1976d2;font-weight:bold;'>有給申請</div>
          <div style='display:grid;row-gap:0.6em;'>
            <label>日付 <input id='plDate' type='date' value='${defaultDate}' style='font-size:1.2em;'></label>
            <label>時間（h） <input id='plHours' type='number' min='0.25' step='0.25' value='${defaultHours}' style='font-size:1.2em;width:6.5em;text-align:right;'> h</label>
            <label>理由（任意）<textarea id='plReason' rows='3' style='width:100%;font-size:1em;'></textarea></label>
            <div id='plMsg' style='min-height:1.2em;color:#e53935;'></div>
          </div>
          <div style='margin-top:0.8em;display:flex;gap:0.8em;justify-content:flex-end;'>
            <button id='plCancelBtn' class='footer-btn' style='background:#b0bec5;'>キャンセル</button>
            <button id='plSubmitBtn' class='footer-btn'>申請する</button>
          </div>
        </div>`;
    }

    function readPaidLeaveForm(modalEl) {
      const plDate = modalEl.querySelector('#plDate');
      const plHours = modalEl.querySelector('#plHours');
      const plReason = modalEl.querySelector('#plReason');

      const used_date = plDate ? plDate.value : '';
      const hours = Number(plHours ? plHours.value : NaN);
      const reason = (plReason ? plReason.value : '').trim();

      return { used_date, hours, reason };
    }

    function validatePaidLeaveForm(values) {
      if (!values.used_date) return '日付を入力してください';
      if (!(values.hours > 0)) return '時間は0より大きい数で入力してください';
      return null;
    }

    async function submitPaidLeave(values) {
      const res = await fetchWithAuth('api/leave_requests_create.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(values)
      });
      if (!res) throw new Error('未ログインまたはアクセス権限がありません');
      const data = await res.json().catch(() => ({}));
      if (!res.ok || !data || data.error) throw new Error((data && data.error) || '申請に失敗しました');
      return data;
    }

    function bindPaidLeaveModalHandlers(modalEl) {
      const plMsg = modalEl.querySelector('#plMsg');
      const plSubmitBtn = modalEl.querySelector('#plSubmitBtn');
      const plCancelBtn = modalEl.querySelector('#plCancelBtn');

      if (plCancelBtn) plCancelBtn.onclick = () => modalEl.remove();
      if (plSubmitBtn) {
        plSubmitBtn.onclick = async () => {
          if (plMsg) {
            plMsg.style.color = '#e53935';
            plMsg.textContent = '';
          }

          const values = readPaidLeaveForm(modalEl);
          const err = validatePaidLeaveForm(values);
          if (err) {
            if (plMsg) plMsg.textContent = err;
            return;
          }

          // 送信
          if (plSubmitBtn) plSubmitBtn.disabled = true;
          if (plCancelBtn) plCancelBtn.disabled = true;
          if (plMsg) {
            plMsg.style.color = '#1976d2';
            plMsg.textContent = '送信中…';
          }
          try {
            const data = await submitPaidLeave(values);
            if (plMsg) {
              plMsg.style.color = '#2e7d32';
              plMsg.textContent = data.notified ? '申請を送信しました（承認者へ通知しました）。' : '申請を送信しました。';
            }
            setTimeout(() => modalEl.remove(), 1200);
          } catch (err2) {
            if (plMsg) {
              plMsg.style.color = '#e53935';
              plMsg.textContent = err2 && err2.message ? err2.message : 'エラーが発生しました';
            }
            if (plSubmitBtn) plSubmitBtn.disabled = false;
            if (plCancelBtn) plCancelBtn.disabled = false;
          }
        };
      }
    }

    function showPaidLeaveModal() {
      const monthVal = getSelectedMonthVal(); // YYYY-MM
      const defaultDate = getInitialAddDate(monthVal);
      const defaultHours = (Number(settings.work_hours || 0) + Number(settings.work_minutes || 0) / 60) || 8;

      const modal = createModalBase({
        id: 'paidLeaveModal',
        innerHTML: buildPaidLeaveModalHTML({ defaultDate, defaultHours })
      });
      document.body.appendChild(modal);
      bindPaidLeaveModalHandlers(modal);
    }

    const paidLeaveBtn = document.getElementById('paidLeaveBtn');
    if (paidLeaveBtn) paidLeaveBtn.addEventListener('click', showPaidLeaveModal);

    // --- アプリ内通知（ハンバーガーバッジ） ---
    async function refreshNotifCount() {
      try {
        const res = await fetchWithAuth('api/notifications_get.php?only_unread=1');
        if (!res) return;
        const data = await res.json();
        if (data && data.ok) {
          const unread = Number(data.unread || 0);
          const badge = document.getElementById('menuNotifBadge');
          if (badge) {
            if (unread > 0) {
              badge.style.display = 'inline-block';
              badge.textContent = unread > 99 ? '99+' : String(unread);
            } else {
              badge.style.display = 'none';
              badge.textContent = '';
            }
          }
        }
      } catch (e) { }
    }
    async function fetchNotifications({ onlyUnread } = {}) {
      const url = onlyUnread ? 'api/notifications_get.php?only_unread=1' : 'api/notifications_get.php';
      const res = await fetchWithAuth(url);
      if (!res) throw new Error('auth');
      return await res.json().catch(() => ({}));
    }

    function createNotifModalShell() {
      const old = document.getElementById('notifModal');
      if (old) old.remove();

      const wrap = document.createElement('div');
      wrap.id = 'notifModal';
      wrap.style = 'position:fixed;inset:0;background:rgba(0,0,0,.25);display:flex;align-items:center;justify-content:center;z-index:10000;';
      wrap.innerHTML = `
                <div style='background:#fff;border-radius:8px;box-shadow:0 2px 16px #0002;min-width:280px;max-width:90vw;max-height:80vh;overflow:auto;'>
                  <div style='padding:0.8em 1em;border-bottom:1px solid #eee;color:#1976d2;font-weight:bold;'>お知らせ</div>
                  <div id='notifList' style='padding:0.6em 1em;min-width:260px;'></div>
                  <div style='padding:0.6em 1em;display:flex;gap:0.6em;justify-content:flex-end;'>
                    <button id='markRead' class='footer-btn'>すべて既読</button>
                    <button id='closeNotif' class='footer-btn' style='background:#b0bec5;'>閉じる</button>
                  </div>
                </div>`;
      document.body.appendChild(wrap);
      return wrap;
    }

    function renderNotificationsList(containerEl, items) {
      containerEl.innerHTML = '';
      (items || []).forEach(it => {
        const div = document.createElement('div');
        div.style = 'border-bottom:1px solid #eee;padding:0.5em 0;';
        const title = `<div style="font-weight:600;color:#333;">${escapeHtml(it.title || '')}</div>`;
        const body = it.body ? `<div style="color:#555;margin-top:2px;">${escapeHtml(it.body).replace(/\n/g, '<br>')}</div>` : '';
        const link = it.link ? `<div style="margin-top:4px;"><a href="${it.link}" target="_blank">開く</a></div>` : '';
        const readBtn = it.status === 'unread'
          ? `<div class="notif-unread">
              <button class="mark-one" data-id="${it.id}">既読</button>
              <span class="state" style="font-size:0.85em;color:#e53935;">未読</span>
            </div>`
          : `<div style="margin-top:6px;">
              <span class="state" style="font-size:0.85em;color:#777;">既読</span>
            </div>`;
        div.innerHTML = title + body + link + `<div style="color:#999;font-size:0.85em;margin-top:2px;">${it.created_at || ''}</div>` + readBtn;
        containerEl.appendChild(div);
      });
      if (!containerEl.innerHTML) containerEl.textContent = '通知はありません';
    }

    async function markNotificationRead(id) {
      const res = await fetchWithAuth('api/notifications_read.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ids: [id] })
      });
      if (!res) throw new Error('auth');
      const data = await res.json().catch(() => ({}));
      if (!res.ok || !data || data.error) throw new Error('failed');
      return data;
    }

    async function markAllNotificationsRead() {
      await fetchWithAuth('api/notifications_read.php', { method: 'POST' });
    }

    function bindNotifModalHandlers(modalEl) {
      const closeBtn = modalEl.querySelector('#closeNotif');
      const markReadBtn = modalEl.querySelector('#markRead');
      const list = modalEl.querySelector('#notifList');

      if (closeBtn) closeBtn.onclick = () => modalEl.remove();
      if (markReadBtn) {
        markReadBtn.onclick = async () => {
          await markAllNotificationsRead();
          await refreshNotifCount();
          modalEl.remove();
        };
      }

      if (list) {
        list.addEventListener('click', async (ev) => {
          const btn = ev.target.closest('button.mark-one');
          if (!btn) return;

          const id = Number(btn.getAttribute('data-id'));
          btn.disabled = true;
          try {
            await markNotificationRead(id);
            const container = btn.closest('div');
            if (container) {
              const state = container.querySelector('.state');
              if (state) { state.textContent = '既読'; state.style.color = '#777'; }
            }
            btn.remove();
            await refreshNotifCount();
          } catch (err) {
            btn.disabled = false;
            alert('既読にできませんでした');
          }
        });
      }
    }

    async function openNotifModal() {
      const wrap = createNotifModalShell();
      bindNotifModalHandlers(wrap);
      try {
        const data = await fetchNotifications({ onlyUnread: false });
        const list = wrap.querySelector('#notifList');
        if (list) renderNotificationsList(list, data.items);
      } catch (e) { }
    }
    function escapeHtml(s) { const m = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }; return String(s || '').replace(/[&<>"']/g, c => m[c]); }

    (function startNotif() { refreshNotifCount(); setInterval(refreshNotifCount, 60000); })();

    // --- ハンバーガーメニュー動作 ---
    const menuToggle = document.getElementById('menuToggle');
    const sideMenu = document.getElementById('sideMenu');
    const menuOverlay = document.getElementById('menuOverlay');
    const menuOpenNotif = document.getElementById('menuOpenNotif');

    // --- フォーカストラップ用ユーティリティ ---
    let previousFocusedElement = null;
    function getFocusableElements(container) {
      const selectors = [
        'a[href]',
        'button:not([disabled])',
        'input:not([disabled])',
        'select:not([disabled])',
        'textarea:not([disabled])',
        '[tabindex]:not([tabindex="-1"])'
      ].join(',');
      return Array.from(container.querySelectorAll(selectors))
        .filter(el => el.offsetParent !== null || el === document.activeElement);
    }
    function focusFirstInMenu() {
      const focusables = getFocusableElements(sideMenu);
      if (focusables.length > 0) {
        focusables[0].focus();
      } else {
        sideMenu.focus();
      }
    }
    function trapFocusKeydown(e) {
      if (!sideMenu.classList.contains('open')) return;
      if (e.key !== 'Tab') return;
      const focusables = getFocusableElements(sideMenu);
      if (focusables.length === 0) { e.preventDefault(); sideMenu.focus(); return; }
      const first = focusables[0];
      const last = focusables[focusables.length - 1];
      const active = document.activeElement;
      if (e.shiftKey) {
        if (active === first || !sideMenu.contains(active)) {
          e.preventDefault();
          last.focus();
        }
      } else {
        if (active === last || !sideMenu.contains(active)) {
          e.preventDefault();
          first.focus();
        }
      }
    }
    function openMenu() {
      sideMenu.classList.add('open');
      menuOverlay.style.display = 'block';
      menuToggle.setAttribute('aria-expanded', 'true');
      sideMenu.setAttribute('aria-hidden', 'false');
      // A11y: 初期フォーカスとトラップ
      previousFocusedElement = document.activeElement;
      sideMenu.setAttribute('role', 'dialog');
      sideMenu.setAttribute('aria-modal', 'true');
      focusFirstInMenu();
      document.addEventListener('keydown', trapFocusKeydown, true);
    }
    function closeMenu() {
      sideMenu.classList.remove('open');
      menuOverlay.style.display = 'none';
      menuToggle.setAttribute('aria-expanded', 'false');
      sideMenu.setAttribute('aria-hidden', 'true');
      sideMenu.removeAttribute('aria-modal');
      sideMenu.removeAttribute('role');
      document.removeEventListener('keydown', trapFocusKeydown, true);
      // 直前のフォーカスへ戻す
      if (previousFocusedElement && document.contains(previousFocusedElement)) {
        previousFocusedElement.focus();
      } else {
        menuToggle.focus();
      }
    }
    menuToggle.addEventListener('click', () => {
      const expanded = menuToggle.getAttribute('aria-expanded') === 'true';
      expanded ? closeMenu() : openMenu();
    });
    menuOverlay.addEventListener('click', closeMenu);
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeMenu(); });
    if (menuOpenNotif) menuOpenNotif.onclick = () => { closeMenu(); openNotifModal(); };

    // ログアウト
    const menuLogout = document.getElementById('menuLogout');
    if (menuLogout) menuLogout.onclick = async function () {
      await fetchWithAuth('api/logout.php', { method: 'POST' });
      window.location.href = 'login.html';
    };

    function refreshAfterLeaveChange() {
      try {
        const monthVal = getSelectedMonthVal();
        if (typeof refreshFlexSummary === 'function') refreshFlexSummary(monthVal);
        if (typeof loadPaidLeaveHistory === 'function') loadPaidLeaveHistory();
      } catch (e) { }
    }

    // 承認完了後の再取得ハンドリング
    function handleApprovalRefresh() {
      try {
        const params = new URLSearchParams(location.search);
        const decided = params.get('leave_decided');
        if (decided === '1') {
          // 軽いトースト
          try { console.log('有給申請の承認が反映されました'); } catch (e) { }
          // フレックスサマリと有給履歴を再取得
          refreshAfterLeaveChange();
        }
      } catch (e) { }
    }

    // フォーカス復帰時にも最新化（承認画面から戻ったケース）
    window.addEventListener('focus', () => {
      refreshAfterLeaveChange();
    });

    // SSE接続（可視時のみ）
    let sse;
    function createEventSource() {
      return new EventSource('api/events_stream.php?timeout=60');
    }

    function scheduleReconnect() {
      if (document.hidden) return;
      setTimeout(connectSSE, 1500);
    }

    function bindSseHandlers(es) {
      es.addEventListener('heartbeat', () => { });

      es.addEventListener('leave_request_decided', (ev) => {
        try {
          JSON.parse(ev.data || '{}');
          // 承認/却下結果に応じて必要な再取得のみ実施
          refreshAfterLeaveChange();
        } catch (e) { }
      });

      es.addEventListener('paid_leave_updated', () => {
        try {
          refreshAfterLeaveChange();
        } catch (e) { }
      });

      es.addEventListener('end', () => {
        try { es.close(); } catch (e) { }
        // 可視時は再接続（ブラウザの自動再接続を補完）
        scheduleReconnect();
      });
    }

    function connectSSE() {
      if (document.hidden) return;
      try {
        try { if (sse) sse.close(); } catch (e) { }
        const es = createEventSource();
        bindSseHandlers(es);
        sse = es;
      } catch (e) { }
    }

    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        try { if (sse) sse.close(); } catch (e) { }
      } else {
        connectSSE();
      }
    });

    function initOnDomReady() {
      try { adjustScrollAreaHeight(); } catch (_) { }
      try { handleApprovalRefresh(); } catch (_) { }
      try { connectSSE(); } catch (_) { }
    }

    document.addEventListener('DOMContentLoaded', initOnDomReady);
  </script>
</body>

</html>