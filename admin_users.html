<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ユーザーアカウント管理</title>
    <style>
        body {
            font-family: "Segoe UI", sans-serif;
            background: #f5f6fa;
            margin: 0;
        }

        .container {
            max-width: 1000px;
            min-width: 700px;
            margin: 2rem auto;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 16px rgba(0, 0, 0, 0.08);
            padding: 2.5rem 1.5rem;
        }

        h2 {
            text-align: center;
            color: #1976d2;
            margin-bottom: 2rem;
        }

        .search-box {
            margin-bottom: 1.5em;
        }

        .user-table {
            width: 100%;
            max-width: 1000px;
            min-width: 700px;
            border-collapse: collapse;
            margin-bottom: 2em;
        }

        th,
        td {
            border: 1px solid #e0e0e0;
            padding: 0.5em 0.7em 0.5em 0.7em;
            text-align: left;
        }

        .editing {
            padding: 0.5em 0;
        }

        th {
            background: #e3f2fd;
        }

        td input,
        td select {
            width: 100%;
            box-sizing: border-box;
            font-size: 1.1em;
        }

        input {
            width: 90%;
        }

        tr:nth-child(even) {
            background: #f7fafd;
        }

        .btn {
            background: #1976d2;
            color: #fff;
            border: none;
            border-radius: 4px;
            padding: 0.3em 1em;
            cursor: pointer;
        }

        .btn:active {
            background: #1565c0;
        }

        /* 展開行 */
        .expand-toggle {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.1em;
            padding: 0.2em 0.4em;
            color: #1976d2;
        }
        .expanded-row td {
            background: #fbfdff;
            padding: 1rem;
        }
        .tabs {
            display: flex;
            gap: 8px;
            border-bottom: 1px solid #e0e0e0;
            margin-bottom: 0.8rem;
        }
        .tab-btn {
            background: #eef6ff;
            border: 1px solid #cfe2f3;
            color: #1976d2;
            border-radius: 6px 6px 0 0;
            padding: 6px 10px;
            cursor: pointer;
        }
        .tab-btn.active {
            background: #fff;
            border-bottom-color: #fff;
            font-weight: 600;
        }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }
        .grid {
            display: grid;
            grid-template-columns: 200px 1fr;
            gap: 10px 12px;
            align-items: center;
            max-width: 800px;
        }
        .field-note { color: #666; font-size: 0.9em; }
        .inline { display: inline-flex; align-items: center; gap: 8px; }
        .muted { color: #666; }
        .danger { color: #d32f2f; }

        .add-user-row {
            background: #f1f8e9;
        }

        .add-user-row input {
            width: 90%;
        }

        .toggle {
            position: relative;
            display: inline-block;
            width: 66px;
            height: 36px;
            vertical-align: middle;
        }

        .toggle__input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle__slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.4s;
            border-radius: 30px;
        }

        .toggle__slider:before {
            border-radius: 50%;
            position: absolute;
            content: "";
            height: 30px;
            width: 30px;
            left: 3px;
            bottom: 3px;
            background: #fff;
            transition: 0.3s;
            box-shadow: 0 0 1px rgba(0, 0, 0, 0.5);
        }

        .toggle__input:checked+.toggle__slider {
            background: #86f096;
        }

        .toggle__input:checked+.toggle__slider:before {
            transform: translateX(30px);
        }

        @media (max-width: 600px) {
            .container {
                padding: 1rem 0.2rem;
            }

            .user-table,
            th,
            td {
                font-size: 0.95em;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div style="text-align: right; margin-bottom: 0.7em">
            <button
                class="btn"
                onclick="location.href='admin.html'"
                style="background: #fff; color: #1976d2; border: 1.5px solid #1976d2"> メニューへ戻る </button>
        </div>
        <h2>ユーザーアカウント管理</h2>
        <div
            class="search-box"
            style="display: flex; align-items: center; gap: 1em">
            <select
                id="userSearch"
                style="
            padding: 0.4em 1em;
            width: 220px;
            font-size: 1.1em;
            border-radius: 4px;
            border: 1px solid #b0bec5;
          ">
                <option value="">全ユーザー</option>
            </select>
            <button class="btn" id="addUserBtn">＋新規ユーザー</button>
            <div style="flex: 1; text-align: right">
                <label class="toggle" for="showDeletedToggle">
                    <input
                        type="checkbox"
                        class="toggle__input"
                        id="showDeletedToggle" />
                    <span class="toggle__slider"></span>
                </label>
                <label
                    for="showDeletedToggle"
                    style="cursor: pointer; user-select: none"> 削除したユーザーの表示</label>
            </div>
        </div>
        <table class="user-table" id="userTable">
            <colgroup>
                <col style="width: 2em" />
                <col style="width: 1.5em" />
                <col style="width: 6em" />
                <col style="width: 4em" />
                <col style="width: 3.5em" />
                <col style="width: 4.5em" />
                <col style="width: 17em" />
            </colgroup>
            <thead>
                <tr>
                    <th></th>
                    <th>ID</th>
                    <th>ユーザー名</th>
                    <th>権限</th>
                    <th style="text-align: center;">自家用車</th>
                    <th style="text-align: right;">契約労働時間</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
                <!-- ユーザー一覧がここに挿入されます -->
            </tbody>
        </table>
    </div>
    <script>
        // fetchWithAuth: 401/403時は自動ログアウト
        async function fetchWithAuth(url, options) {
            const res = await fetch(url, options);
            if (res.status === 401 || res.status === 403) {
                window.location.href = "login.html";
                return null;
            }
            return res;
        }
        // 管理者権限チェック（URL直打ち対策）
        fetchWithAuth("api/check_login.php")
            .then((res) => res && res.json())
            .then((data) => {
                if (!data || !data.loggedIn) {
                    window.location.href = "login.html";
                } else if (!data.is_admin) {
                    alert("管理者権限がありません");
                    window.location.href = "punch.html";
                }
            });
        // ユーザー一覧取得
        async function loadUsers() {
            const res = await fetchWithAuth("api/admin_user_list.php");
            if (!res || !res.ok) return [];
            return await res.json();
        }
    let users = [];
    let allUsers = [];
    let editingIdx = null;
    let expandedUserId = null; // 展開中のユーザーID
    let mastersCache = null;   // マスターキャッシュ
        async function renderTable() {
            allUsers = await loadUsers();
            const showDeleted =
                document.getElementById("showDeletedToggle").checked;
            users = showDeleted
                ? allUsers
                : allUsers.filter((u) => u.visible === undefined || u.visible == 1);
            const userSearch = document.getElementById("userSearch");
            const prevSelectedId = userSearch.value;
            // 選択肢を再生成
            userSearch.innerHTML =
                '<option value="">全ユーザー</option>' +
                users
                    .map((u) => `<option value="${u.id}">${u.name}</option>`)
                    .join("");
            // 直前の選択値を復元（新規追加時やトグル切替時も）
            if (
                prevSelectedId &&
                userSearch.querySelector(`option[value="${prevSelectedId}"]`)
            ) {
                userSearch.value = prevSelectedId;
            } else {
                userSearch.value = "";
            }
            const selectedId = userSearch.value;
            const tbody = document.querySelector("#userTable tbody");
            tbody.innerHTML = "";
            users.forEach((u, idx) => {
                const roleLabel = u.role === "admin" ? "管理者" : "一般";
                const useVehicleLabel = u.use_vehicle == 1 ? "○" : "×";
                if (!selectedId || selectedId == u.id) {
                    const deletedStyle =
                        u.visible == 0 ? "color:#aaa;background:#fbe9e7;" : "";
                    const disabled = u.visible == 0 ? "disabled" : "";
                    if (editingIdx === idx) {
                        if (u.visible == 0) {
                            tbody.innerHTML += `
                            <tr style='${deletedStyle}'>
                                <td></td>
                                <td>
                                    ${u.id}
                                </td>
                                <td>
                                    <input value="${u.name}" id="editName" disabled>
                                </td>
                                <td>
                                    <select id="editRole" disabled>
                                        <option value="user" ${u.role === "user" ? "selected" : ""}>一般</option>
                                        <option value="admin" ${u.role === "admin" ? "selected" : ""}>管理者</option>
                                    </select>
                                </td>
                                <td style="width: -webkit-fill-available;">
                                    <input type="checkbox" id="editUseVehicle" ${u.use_vehicle == 1 ? "checked" : ""} disabled> 自家用車
                                </td>
                                <td>
                                    <input type="number" id="editContractHours" value="${u.contract_hours_per_day ?? 8}" min="0" step="0.25" disabled> h/日
                                </td>
                                <td>
                                    <button class='btn' onclick='restoreUser(${idx})'>復元</button>
                                    <button class='btn' onclick='cancelEditUser()'>キャンセル</button>
                                </td>
                            </tr>`;
                        } else {
                            tbody.innerHTML += `
                            <tr style='${deletedStyle}'>
                                <td></td>
                                <td>
                                    ${u.id}
                                </td>
                                <td class="editing">
                                    <input value="${u.name}" id="editName">
                                </td>
                                <td class="editing">
                                    <select id="editRole">
                                        <option value="user" ${u.role === "user" ? "selected" : ""}>一般</option>
                                        <option value="admin" ${u.role === "admin" ? "selected" : ""}>管理者</option>
                                    </select>
                                </td>
                                <td class="editing" style="padding: 0; width: -webkit-fill-available;">
                                    <input type="checkbox" id="editUseVehicle" style="margin: 0;" ${u.use_vehicle == 1 ? "checked" : ""}>
                                </td>
                                <td class="editing">
                                    <input type="number" style="ime-mode: disabled; width: 60px; text-align: end;" id="editContractHours" value="${u.contract_hours_per_day ?? 8}" min="0" step="0.25"> h/日
                                </td>
                                <td>
                                    <button class='btn' onclick='saveEditUser(${idx})'>保存</button>
                                    <button class='btn' onclick='cancelEditUser()'>キャンセル</button>
                                    <button class='btn' onclick='deleteUser(${idx})'>削除</button>
                                    <button class='btn' onclick='showSetPassword(${idx})'>パスワード再設定</button>
                                </td>
                            </tr>`;
                        }
                    } else {
                        tbody.innerHTML += `
                        <tr style='${deletedStyle}'>
                            <td style="text-align:center;">
                                <button class="expand-toggle" onclick="toggleExpand(${idx})" ${disabled}>
                                    ${expandedUserId === u.id ? '▼' : '▶'}
                                </button>
                            </td>
                            <td>
                                ${u.id}
                            </td>
                            <td>
                                ${u.name}
                            </td>
                            <td>
                                ${roleLabel}
                            </td>
                            <td style="padding: 0; width: auto; text-align: center;">
                                ${useVehicleLabel}
                            </td>
                            <td style="text-align:center;">
                                ${u.contract_hours_per_day ?? 8} h/日
                            </td>
                            <td>
                                <button class='btn' onclick='editUser(${idx})' ${disabled}>
                                    編集
                                </button>
                            </td>
                        </tr>`;
                        if (expandedUserId === u.id) {
                            tbody.innerHTML += renderExpandedRow(u);
                        }
                    }
                }
            });
        }
        // 検索（コンボボックス選択時）
        document
            .getElementById("userSearch")
            .addEventListener("change", renderTable);
        // 新規ユーザー追加（ダミーUI）
        document.getElementById("addUserBtn").onclick = function () {
            const tbody = document.querySelector("#userTable tbody");
            const tr = document.createElement("tr");
            tr.className = "add-user-row";
            tr.innerHTML = `
            <td>新規</td>
            <td>
                <input id='newUserName'>
            </td>
            <td>
                <select id='newUserRole'>
                    <option>一般</option>
                    <option>管理者</option>
                </select>
            </td>
            <td>
                <input type='number' id='newContractHours' value='8' min='0' step='0.25'>h/日
            </td>
            <td>
                <button class='btn' onclick='saveNewUser(this)'>保存</button>
                <button class='btn' onclick='this.parentNode.parentNode.remove()'>キャンセル</button>
            </td>`;
            tbody.prepend(tr);
        };
        // ユーザー追加
        window.saveNewUser = async function (btn) {
            const tr = btn.parentNode.parentNode;
            const name = tr.querySelector("#newUserName").value.trim();
            const roleLabel = tr.querySelector("#newUserRole").value;
            const role = roleLabel === "管理者" ? "admin" : "user";
            const use_vehicle = 1; // 新規はデフォルト1
            const contract_hours_per_day = parseFloat(tr.querySelector("#newContractHours").value) || 8;
            if (!name) {
                alert("ユーザー名を入力してください");
                return;
            }
            // APIで新規ユーザー作成
            const res = await fetchWithAuth("api/admin_user_create.php", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ name, role, use_vehicle, contract_hours_per_day }),
            });
            if (res && res.ok) {
                alert(
                    "ユーザーを登録しました。仮パスワードは「netone」です。初回ログイン時に再設定が必要です。"
                );
                await renderTable();
            } else if (res) {
                const data = await res.json();
                alert(data.error || "登録に失敗しました");
            }
        };
        // 編集・削除・保存
        window.editUser = function (idx) {
            editingIdx = idx;
            renderTable();
        };
        window.cancelEditUser = function () {
            editingIdx = null;
            renderTable();
        };
        window.saveEditUser = async function (idx) {
            const user = users[idx];
            const name = document.getElementById("editName").value.trim();
            const role = document.getElementById("editRole").value;
            const use_vehicle = document.getElementById("editUseVehicle").checked ? 1 : 0;
            const contract_hours_per_day = parseFloat(document.getElementById("editContractHours").value) || 8;
            if (!name) {
                alert("ユーザー名を入力してください");
                return;
            }
            const res = await fetchWithAuth("api/admin_user_update.php", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ id: user.id, name, role, use_vehicle, contract_hours_per_day }),
            });
            if (res && res.ok) {
                editingIdx = null;
                await renderTable();
            } else if (res) {
                alert("更新に失敗しました");
            }
        };
        window.deleteUser = async function (idx) {
            if (!confirm("削除しますか？")) return;
            const user = users[idx];
            const res = await fetchWithAuth("api/admin_user_delete.php", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ id: user.id }),
            });
            if (res && res.ok) {
                await renderTable();
            } else if (res) {
                alert("削除に失敗しました");
            }
        };
        window.restoreUser = async function (idx) {
            const user = users[idx];
            const res = await fetchWithAuth("api/admin_user_restore.php", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ id: user.id }),
            });
            if (res && res.ok) {
                editingIdx = null;
                await renderTable();
            } else if (res) {
                alert("復元に失敗しました");
            }
        };
        window.showSetPassword = function (idx) {
            const user = users[idx];
            const newPass = prompt(
                "新しい仮パスワードを入力してください（8文字以上推奨）"
            );
            if (!newPass) return;
            if (newPass.length < 4) {
                alert("パスワードは4文字以上にしてください");
                return;
            }
            fetchWithAuth("api/admin_user_set_password.php", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ id: user.id, password: newPass }),
            }).then((res) => {
                if (res && res.ok) {
                    alert(
                        "パスワードを再設定しました。ユーザーに新パスワードを伝えてください。"
                    );
                } else if (res) {
                    alert("パスワード再設定に失敗しました");
                }
            });
        };
                document
                        .getElementById("showDeletedToggle")
                        .addEventListener("change", renderTable);

                function renderExpandedRow(user) {
                        const colSpan = 7; // 展開列を含む総列数
                        return `
                        <tr class="expanded-row">
                            <td colspan="${colSpan}">
                                                <div class="tabs" id="tabs-${user.id}">
                                    <button class="tab-btn active" onclick="switchTab(${user.id}, 'summary')">基本情報</button>
                                    <button class="tab-btn" onclick="switchTab(${user.id}, 'details')">詳細</button>
                                    <button class="tab-btn" onclick="switchTab(${user.id}, 'leave_settings')">有給設定</button>
                                    <button class="tab-btn" onclick="switchTab(${user.id}, 'leave_grant')">有給付与</button>
                                                    <button class="tab-btn" onclick="switchTab(${user.id}, 'leave_balance')">残高・履歴</button>
                                </div>
                                <div id="panel-summary-${user.id}" class="tab-panel active">
                                    <div class="grid">
                                        <div>ユーザー名</div><div>${user.name}</div>
                                        <div>権限</div><div>${user.role === 'admin' ? '管理者' : '一般'}</div>
                                        <div>自家用車</div><div>${user.use_vehicle == 1 ? '利用する' : '利用しない'}</div>
                                        <div>契約時間</div><div>${user.contract_hours_per_day ?? 8} h/日</div>
                                    </div>
                                </div>
                                <div id="panel-details-${user.id}" class="tab-panel">
                                    <div class="muted">（今後拡張予定。現状の編集は行の「編集」から行ってください）</div>
                                </div>
                                <div id="panel-leave_settings-${user.id}" class="tab-panel">
                                    <div id="leave-settings-wrap-${user.id}">読み込み中...</div>
                                </div>
                                                <div id="panel-leave_grant-${user.id}" class="tab-panel">
                                    <div id="leave-grant-wrap-${user.id}">読み込み中...</div>
                                </div>
                                                <div id="panel-leave_balance-${user.id}" class="tab-panel">
                                                    <div id="leave-balance-wrap-${user.id}">読み込み中...</div>
                                                </div>
                            </td>
                        </tr>`;
                }

                window.toggleExpand = async function(idx) {
                        const user = users[idx];
                        if (expandedUserId === user.id) {
                                expandedUserId = null;
                                await renderTable();
                                return;
                        }
                        expandedUserId = user.id;
                        await renderTable();
                        try {
                                const masters = await loadMasters();
                                const settings = await loadUserLeaveSettings(user.id);
                                mountLeaveSettings(user, masters, settings);
                                mountLeaveGrant(user, masters, settings);
                            mountLeaveBalance(user);
                        } catch (e) {
                                const el1 = document.getElementById(`leave-settings-wrap-${user.id}`);
                                const el2 = document.getElementById(`leave-grant-wrap-${user.id}`);
                            const el3 = document.getElementById(`leave-balance-wrap-${user.id}`);
                                if (el1) el1.innerHTML = `<span class='danger'>読み込みに失敗しました</span>`;
                                if (el2) el2.innerHTML = `<span class='danger'>読み込みに失敗しました</span>`;
                            if (el3) el3.innerHTML = `<span class='danger'>読み込みに失敗しました</span>`;
                        }
                }

                window.switchTab = function(userId, tab) {
                        const container = document.getElementById(`tabs-${userId}`);
                        if (!container) return;
                        container.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                        const map = {
                                'summary': `panel-summary-${userId}`,
                                'details': `panel-details-${userId}`,
                                'leave_settings': `panel-leave_settings-${userId}`,
                            'leave_grant': `panel-leave_grant-${userId}`,
                            'leave_balance': `panel-leave_balance-${userId}`,
                        };
                        const btns = Array.from(container.querySelectorAll('.tab-btn'));
                        const idx = ['summary','details','leave_settings','leave_grant','leave_balance'].indexOf(tab);
                        if (idx >= 0 && btns[idx]) btns[idx].classList.add('active');
                        Object.values(map).forEach(id => {
                                const p = document.getElementById(id);
                                if (p) p.classList.remove('active');
                        });
                        const target = document.getElementById(map[tab]);
                        if (target) target.classList.add('active');
                }

                async function loadMasters() {
                        if (mastersCache) return mastersCache;
                        const res = await fetchWithAuth('api/masters_get.php');
                        if (!res || !res.ok) throw new Error('masters');
                        mastersCache = await res.json();
                        return mastersCache;
                }

                async function loadUserLeaveSettings(userId) {
                        const res = await fetchWithAuth(`api/admin_user_leave_settings_get.php?user_id=${userId}`);
                        if (!res || !res.ok) throw new Error('settings');
                        return await res.json();
                }

                function mountLeaveSettings(user, masters, settings) {
                        const wrap = document.getElementById(`leave-settings-wrap-${user.id}`);
                        if (!wrap) return;
                        const unitOpts = masters.leave_units.map(u => `<option value="${u.id}">${u.name}</option>`).join('');
                        const typeOpts = masters.paid_leave_types.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
                        const eff = settings.base_hours_per_day_effective ?? (user.contract_hours_per_day ?? 8);
                        wrap.innerHTML = `
                            <div class="grid">
                                <div>デフォルト休暇種別</div>
                                <div><select id="ls-type-${user.id}">${typeOpts}</select></div>
                                <div>デフォルト単位</div>
                                <div><select id="ls-unit-${user.id}">${unitOpts}</select></div>
                                <div>半日取得を許可</div>
                                <div><input type="checkbox" id="ls-half-${user.id}"></div>
                                <div>時間単位取得を許可</div>
                                <div><input type="checkbox" id="ls-hour-${user.id}"></div>
                                <div>基準時間（上書き）</div>
                                <div class="inline">
                                    <input type="number" step="0.25" min="0" id="ls-base-${user.id}" style="width:90px; text-align:right;"> h/日
                                    <span class="field-note">未入力で ${eff} h/日 が適用</span>
                                </div>
                                <div>繰越月数</div>
                                <div><input type="number" min="0" id="ls-carry-m-${user.id}" style="width:90px; text-align:right;"> ヶ月</div>
                                <div>繰越上限（分）</div>
                                <div><input type="number" min="0" id="ls-carry-min-${user.id}" style="width:120px; text-align:right;"></div>
                                <div>マイナス残高を許可</div>
                                <div><input type="checkbox" id="ls-negative-${user.id}"></div>
                                <div></div>
                                <div>
                                    <button class="btn" onclick="saveLeaveSettings(${user.id})">設定を保存</button>
                                </div>
                            </div>
                        `;
                        document.getElementById(`ls-type-${user.id}`).value = settings.default_paid_leave_type_id ?? masters.paid_leave_types[0]?.id ?? 1;
                        document.getElementById(`ls-unit-${user.id}`).value = settings.default_unit_id ?? masters.paid_leave_types.find(t=>t.id===(settings.default_paid_leave_type_id ?? 0))?.default_unit_id ?? masters.leave_units[0]?.id ?? 1;
                        document.getElementById(`ls-half-${user.id}`).checked = (settings.allow_half_day ?? 1) == 1;
                        document.getElementById(`ls-hour-${user.id}`).checked = (settings.allow_hourly ?? 1) == 1;
                        const baseEl = document.getElementById(`ls-base-${user.id}`);
                        if (settings.base_hours_per_day_override !== null && settings.base_hours_per_day_override !== undefined) {
                                baseEl.value = settings.base_hours_per_day_override;
                        } else {
                                baseEl.value = '';
                                baseEl.placeholder = String(eff);
                        }
                        document.getElementById(`ls-carry-m-${user.id}`).value = settings.carryover_months ?? 0;
                        document.getElementById(`ls-carry-min-${user.id}`).value = settings.carryover_max_minutes ?? 0;
                        document.getElementById(`ls-negative-${user.id}`).checked = (settings.negative_balance_allowed ?? 0) == 1;
                }

                window.saveLeaveSettings = async function(userId) {
                        const body = {
                                user_id: userId,
                                default_paid_leave_type_id: parseInt(document.getElementById(`ls-type-${userId}`).value),
                                default_unit_id: parseInt(document.getElementById(`ls-unit-${userId}`).value),
                                allow_half_day: document.getElementById(`ls-half-${userId}`).checked ? 1 : 0,
                                allow_hourly: document.getElementById(`ls-hour-${userId}`).checked ? 1 : 0,
                                base_hours_per_day_override: (function(v){ return v === '' ? null : parseFloat(v); })(document.getElementById(`ls-base-${userId}`).value),
                                carryover_months: parseInt(document.getElementById(`ls-carry-m-${userId}`).value || '0'),
                                carryover_max_minutes: parseInt(document.getElementById(`ls-carry-min-${userId}`).value || '0'),
                                negative_balance_allowed: document.getElementById(`ls-negative-${userId}`).checked ? 1 : 0,
                        };
                        const btn = document.querySelector(`#leave-settings-wrap-${userId} .btn`);
                        if (btn) btn.disabled = true;
                        const res = await fetchWithAuth('api/admin_user_leave_settings_update.php', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(body)
                        });
                        if (btn) btn.disabled = false;
                        if (res && res.ok) {
                                alert('設定を保存しました');
                        } else if (res) {
                                alert('保存に失敗しました');
                        }
                }

                function mountLeaveGrant(user, masters, settings) {
                        const wrap = document.getElementById(`leave-grant-wrap-${user.id}`);
                        if (!wrap) return;
                        wrap.innerHTML = `
                            <div class="grid">
                                <div>付与日</div>
                                <div><input type="date" id="lg-date-${user.id}"></div>
                                <div>付与時間</div>
                                <div class="inline"><input type="number" step="0.25" min="0" id="lg-hours-${user.id}" style="width:90px; text-align:right;"> h</div>
                                <div>有効期限（任意）</div>
                                <div><input type="date" id="lg-expire-${user.id}"></div>
                                <div></div>
                                <div><button class="btn" onclick="grantLeave(${user.id})">付与する</button></div>
                            </div>
                            <div class="field-note">注: ログへの詳細記録は次フェーズで拡張予定です</div>
                        `;
                }

                window.grantLeave = async function(userId) {
                        const date = (document.getElementById(`lg-date-${userId}`).value || '').trim();
                        const hoursStr = (document.getElementById(`lg-hours-${userId}`).value || '').trim();
                        const expire = (document.getElementById(`lg-expire-${userId}`).value || '').trim();
                        if (!date || hoursStr === '') { alert('付与日と付与時間を入力してください'); return; }
                        const hours = parseFloat(hoursStr);
                        const body = { user_id: userId, grant_date: date, grant_hours: hours, expire_date: expire || null };
                        const btn = document.querySelector(`#leave-grant-wrap-${userId} .btn`);
                        if (btn) btn.disabled = true;
                        const res = await fetchWithAuth('api/paid_leave_grant.php', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(body)
                        });
                        if (btn) btn.disabled = false;
                        if (res && res.ok) {
                                alert('有給を付与しました');
                        } else if (res) {
                                alert('付与に失敗しました');
                        }
                }

                        async function loadBalance(userId) {
                                const res = await fetchWithAuth(`api/paid_leave_balance.php?user_id=${userId}`);
                                if (!res || !res.ok) throw new Error('balance');
                                return await res.json();
                        }
                        async function loadHistory(userId) {
                                const res = await fetchWithAuth(`api/paid_leave_history.php?user_id=${userId}&limit=50`);
                                if (!res || !res.ok) throw new Error('history');
                                return await res.json();
                        }
                        async function mountLeaveBalance(user) {
                                const wrap = document.getElementById(`leave-balance-wrap-${user.id}`);
                                if (!wrap) return;
                                try {
                                        const [b, h] = await Promise.all([loadBalance(user.id), loadHistory(user.id)]);
                                        const fmt = (n)=> (Math.round(n*100)/100).toFixed(2);
                                        const grantsRows = (h.grants||[]).map(g=>`<tr><td>${g.grant_date}</td><td style='text-align:right;'>${fmt(g.grant_hours)} h</td><td>${g.expire_date ?? ''}</td></tr>`).join('') || `<tr><td colspan='3' class='muted'>付与履歴はありません</td></tr>`;
                                        const usesRows = (h.uses||[]).map(u=>`<tr><td>${u.used_date}</td><td style='text-align:right;'>${fmt(u.used_hours)} h</td><td>${u.reason ?? ''}</td></tr>`).join('') || `<tr><td colspan='3' class='muted'>利用履歴はありません</td></tr>`;
                                        wrap.innerHTML = `
                                            <div class="grid" style="margin-bottom:12px;">
                                                <div>合計付与（全期間）</div><div style="text-align:right;">${fmt(b.granted_total_hours)} h</div>
                                                <div>有効付与（本日時点）</div><div style="text-align:right;">${fmt(b.granted_active_hours)} h</div>
                                                <div>合計利用</div><div style="text-align:right;">${fmt(b.used_total_hours)} h</div>
                                                <div>残高（有効付与 − 合計利用）</div><div style="text-align:right; font-weight:600;">${fmt(b.balance_hours)} h</div>
                                                <div>基準日</div><div>${b.as_of}</div>
                                            </div>
                                            <div style="display:flex; gap:20px; flex-wrap:wrap;">
                                                <div style="flex:1; min-width:280px;">
                                                    <div class="muted" style="font-weight:600; margin-bottom:6px;">付与履歴（最新50件）</div>
                                                    <table class="user-table" style="margin:0;">
                                                        <thead><tr><th>付与日</th><th>時間</th><th>有効期限</th></tr></thead>
                                                        <tbody>${grantsRows}</tbody>
                                                    </table>
                                                </div>
                                                <div style="flex:1; min-width:280px;">
                                                    <div class="muted" style="font-weight:600; margin-bottom:6px;">利用履歴（最新50件）</div>
                                                    <table class="user-table" style="margin:0;">
                                                        <thead><tr><th>利用日</th><th>時間</th><th>理由</th></tr></thead>
                                                        <tbody>${usesRows}</tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        `;
                                } catch (e) {
                                        wrap.innerHTML = `<span class='danger'>残高・履歴の読み込みに失敗しました</span>`;
                                }
                        }

                renderTable();
    </script>
</body>

</html>