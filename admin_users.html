<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ユーザーアカウント管理</title>
    <style>
        body {
            font-family: "Segoe UI", sans-serif;
            background: #f5f6fa;
            margin: 0;
        }

        .container {
            max-width: 1150px;
            min-width: 700px;
            margin: 2rem auto;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 16px rgba(0, 0, 0, 0.08);
            padding: 2.5rem 1.5rem;
        }

        h2 {
            text-align: center;
            color: #1976d2;
            margin-bottom: 2rem;
        }

        .search-box {
            margin-bottom: 1.5em;
        }

        .user-table {
            width: 100%;
            max-width: 1150px;
            min-width: 300px;
            border-collapse: collapse;
            margin-bottom: 2em;
        }

        th,
        td {
            border: 1px solid #e0e0e0;
            padding: 0.5em 0.7em 0.5em 0.7em;
            text-align: left;
        }

        .date-cell {
            text-align: center;
        }

        .hour-cell {
            text-align: center;
        }

        .button-cell {
            text-align: center;
        }

        .editing {
            padding: 0.5em 0;
        }

        th {
            background: #e3f2fd;
        }

        td input,
        td select {
            width: 70%;
            box-sizing: border-box;
            font-size: 1.1em;
        }

        input {
            width: 90%;
        }

        tr:nth-child(even) {
            background: #f7fafd;
        }

        .btn {
            background: #1976d2;
            color: #fff;
            border: none;
            border-radius: 4px;
            padding: 0.3em 1em;
            cursor: pointer;
        }

        .btn:active {
            background: #1565c0;
        }

        .btn-secondary {
            background: transparent;
            color: #1976d2;
            border: 1.5px solid #1976d2;
        }

        /* 展開行 */
        .expand-toggle {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.1em;
            padding: 0.2em 0.4em;
            color: #1976d2;
        }

        .expanded-row td {
            background: #fbfdff;
            padding: 1rem;
        }

        .tabs {
            display: flex;
            gap: 0px;
            border-bottom: 1px solid #e0e0e0;
            margin-bottom: 0.8rem;
        }

        .tab-btn {
            background: #eef6ff;
            border: 1px solid #cfe2f3;
            font-size: 1.1em;
            color: #1976d2;
            border-radius: 6px 6px 0 0;
            padding: 6px 10px;
            cursor: pointer;
        }

        .tab-btn.active {
            background: #fff;
            border-bottom-color: #fff;
            font-weight: 600;
        }

        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
        }

        .grid {
            display: grid;
            grid-template-columns: 220px 1fr;
            gap: 10px 12px;
            align-items: center;
            max-width: 800px;
        }

        .field-note {
            color: #666;
            font-size: 0.9em;
        }

        .inline {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .muted {
            color: #b3b3b3;
        }

        .danger {
            color: #d32f2f;
        }

        .two-col {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        @media (min-width: 960px) {
            .two-col {
                flex-direction: row;
            }

            .two-col>div {
                flex: 1;
            }
        }

        .expanded-row .user-table {
            width: 100%;
            table-layout: auto;
        }

        .expanded-row .user-table th,
        .expanded-row .user-table td {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .add-user-row {
            background: #f1f8e9;
        }

        .add-user-row input {
            width: 90%;
        }

        .toggle {
            position: relative;
            display: inline-block;
            width: 66px;
            height: 36px;
            vertical-align: middle;
        }

        .toggle-s {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 27px;
            vertical-align: middle;
        }

        .toggle__input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle__slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.4s;
            border-radius: 30px;
        }

        .toggle__slider-s {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.4s;
            border-radius: 23px;
        }

        .toggle__slider:before {
            border-radius: 50%;
            position: absolute;
            content: "";
            height: 30px;
            width: 30px;
            left: 3px;
            bottom: 3px;
            background: #fff;
            transition: 0.3s;
            box-shadow: 0 0 1px rgba(0, 0, 0, 0.5);
        }

        .toggle__slider-s:before {
            border-radius: 50%;
            position: absolute;
            content: "";
            height: 23px;
            width: 23px;
            left: 2px;
            bottom: 2px;
            background: #fff;
            transition: 0.3s;
            box-shadow: 0 0 1px rgba(0, 0, 0, 0.5);
        }

        .toggle__input:checked+.toggle__slider {
            background: #8dcfff;
        }

        .toggle__input:checked+.toggle__slider:before {
            transform: translateX(30px);
        }

        .toggle__input-s:checked+.toggle__slider-s {
            background: #8dcfff;
        }

        .toggle__input-s:checked+.toggle__slider-s:before {
            transform: translateX(23px);
        }

        @media (max-width: 600px) {
            .container {
                padding: 1rem 0.2rem;
            }

            .user-table,
            th,
            td {
                font-size: 0.95em;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div style="text-align: right; margin-bottom: 0.7em">
            <button class="btn btn-secondary" id="backBtn">← 管理メニューへ</button>
        </div>
        <h2>ユーザーアカウント管理</h2>
        <div
            class="search-box"
            style="display: flex; align-items: center; gap: 1em">
            <select
                id="userSearch"
                style="
            padding: 0.4em 1em;
            width: 220px;
            font-size: 1.1em;
            border-radius: 4px;
            border: 1px solid #b0bec5;
          ">
                <option value="">全ユーザー</option>
            </select>
            <button class="btn" id="addUserBtn">＋新規ユーザー</button>
            <div style="flex: 1; text-align: right">
                <label class="toggle" for="showDeletedToggle">
                    <input
                        type="checkbox"
                        class="toggle__input"
                        id="showDeletedToggle" />
                    <span class="toggle__slider"></span>
                </label>
                <label
                    for="showDeletedToggle"
                    style="cursor: pointer; user-select: none"> 削除したユーザーの表示</label>
            </div>
        </div>
        <table class="user-table" id="userTable">
            <colgroup>
                <col style="width: 2em;" />
                <col style="width: 1.5em;" />
                <col style="width: 6em;" />
                <col style="width: 3em;" />
                <col style="width: 3.5em;" />
                <col style="width: 4.5em;" />
            </colgroup>
            <thead>
                <tr>
                    <th></th>
                    <th style="text-align: start;">ID</th>
                    <th style="text-align: center; text-wrap-mode: nowrap;">ユーザー名</th>
                    <th style="text-align: start; min-width: 3em;">権限</th>
                    <th style="text-align: center; text-wrap-mode: nowrap;">自家用車</th>
                    <th style="text-align: center; text-wrap-mode: nowrap;">契約労働時間</th>
                </tr>
            </thead>
            <tbody>
                <!-- ユーザー一覧がここに挿入されます -->
            </tbody>
        </table>
    </div>
    <script>
        // fetchWithAuth: 401/403時は自動ログアウト
        async function fetchWithAuth(url, options) {
            const res = await fetch(url, options);
            if (res.status === 401 || res.status === 403) {
                window.location.href = "login.html";
                return null;
            }
            return res;
        }
        // 管理者権限チェック（URL直打ち対策）
        fetchWithAuth("api/check_login.php")
            .then((res) => res && res.json())
            .then((data) => {
                if (!data || !data.loggedIn) {
                    window.location.href = "login.html";
                } else if (!data.is_admin) {
                    alert("管理者権限がありません");
                    window.location.href = "punch.html";
                }
            });
        // 戻るボタン
        (function () {
            const back = document.getElementById('backBtn');
            if (back) back.onclick = () => { window.location.href = 'admin.html'; };
        })();
        // 全社設定の取得（所定労働時間・繰越月数 など）
        let orgSettings = null;
        async function loadOrgSettings() {
            try {
                const res = await fetchWithAuth('api/settings_get.php');
                if (!res || !res.ok) return null;
                orgSettings = await res.json();
                return orgSettings;
            } catch { return null; }
        }
        // ユーザー一覧取得
        async function loadUsers() {
            const res = await fetchWithAuth("api/admin_user_list.php");
            if (!res || !res.ok) return [];
            return await res.json();
        }
        let users = [];
        let allUsers = [];
        let expandedUserId = null; // 展開中のユーザーID
        let mastersCache = null;   // マスターキャッシュ
        let newUserOpen = false;   // 新規ユーザー入力パネルの開閉状態
        async function renderTable() {
            allUsers = await loadUsers();
            const showDeleted =
                document.getElementById("showDeletedToggle").checked;
            users = showDeleted
                ? allUsers
                : allUsers.filter((u) => u.visible === undefined || u.visible == 1);
            const userSearch = document.getElementById("userSearch");
            const prevSelectedId = userSearch.value;
            // 選択肢を再生成
            userSearch.innerHTML =
                '<option value="">全ユーザー</option>' +
                users
                    .map((u) => `<option value="${u.id}">${u.name}</option>`)
                    .join("");
            // 直前の選択値を復元（新規追加時やトグル切替時も）
            if (
                prevSelectedId &&
                userSearch.querySelector(`option[value="${prevSelectedId}"]`)
            ) {
                userSearch.value = prevSelectedId;
            } else {
                userSearch.value = "";
            }
            const selectedId = userSearch.value;
            const tbody = document.querySelector("#userTable tbody");
            tbody.innerHTML = "";
            const baseHoursDefault = (orgSettings ? (Number(orgSettings.work_hours || 0) + (Number(orgSettings.work_minutes || 0) / 60)) : 8);
            users.forEach((u, idx) => {
                const roleLabel = u.role === "admin" ? "管理者" : "一般";
                const useVehicleLabel = u.use_vehicle == 1 ? "○" : "×";
                if (!selectedId || selectedId == u.id) {
                    const deletedStyle =
                        u.visible == 0 ? "color:#aaa;background:#fbe9e7;" : "";
                    tbody.innerHTML += `
                        <tr id="row-user-${u.id}" class="click-row" style='${deletedStyle}' onclick="toggleExpand(${idx})">
                            <td style="text-align:center;">
                                ${expandedUserId === u.id ? '∨' : '＞'}
                            </td>
                            <td>
                                ${u.id}
                            </td>
                            <td style="text-wrap-mode: nowrap;">
                                ${u.name}
                            </td>
                            <td>
                                ${roleLabel}
                            </td>
                            <td style="padding: 0; width: auto; text-align: center;">
                                ${useVehicleLabel}
                            </td>
                            <td style="text-align:center;">
                                ${u.contract_hours_per_day ?? baseHoursDefault} h/日
                            </td>
                        </tr>`;
                    if (expandedUserId === u.id) {
                        tbody.innerHTML += renderExpandedRow(u);
                    }
                }
            });
        }
        // 検索（コンボボックス選択時）
        document
            .getElementById("userSearch")
            .addEventListener("change", renderTable);
        // 新規ユーザーの入力欄を展開方式で表示
        document.getElementById("addUserBtn").onclick = async function () {
            if (newUserOpen) {
                const panel = document.getElementById('new-user-panel');
                if (panel) { panel.scrollIntoView({ behavior: 'smooth', block: 'center' }); return; }
                // パネルが消えている（再描画など）場合はフラグをリセットして作り直す
                newUserOpen = false;
            }
            if (expandedUserId !== null) {
                expandedUserId = null;
                await renderTable();
            }
            const tbody = document.querySelector('#userTable tbody');
            const colSpan = 6; // ヘッダー列数に合わせる
            const baseHoursDefault = (orgSettings ? (Number(orgSettings.work_hours || 0) + (Number(orgSettings.work_minutes || 0) / 60)) : 8);
            const panel = document.createElement('tr');
            panel.className = 'expanded-row';
            panel.id = 'new-user-panel';
            panel.innerHTML = `
                <td colspan="${colSpan}">
                    <div class="tabs" style="border:none;margin-bottom:12px;"><button class="tab-btn active">新規ユーザーの作成</button></div>
                    <div class="grid" style="max-width:780px;">
                        <div>ユーザー名<span class="danger">*</span></div>
                        <div><input id="newUserName" placeholder="氏名"></div>
                        <div>権限</div>
                        <div>
                            <select id="newUserRole">
                                <option value="user">一般</option>
                                <option value="admin">管理者</option>
                            </select>
                        </div>
                        <div>区分</div>
                        <div class="inline">
                            <label class="toggle-s" for="newFullTime">
                                <input type="checkbox" class="toggle__input-s" id="newFullTime" checked>
                                <span class="toggle__slider-s"></span>
                            </label>
                            <span id="new-ft-label" class="muted">常勤</span>
                        </div>
                        <div>自家用車</div>
                        <div class="inline">
                            <label class="toggle-s" for="newUseVehicle">
                                <input type="checkbox" class="toggle__input-s" id="newUseVehicle" checked>
                                <span class="toggle__slider-s"></span>
                            </label>
                            <span id="new-vehicle-label" class="muted">使用する</span>
                        </div>
                        <div>契約労働時間（1日あたり）</div>
                        <div><input type="number" id="newContractHours" min="0" step="0.25" value="${baseHoursDefault}" placeholder="未設定可" style="width:90px;text-align:right;"> h/日</div>
                        <div class="muted">予定（所定）労働パターン（任意）</div>
                        <div class="inline" style="gap:12px; flex-wrap:wrap; align-items:center;">
                          <label>週日数 <input type="number" id="newSchedWD" min="0" step="1" placeholder="例: 5" style="width:80px; text-align:right;"> 日/週</label>
                          <label>週時間 <input type="number" id="newSchedWH" min="0" step="0.25" placeholder="例: 40" style="width:90px; text-align:right;"> h/週</label>
                          <label>年日数 <input type="number" id="newSchedAD" min="0" step="1" placeholder="例: 240" style="width:90px; text-align:right;"> 日/年</label>
                        </div>
                    </div>
                    <div style="margin-top:14px; display:flex; gap:8px;">
                        <button class="btn" id="newUserSaveBtn">登録</button>
                        <button class="btn" id="newUserCancelBtn" style="background:#fff;color:#1976d2;border:1.5px solid #1976d2;">キャンセル</button>
                    </div>
                </td>`;
            tbody.prepend(panel);
            newUserOpen = true;
            (function () {
                const cb = document.getElementById('newUseVehicle');
                const lbl = document.getElementById('new-vehicle-label');
                if (!cb || !lbl) return;
                const sync = () => { if (cb.checked) { lbl.textContent = '使用する'; lbl.classList.remove('muted'); } else { lbl.textContent = '使用しない'; lbl.classList.add('muted'); } };
                sync();
                cb.addEventListener('change', sync);
            })();
            (function () {
                const cb = document.getElementById('newFullTime');
                const lbl = document.getElementById('new-ft-label');
                if (!cb || !lbl) return;
                const sync = () => { if (cb.checked) { lbl.textContent = '常勤'; lbl.classList.remove('muted'); } else { lbl.textContent = '非常勤'; lbl.classList.add('muted'); } };
                sync();
                cb.addEventListener('change', sync);
            })();
            document.getElementById('newUserCancelBtn').onclick = function () {
                const p = document.getElementById('new-user-panel');
                if (p) p.remove();
                newUserOpen = false;
            };
            document.getElementById('newUserSaveBtn').onclick = function (e) { saveNewUser(e.currentTarget); };
        };
        // ユーザー追加
        window.saveNewUser = async function (btn) {
            const root = document.getElementById('new-user-panel') || btn.closest('tr');
            const name = (root.querySelector('#newUserName')?.value || '').trim();
            const roleVal = (root.querySelector('#newUserRole')?.value || 'user');
            const role = roleVal === 'admin' ? 'admin' : 'user';
            const full_time = (root.querySelector('#newFullTime')?.checked ? 1 : 0);
            const use_vehicle = (root.querySelector('#newUseVehicle')?.checked ? 1 : 0);
            const chRawNew = (root.querySelector('#newContractHours')?.value ?? '').toString().trim();
            const contract_hours_per_day = (chRawNew === '') ? null : (parseFloat(chRawNew) > 0 ? parseFloat(chRawNew) : null);
            const sched_wd_raw = (root.querySelector('#newSchedWD')?.value ?? '').toString().trim();
            const sched_wh_raw = (root.querySelector('#newSchedWH')?.value ?? '').toString().trim();
            const sched_ad_raw = (root.querySelector('#newSchedAD')?.value ?? '').toString().trim();
            const scheduled_weekly_days = (sched_wd_raw === '') ? null : ((parseInt(sched_wd_raw) > 0) ? parseInt(sched_wd_raw) : null);
            const scheduled_weekly_hours = (sched_wh_raw === '') ? null : ((parseFloat(sched_wh_raw) > 0) ? parseFloat(sched_wh_raw) : null);
            const scheduled_annual_days = (sched_ad_raw === '') ? null : ((parseInt(sched_ad_raw) > 0) ? parseInt(sched_ad_raw) : null);
            if (!name) { alert('ユーザー名を入力してください'); return; }
            if (contract_hours_per_day < 0) { alert('契約労働時間は0以上で入力してください'); return; }
            const res = await fetchWithAuth('api/admin_user_create.php', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, role, full_time, use_vehicle, contract_hours_per_day, scheduled_weekly_days, scheduled_weekly_hours, scheduled_annual_days })
            });
            if (res && res.ok) {
                const data = await res.json();
                const newId = data && data.id ? String(data.id) : null;
                alert('ユーザーを登録しました \n仮パスワードは"netone"です。\n初回ログイン時にパスワード変更が要求されます。');
                const p = document.getElementById('new-user-panel');
                if (p) p.remove();
                newUserOpen = false;
                // 全ユーザー表示に戻す（フィルタ解除）
                const sel = document.getElementById('userSearch');
                if (sel) sel.value = '';
                if (newId) expandedUserId = parseInt(newId);
                await renderTable();
                // 新規ユーザーの詳細/有給タブ等をマウント
                if (newId) {
                    const user = users.find(u => String(u.id) === newId);
                    const row = document.getElementById(`row-user-${newId}`);
                    if (row) row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    if (user) {
                        try {
                            const masters = await loadMasters();
                            const settings = await loadUserLeaveSettings(user.id);
                            mountUserDetails(user);
                            mountLeaveSettings(user, masters, settings);
                            mountLeaveGrant(user, masters, settings);
                            mountLeaveBalance(user.id);
                        } catch (e) {
                            // 失敗時は無視（表示側でエラーメッセージが出る）
                        }
                    }
                }
            } else if (res) {
                const data = await res.json();
                alert(data.error || '登録に失敗しました');
            }
        };
        // 行編集機能は詳細タブへ移行済みのため削除
        document
            .getElementById("showDeletedToggle")
            .addEventListener("change", renderTable);

        // 行クリックで展開する行の見た目
        (function ensureClickRowStyle() {
            const styleId = 'click-row-style';
            if (!document.getElementById(styleId)) {
                const s = document.createElement('style');
                s.id = styleId;
                s.textContent = `.click-row{cursor:pointer;} .click-row:hover{background:#f2f8ff;}`;
                document.head.appendChild(s);
            }
        })();

        function renderExpandedRow(user) {
            const colSpan = 6; // 操作列を削除したため総列数を6に調整
            return `
                        <tr class="expanded-row">
                            <td colspan="${colSpan}">
                                                <div class="tabs" id="tabs-${user.id}">
                                    <button class="tab-btn active" onclick="switchTab(${user.id}, 'summary')">基本情報</button>
                                    <button class="tab-btn" onclick="switchTab(${user.id}, 'details')">詳細</button>
                                    <button class="tab-btn" onclick="switchTab(${user.id}, 'leave_settings')">有給設定</button>
                                    <button class="tab-btn" onclick="switchTab(${user.id}, 'leave_grant')">有給付与</button>
                                                    <button class="tab-btn" onclick="switchTab(${user.id}, 'leave_balance')">残高・履歴</button>
                                </div>
                                <div id="panel-summary-${user.id}" class="tab-panel active">
                                    <div class="grid">
                                        <div>ユーザー名</div><div>${user.name}</div>
                                        <div>権限</div><div>${user.role === 'admin' ? '管理者' : '一般'}</div>
                                        <div>自家用車</div><div>${user.use_vehicle == 1 ? '利用する' : '利用しない'}</div>
                                        <div>契約時間</div><div>${(user.contract_hours_per_day != null ? user.contract_hours_per_day + ' h/日' : '未設定')}</div>
                                    </div>
                                </div>
                                <div id="panel-details-${user.id}" class="tab-panel">
                                    <div class="muted">（今後拡張予定。現状の編集は行の「編集」から行ってください）</div>
                                </div>
                                <div id="panel-leave_settings-${user.id}" class="tab-panel">
                                    <div id="leave-settings-wrap-${user.id}">読み込み中...</div>
                                </div>
                                                <div id="panel-leave_grant-${user.id}" class="tab-panel">
                                    <div id="leave-grant-wrap-${user.id}">読み込み中...</div>
                                </div>
                                                <div id="panel-leave_balance-${user.id}" class="tab-panel">
                                                    <div id="leave-balance-wrap-${user.id}">読み込み中...</div>
                                                </div>
                            </td>
                        </tr>`;
        }

        // 詳細タブ（ユーザー編集フォーム）
        function mountUserDetails(user) {
            const panel = document.getElementById(`panel-details-${user.id}`);
            if (!panel) return;
            const disabled = (user.visible == 0) ? 'disabled' : '';
            const roleUserSel = user.role === 'user' ? 'selected' : '';
            const roleAdminSel = user.role === 'admin' ? 'selected' : '';
            const checked = user.use_vehicle == 1 ? 'checked' : '';
            const noteDeleted = (user.visible == 0)
                ? `<div class="danger" style="margin-bottom:8px;">このユーザーは削除状態です。復元すると編集できます。</div>`
                : '';
            panel.innerHTML = `
                ${noteDeleted}
                <div class="grid">
                    <div>ユーザー名</div>
                    <div><input type="text" id="det-name-${user.id}" value="${user.name}" ${disabled} style="max-width:260px;"></div>
                    <div>権限</div>
                    <div>
                        <select id="det-role-${user.id}" ${disabled} style="max-width:160px;">
                            <option value="user" ${roleUserSel}>一般</option>
                            <option value="admin" ${roleAdminSel}>管理者</option>
                        </select>
                    </div>
                    <div>区分</div>
                    <div class="inline">
                        <label class="toggle-s" for="det-fulltime-${user.id}">
                            <input type="checkbox" class="toggle__input-s" id="det-fulltime-${user.id}" ${user.full_time == 1 ? 'checked' : ''} ${disabled}>
                            <span class="toggle__slider-s"></span>
                        </label>
                        <label id="det-fulltime-label-${user.id}" for="det-fulltime-${user.id}" style="cursor:pointer; user-select:none" class="${user.full_time == 1 ? '' : 'muted'}">${user.full_time == 1 ? '常勤' : '非常勤'}</label>
                    </div>
                    <div>自家用車</div>
                    <div class="inline">
                        <label class="toggle-s" for="det-vehicle-${user.id}">
                            <input type="checkbox" class="toggle__input-s" id="det-vehicle-${user.id}" ${checked} ${disabled}>
                            <span class="toggle__slider-s"></span>
                        </label>
                        <label for="det-vehicle-${user.id}" id="det-vehicle-label-${user.id}" style="cursor:pointer; user-select:none" class="${checked ? '' : 'muted'}">${checked ? '利用する' : '利用しない'}</label>
                    </div>
                    <div>契約労働時間</div>
                    <div class="inline"><input type="number" step="0.25" min="0" id="det-contract-${user.id}" value="${(user.contract_hours_per_day ?? '')}" ${disabled} placeholder="未設定" style="width:90px; text-align:right;"> h/日</div>
                    <div class="muted">予定（所定）労働パターン</div>
                    <div class="inline" style="gap:12px; flex-wrap:wrap; align-items:center;">
                        <label>週日数 <input type="number" step="1" min="0" id="det-sched-wd-${user.id}" value="${(user.scheduled_weekly_days ?? '')}" ${disabled} placeholder="未設定" style="width:80px; text-align:right;"> 日/週</label>
                        <label>週時間 <input type="number" step="0.25" min="0" id="det-sched-wh-${user.id}" value="${(user.scheduled_weekly_hours ?? '')}" ${disabled} placeholder="未設定" style="width:90px; text-align:right;"> h/週</label>
                        <label>年日数 <input type="number" step="1" min="0" id="det-sched-ad-${user.id}" value="${(user.scheduled_annual_days ?? '')}" ${disabled} placeholder="未設定" style="width:90px; text-align:right;"> 日/年</label>
                    </div>
                    <div>入社日</div>
                    <div><input type="date" id="det-hire-${user.id}" value="${user.hire_date ?? ''}" ${disabled} style="max-width:160px;"></div>
                    <div>退職日</div>
                    <div><input type="date" id="det-retire-${user.id}" value="${user.retire_date ?? ''}" ${user.visible == 0 ? 'disabled' : ''} style="max-width:160px;"></div>
                    <div></div>
                    <div class="inline" style="gap:8px; flex-wrap:wrap;">
                        ${user.visible == 1 ? `<button class="btn" id="det-save-${user.id}">保存</button>` : ''}
                        ${user.visible == 1 ? `<button class="btn" id="det-delete-${user.id}" style="background:#e57373;">削除</button>` : `<button class=\"btn\" id=\"det-restore-${user.id}\">復元</button>`}
                        <button class="btn" id="det-setpass-${user.id}" ${user.visible == 0 ? 'disabled' : ''}>パスワード再設定</button>
                    </div>
                </div>
            `;

            // 自家用車ラベルの色をチェック状態に応じて変更（オフ時のみ薄く）
            (function () {
                const cb = document.getElementById(`det-vehicle-${user.id}`);
                const lbl = document.getElementById(`det-vehicle-label-${user.id}`);
                if (!cb || !lbl) return;
                const sync = () => {
                    if (cb.checked) { lbl.textContent = '利用する'; lbl.classList.remove('muted'); }
                    else { lbl.textContent = '利用しない'; lbl.classList.add('muted'); }
                };
                sync();
                cb.addEventListener('change', sync);
            })();

            // 区分(常勤/非常勤)ラベル同期
            (function () {
                const cb = document.getElementById(`det-fulltime-${user.id}`);
                const lbl = document.getElementById(`det-fulltime-label-${user.id}`);
                if (!cb || !lbl) return;
                const sync = () => {
                    if (cb.checked) { lbl.textContent = '常勤'; lbl.classList.remove('muted'); }
                    else { lbl.textContent = '非常勤'; lbl.classList.add('muted'); }
                };
                sync();
                cb.addEventListener('change', sync);
            })();

            // ハンドラ
            const saveBtn = document.getElementById(`det-save-${user.id}`);
            if (saveBtn) {
                saveBtn.onclick = async () => {
                    const name = (document.getElementById(`det-name-${user.id}`)?.value || '').trim();
                    const role = (document.getElementById(`det-role-${user.id}`)?.value || 'user');
                    const use_vehicle = (document.getElementById(`det-vehicle-${user.id}`)?.checked ? 1 : 0);
                    const chRaw = (document.getElementById(`det-contract-${user.id}`)?.value ?? '').toString().trim();
                    const ch = (chRaw === '') ? null : (parseFloat(chRaw) > 0 ? parseFloat(chRaw) : null);
                    const swdRaw = (document.getElementById(`det-sched-wd-${user.id}`)?.value ?? '').toString().trim();
                    const swhRaw = (document.getElementById(`det-sched-wh-${user.id}`)?.value ?? '').toString().trim();
                    const sadRaw = (document.getElementById(`det-sched-ad-${user.id}`)?.value ?? '').toString().trim();
                    const scheduled_weekly_days = (swdRaw === '') ? null : ((parseInt(swdRaw) > 0) ? parseInt(swdRaw) : null);
                    const scheduled_weekly_hours = (swhRaw === '') ? null : ((parseFloat(swhRaw) > 0) ? parseFloat(swhRaw) : null);
                    const scheduled_annual_days = (sadRaw === '') ? null : ((parseInt(sadRaw) > 0) ? parseInt(sadRaw) : null);
                    const detFull = (document.getElementById(`det-fulltime-${user.id}`)?.checked) ? 1 : 0;
                    const hireDateRaw = (document.getElementById(`det-hire-${user.id}`)?.value || '');
                    const hire_date = hireDateRaw === '' ? null : hireDateRaw;
                    const retireDateRaw = (document.getElementById(`det-retire-${user.id}`)?.value || '');
                    const retire_date = retireDateRaw === '' ? null : retireDateRaw;
                    if (!name) { alert('ユーザー名を入力してください'); return; }
                    const res = await fetchWithAuth('api/admin_user_update.php', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ id: user.id, name, role, use_vehicle, contract_hours_per_day: ch, full_time: detFull, hire_date, retire_date, scheduled_weekly_days, scheduled_weekly_hours, scheduled_annual_days })
                    });
                    if (res && res.ok) {
                        await renderTable();
                        await refreshExpandedPanels(user.id);
                    } else if (res) {
                        alert('更新に失敗しました');
                    }
                };
            }

            const delBtn = document.getElementById(`det-delete-${user.id}`);
            if (delBtn) {
                delBtn.onclick = async () => {
                    const retire = (document.getElementById(`det-retire-${user.id}`)?.value || '').trim();
                    if (!retire) { alert('削除（退職）には退職日が必須です。退職日を入力してください。'); return; }
                    if (!confirm('このユーザーを削除（非表示）にします。実行しますか？')) return;
                    const res = await fetchWithAuth('api/admin_user_delete.php', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ id: user.id, retire_date: retire })
                    });
                    if (res && res.ok) {
                        await renderTable();
                        await refreshExpandedPanels(user.id);
                    } else if (res) {
                        alert('削除に失敗しました');
                    }
                };
            }

            const restoreBtn = document.getElementById(`det-restore-${user.id}`);
            if (restoreBtn) {
                restoreBtn.onclick = async () => {
                    const res = await fetchWithAuth('api/admin_user_restore.php', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ id: user.id, clear_retire_date: 1 })
                    });
                    if (res && res.ok) {
                        await renderTable();
                        await refreshExpandedPanels(user.id);
                    } else if (res) {
                        alert('復元に失敗しました');
                    }
                };
            }

            const setpassBtn = document.getElementById(`det-setpass-${user.id}`);
            if (setpassBtn) {
                setpassBtn.onclick = async () => {
                    const newPass = prompt('新しい仮パスワードを入力してください（8文字以上推奨）');
                    if (!newPass) return;
                    if (newPass.length < 4) { alert('パスワードは4文字以上にしてください'); return; }
                    const res = await fetchWithAuth('api/admin_user_set_password.php', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ id: user.id, password: newPass })
                    });
                    if (res && res.ok) {
                        alert('パスワードを再設定しました。ユーザーに新パスワードを伝えてください。');
                    } else if (res) {
                        alert('パスワード再設定に失敗しました');
                    }
                };
            }
        }

        // 展開中パネルの再構築（展開維持）
        async function refreshExpandedPanels(userId) {
            const user = users.find(u => u.id == userId);
            if (!user) return; // フィルタで消えた場合など
            try {
                const masters = await loadMasters();
                const settings = await loadUserLeaveSettings(user.id);
                mountUserDetails(user);
                mountLeaveSettings(user, masters, settings);
                mountLeaveGrant(user, masters, settings);
                mountLeaveBalance(user.id);
            } catch (e) {
                // 何もしない（個別エリアでエラーメッセージ表示済み）
            }
        }

        window.toggleExpand = async function (idx) {
            const user = users[idx];
            if (expandedUserId === user.id) {
                expandedUserId = null;
                await renderTable();
                return;
            }
            expandedUserId = user.id;
            await renderTable();
            try {
                const masters = await loadMasters();
                const settings = await loadUserLeaveSettings(user.id);
                mountUserDetails(user);
                mountLeaveSettings(user, masters, settings);
                mountLeaveGrant(user, masters, settings);
                mountLeaveBalance(user.id);
            } catch (e) {
                const el1 = document.getElementById(`leave-settings-wrap-${user.id}`);
                const el2 = document.getElementById(`leave-grant-wrap-${user.id}`);
                const el3 = document.getElementById(`leave-balance-wrap-${user.id}`);
                if (el1) el1.innerHTML = `<span class='danger'>読み込みに失敗しました</span>`;
                if (el2) el2.innerHTML = `<span class='danger'>読み込みに失敗しました</span>`;
                if (el3) el3.innerHTML = `<span class='danger'>読み込みに失敗しました</span>`;
            }
        }

        window.switchTab = function (userId, tab) {
            const container = document.getElementById(`tabs-${userId}`);
            if (!container) return;
            container.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            const map = {
                'summary': `panel-summary-${userId}`,
                'details': `panel-details-${userId}`,
                'leave_settings': `panel-leave_settings-${userId}`,
                'leave_grant': `panel-leave_grant-${userId}`,
                'leave_balance': `panel-leave_balance-${userId}`,
            };
            const btns = Array.from(container.querySelectorAll('.tab-btn'));
            const idx = ['summary', 'details', 'leave_settings', 'leave_grant', 'leave_balance'].indexOf(tab);
            if (idx >= 0 && btns[idx]) btns[idx].classList.add('active');
            Object.values(map).forEach(id => {
                const p = document.getElementById(id);
                if (p) p.classList.remove('active');
            });
            const target = document.getElementById(map[tab]);
            if (target) target.classList.add('active');
            if (tab === 'leave_balance') {
                // タブ切替毎に最新へ更新
                mountLeaveBalance(userId);
            }
        }

        async function loadMasters() {
            if (mastersCache) return mastersCache;
            const res = await fetchWithAuth('api/masters_get.php');
            if (!res || !res.ok) throw new Error('masters');
            mastersCache = await res.json();
            return mastersCache;
        }

        async function loadUserLeaveSettings(userId) {
            const res = await fetchWithAuth(`api/admin_user_leave_settings_get.php?user_id=${userId}`);
            if (!res || !res.ok) throw new Error('settings');
            return await res.json();
        }

        function mountLeaveSettings(user, masters, settings) {
            const wrap = document.getElementById(`leave-settings-wrap-${user.id}`);
            if (!wrap) return;
            const DEFAULT_BASE_HOURS = (orgSettings ? (Number(orgSettings.work_hours || 0) + (Number(orgSettings.work_minutes || 0) / 60)) : 8);
            const DEFAULT_CARRY_MONTHS = (orgSettings ? Number(orgSettings.paid_leave_valid_months || 24) : 24);
            const unitOpts = masters.leave_units.map(u => `<option value="${u.id}">${u.name}</option>`).join('');
            const typeOpts = masters.paid_leave_types.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
            const eff = (settings.base_hours_per_day_override ?? null) !== null
                ? settings.base_hours_per_day_override
                : (user.contract_hours_per_day ?? DEFAULT_BASE_HOURS);
            wrap.innerHTML = `
                            <div class="grid">
                                <div>デフォルト休暇種別</div>
                                <div><select id="ls-type-${user.id}" style="height: 35px;">${typeOpts}</select></div>
                                <div>デフォルト単位</div>
                                <div><select id="ls-unit-${user.id}" style="height: 35px;">${unitOpts}</select></div>
                                <div>半日取得</div>
                                <div class="inline">
                                    <label class="toggle-s" for="ls-half-${user.id}">
                                        <input type="checkbox" class="toggle__input-s" id="ls-half-${user.id}">
                                        <span class="toggle__slider-s"></span>
                                    </label>
                                    <label for="ls-half-${user.id}" id="ls-half-label-${user.id}" style="cursor:pointer; user-select:none" class="muted">許可しない</label>
                                </div>
                                <div>時間単位取得</div>
                                <div class="inline">
                                    <label class="toggle-s" for="ls-hour-${user.id}">
                                        <input type="checkbox" class="toggle__input-s" id="ls-hour-${user.id}">
                                        <span class="toggle__slider-s"></span>
                                    </label>
                                    <label for="ls-hour-${user.id}" id="ls-hour-label-${user.id}" style="cursor:pointer; user-select:none" class="muted">許可しない</label>
                                </div>
                                <div>基準時間（上書き）</div>
                                <div class="inline">
                                    <input type="number" step="0.25" min="0" id="ls-base-${user.id}" style="width:90px; text-align:right; height: 35px;"> h/日
                                    <span class="field-note">未入力で ${eff} h/日 が適用</span>
                                </div>
                                <div>繰越月数</div>
                                <div><input type="number" min="0" id="ls-carry-m-${user.id}" style="width:90px; text-align:right; height: 35px;"> ヶ月</div>
                                <div>繰越上限（分）</div>
                                <div><input type="number" min="0" id="ls-carry-min-${user.id}" style="width:120px; text-align:right; height: 35px;"></div>
                                <div>マイナス残高</div>
                                <div class="inline">
                                    <label class="toggle-s" for="ls-negative-${user.id}">
                                        <input type="checkbox" class="toggle__input-s" id="ls-negative-${user.id}">
                                        <span class="toggle__slider-s"></span>
                                    </label>
                                    <label for="ls-negative-${user.id}" id="ls-negative-label-${user.id}" style="cursor:pointer; user-select:none" class="muted">許可しない</label>
                                </div>
                                <div></div>
                                <div>
                                    <button class="btn" onclick="saveLeaveSettings(${user.id})">設定を保存</button>
                                </div>
                            </div>
                        `;
            document.getElementById(`ls-type-${user.id}`).value = settings.default_paid_leave_type_id ?? masters.paid_leave_types[0]?.id ?? 1;
            document.getElementById(`ls-unit-${user.id}`).value = settings.default_unit_id ?? masters.paid_leave_types.find(t => t.id === (settings.default_paid_leave_type_id ?? 0))?.default_unit_id ?? masters.leave_units[0]?.id ?? 1;
            document.getElementById(`ls-half-${user.id}`).checked = (settings.allow_half_day ?? 1) == 1;
            document.getElementById(`ls-hour-${user.id}`).checked = (settings.allow_hourly ?? 1) == 1;
            const baseEl = document.getElementById(`ls-base-${user.id}`);
            if (settings.base_hours_per_day_override !== null && settings.base_hours_per_day_override !== undefined) {
                baseEl.value = settings.base_hours_per_day_override;
            } else {
                baseEl.value = '';
                baseEl.placeholder = String(eff);
            }
            document.getElementById(`ls-carry-m-${user.id}`).value = (settings.carryover_months ?? DEFAULT_CARRY_MONTHS);
            document.getElementById(`ls-carry-min-${user.id}`).value = settings.carryover_max_minutes ?? 0;
            document.getElementById(`ls-negative-${user.id}`).checked = (settings.negative_balance_allowed ?? 0) == 1;

            // トグルの文言と色を同期（ON: 許可する / OFF: 許可しない〈灰色〉）
            (function () {
                function bindToggle(idBase) {
                    const cb = document.getElementById(`${idBase}-${user.id}`);
                    const lbl = document.getElementById(`${idBase}-label-${user.id}`);
                    if (!cb || !lbl) return;
                    const sync = () => {
                        if (cb.checked) { lbl.textContent = '許可する'; lbl.classList.remove('muted'); }
                        else { lbl.textContent = '許可しない'; lbl.classList.add('muted'); }
                    };
                    sync();
                    cb.addEventListener('change', sync);
                }
                bindToggle('ls-half');
                bindToggle('ls-hour');
                bindToggle('ls-negative');
            })();
        }

        window.saveLeaveSettings = async function (userId) {
            const body = {
                user_id: userId,
                default_paid_leave_type_id: parseInt(document.getElementById(`ls-type-${userId}`).value),
                default_unit_id: parseInt(document.getElementById(`ls-unit-${userId}`).value),
                allow_half_day: document.getElementById(`ls-half-${userId}`).checked ? 1 : 0,
                allow_hourly: document.getElementById(`ls-hour-${userId}`).checked ? 1 : 0,
                base_hours_per_day_override: (function (v) { return v === '' ? null : parseFloat(v); })(document.getElementById(`ls-base-${userId}`).value),
                carryover_months: parseInt(document.getElementById(`ls-carry-m-${userId}`).value || '0'),
                carryover_max_minutes: parseInt(document.getElementById(`ls-carry-min-${userId}`).value || '0'),
                negative_balance_allowed: document.getElementById(`ls-negative-${userId}`).checked ? 1 : 0,
            };
            const btn = document.querySelector(`#leave-settings-wrap-${userId} .btn`);
            if (btn) btn.disabled = true;
            const res = await fetchWithAuth('api/admin_user_leave_settings_update.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            if (btn) btn.disabled = false;
            if (res && res.ok) {
                alert('設定を保存しました');
            } else if (res) {
                alert('保存に失敗しました');
            }
        }

        function mountLeaveGrant(user, masters, settings) {
            const wrap = document.getElementById(`leave-grant-wrap-${user.id}`);
            if (!wrap) return;
            wrap.innerHTML = `
                            <div class="grid">
                                <div>付与日</div>
                                                <div><input type="date" id="lg-date-${user.id}"></div>
                                <div>付与時間</div>
                                <div class="inline"><input type="number" step="0.25" min="0" id="lg-hours-${user.id}" style="width:90px; text-align:right;"> h</div>
                                <div>有効期限（任意）</div>
                                                <div><input type="date" id="lg-expire-${user.id}"></div>
                                <div></div>
                                <div><button class="btn" onclick="grantLeave(${user.id})">付与する</button></div>
                            </div>
                            <div class="field-note">注: ログへの詳細記録は次フェーズで拡張予定です</div>
                        `;
            // デフォルト値設定: 今日と（設定に基づく）有効期限
            const today = new Date();
            const pad = (n) => String(n).padStart(2, '0');
            const dstr = `${today.getFullYear()}-${pad(today.getMonth() + 1)}-${pad(today.getDate())}`;
            const months = orgSettings ? Number(orgSettings.paid_leave_valid_months || 24) : 24;
            const addMonths = (date, m) => {
                const dt = new Date(date.getTime());
                const d = dt.getDate();
                dt.setMonth(dt.getMonth() + m);
                // 月末補正
                if (dt.getDate() < d) dt.setDate(0);
                return dt;
            };
            const exp = months > 0 ? addMonths(today, months) : null;
            const expEff = exp ? (function () { const t = new Date(exp.getTime()); t.setDate(t.getDate() - 1); return t; })() : null;
            const estr = expEff ? `${expEff.getFullYear()}-${pad(expEff.getMonth() + 1)}-${pad(expEff.getDate())}` : '';
            const dEl = document.getElementById(`lg-date-${user.id}`);
            const eEl = document.getElementById(`lg-expire-${user.id}`);
            dEl.value = dstr;
            if (estr) eEl.value = estr; else eEl.value = '';
            dEl.addEventListener('change', () => {
                // 付与日変更時、期限未編集なら設定値（月）に応じて自動更新
                const val = dEl.value;
                if (!val) return;
                const dt = new Date(val);
                if (isNaN(dt)) return;
                const ex2 = months > 0 ? addMonths(dt, months) : null;
                const ex2Eff = ex2 ? (function () { const t = new Date(ex2.getTime()); t.setDate(t.getDate() - 1); return t; })() : null;
                const ecur = eEl.value;
                // ユーザーが手動で上書きした可能性を考慮し、空または初期値と同じなら更新
                if (!ecur || ecur === estr) {
                    if (ex2Eff) {
                        const nstr = `${ex2Eff.getFullYear()}-${pad(ex2Eff.getMonth() + 1)}-${pad(ex2Eff.getDate())}`;
                        eEl.value = nstr;
                    } else {
                        eEl.value = '';
                    }
                }
            });
        }

        window.grantLeave = async function (userId) {
            const date = (document.getElementById(`lg-date-${userId}`).value || '').trim();
            const hoursStr = (document.getElementById(`lg-hours-${userId}`).value || '').trim();
            const expire = (document.getElementById(`lg-expire-${userId}`).value || '').trim();
            if (!date || hoursStr === '') { alert('付与日と付与時間を入力してください'); return; }
            const hours = parseFloat(hoursStr);
            const body = { user_id: userId, grant_date: date, grant_hours: hours, expire_date: expire || null };
            const btn = document.querySelector(`#leave-grant-wrap-${userId} .btn`);
            if (btn) btn.disabled = true;
            const res = await fetchWithAuth('api/paid_leave_grant.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            if (btn) btn.disabled = false;
            if (res && res.ok) {
                alert('有給を付与しました');
                // 残高・履歴を即時更新
                mountLeaveBalance(userId);
            } else if (res) {
                alert('付与に失敗しました');
            }
        }

        async function loadBalance(userId) {
            const res = await fetchWithAuth(`api/paid_leave_balance.php?user_id=${userId}`);
            if (!res || !res.ok) throw new Error('balance');
            return await res.json();
        }
        async function loadHistory(userId) {
            const res = await fetchWithAuth(`api/paid_leave_history.php?user_id=${userId}&limit=50`);
            if (!res || !res.ok) throw new Error('history');
            return await res.json();
        }
        async function mountLeaveBalance(userId) {
            const wrap = document.getElementById(`leave-balance-wrap-${userId}`);
            if (!wrap) return;
            try {
                const [b, h] = await Promise.all([loadBalance(userId), loadHistory(userId)]);
                const fmt = (n) => (Math.round(n * 100) / 100).toFixed(2);
                // 表示モード（分割/統合）: LocalStorageに記憶
                const MODE_KEY = 'leave_view_mode';
                let mode = localStorage.getItem(MODE_KEY) || 'split'; // 'split' | 'unified'

                // データ整形
                const grants = h.grants || [];
                const useEvents = Array.isArray(h.use_events) ? h.use_events : (h.uses || []);
                const expires = h.expires || [];

                // ヘッダー（サマリ＋モード切替）
                function renderHeader() {
                    return `
                        <div class="grid" style="margin-bottom:8px;">
                            <div>合計付与（全期間）</div><div style="text-align:right;">${fmt(b.granted_total_hours)} h</div>
                            <div>有効付与（本日時点）</div><div style="text-align:right;">${fmt(b.granted_active_hours)} h</div>
                            <div>合計利用（USEのみ、失効除外）</div><div style="text-align:right;">${fmt(b.used_total_hours)} h</div>
                            <div>残高（現在のサマリ）</div><div style="text-align:right; font-weight:600;">${fmt(b.balance_hours)} h</div>
                            <div>基準日</div><div>${b.as_of}</div>
                        </div>
                                                <div style="display:flex;align-items:center;gap:0.8em;margin:6px 0 10px 0;">
                                                    <span class="muted">表示モード</span>
                                                    <label class="toggle-s" for="lv-mode-toggle-${userId}">
                                                        <input type="checkbox" class="toggle__input-s" id="lv-mode-toggle-${userId}" ${mode === 'unified' ? 'checked' : ''} />
                                                        <span class="toggle__slider-s"></span>
                                                    </label>
                                                    <label for="lv-mode-toggle-${userId}" style="cursor:pointer; user-select:none"> 統合表示</label>
                                                </div>
                    `;
                }

                // 分割表示
                function renderSplit() {
                    const grantRows = grants.length ? grants.map(g => `
                        <tr class="clickable" data-kind="grant" data-id="${g.id}" data-date="${g.grant_date}" data-hours="${g.grant_hours}" data-expire="${g.expire_date ?? ''}">
                            <td class="date-cell">${g.grant_date}</td>
                            <td class="hour-cell">${fmt(g.grant_hours)} h</td>
                            <td class="date-cell">${(!g.expire_date || String(g.expire_date).startsWith('9999-')) ? '無期限' : g.expire_date}</td>
                        </tr>
                    `).join('') : `<tr><td colspan='3' class='muted'>付与履歴はありません</td></tr>`;

                    const useRows = (useEvents && useEvents.length) ? useEvents.map(u => `
                        <tr class="clickable" data-kind="use" ${u.event_id ? `data-eid="${u.event_id}"` : `data-legacy="1" data-id="${u.id || ''}"`} data-date="${u.used_date}" data-hours="${u.used_hours}" data-reason="${u.reason ?? ''}">
                            <td class="date-cell">${u.used_date}</td>
                            <td class="hour-cell">${fmt(u.used_hours)} h</td>
                            <td>${u.reason ?? ''}</td>
                        </tr>
                    `).join('') : `<tr><td colspan='3' class='muted'>利用履歴はありません</td></tr>`;

                    return `
                        <div class="two-col">
                          <div>
                            <div class="muted" style="font-weight:600; margin-bottom:6px;">付与履歴（最新50件）</div>
                            <table class="user-table" style="margin:0;">
                                <thead><tr><th class="date-cell">付与日</th><th class="hour-cell">時間</th><th class="date-cell">有効期限</th></tr></thead>
                                <tbody id="lv-grants-${userId}">${grantRows}</tbody>
                            </table>
                          </div>
                          <div>
                            <div class="muted" style="font-weight:600; margin-bottom:6px;">利用履歴（最新50件）</div>
                            <table class="user-table" style="margin:0;">
                                <thead><tr><th class="date-cell">利用日</th><th class="hour-cell">時間</th><th>理由</th></tr></thead>
                                <tbody id="lv-uses-${userId}">${useRows}</tbody>
                            </table>
                          </div>
                        </div>
                    `;
                }

                // 統合表示
                function buildUnifiedRows() {
                    const rows = [];
                    (grants || []).forEach(g => rows.push({ kind: 'grant', date: g.grant_date, hours: parseFloat(g.grant_hours) || 0, reason: '付与', expire: g.expire_date || '', grant_id: g.id }));
                    (useEvents || []).forEach(u => rows.push({ kind: 'use', date: u.used_date, hours: parseFloat(u.used_hours) || 0, reason: u.reason || '', event_id: u.event_id || null, log_id: u.id || null }));
                    (expires || []).forEach(x => rows.push({ kind: 'expire', date: x.used_date, hours: parseFloat(x.used_hours) || 0, reason: '失効' }));
                    const kindOrder = (k) => (k === 'expire' ? 0 : (k === 'use' ? 1 : 2));
                    rows.sort((a, b) => a.date === b.date ? (kindOrder(a.kind) - kindOrder(b.kind)) : (a.date < b.date ? -1 : 1));
                    // 表示は新しい→古い
                    rows.reverse();
                    return rows;
                }
                function renderUnified() {
                    const rows = buildUnifiedRows();
                    const trHtml = rows.length ? rows.map(r => {
                        const hstr = (Math.round(r.hours * 100) / 100).toFixed(2);
                        const sign = r.kind === 'grant' ? '+' : '-';
                        const kindLabel = r.kind === 'grant' ? '付与' : (r.kind === 'expire' ? '失効' : '取得');
                        const exp = r.kind === 'grant' ? ((!r.expire || String(r.expire).startsWith('9999-')) ? '無期限' : r.expire) : '';
                        const dataAttr = r.kind === 'grant' ? `data-kind="grant" data-id="${r.grant_id}" data-date="${r.date}" data-hours="${r.hours}" data-expire="${r.expire || ''}"`
                            : (r.kind === 'use' ? `data-kind="use" ${(r.event_id ? `data-eid="${r.event_id}"` : `data-legacy="1" data-id="${r.log_id || ''}"`)} data-date="${r.date}" data-hours="${r.hours}" data-reason="${r.reason || ''}"` : `data-kind="expire"`);
                        const clickable = r.kind !== 'expire' ? 'clickable' : '';
                        return `<tr class="${clickable}" ${dataAttr}>
                            <td class="date-cell">${r.date}</td>
                            <td>${kindLabel}</td>
                            <td class="hour-cell">${sign}${hstr} h</td>
                            <td>${r.reason || ''}</td>
                            <td class="date-cell">${exp}</td>
                        </tr>`;
                    }).join('') : `<tr><td colspan='5' class='muted'>履歴はありません</td></tr>`;
                    return `
                        <table class="user-table" style="margin:0;">
                            <thead><tr><th class="date-cell">発生日</th><th>種別</th><th class="hour-cell">時間</th><th>理由</th><th class="date-cell">有効期限</th></tr></thead>
                            <tbody id="lv-unified-${userId}">${trHtml}</tbody>
                        </table>
                    `;
                }

                function renderAll() {
                    wrap.innerHTML = renderHeader() + (mode === 'split' ? renderSplit() : renderUnified());

                    // モード切替（トグル）
                    const modeToggle = wrap.querySelector(`#lv-mode-toggle-${userId}`);
                    if (modeToggle) {
                        modeToggle.addEventListener('change', () => {
                            mode = modeToggle.checked ? 'unified' : 'split';
                            localStorage.setItem(MODE_KEY, mode);
                            renderAll();
                        });
                    }

                    // 展開編集ハンドラ（委譲）
                    function attachRowHandler(tbodySel, colCount) {
                        const tbody = wrap.querySelector(tbodySel);
                        if (!tbody) return;
                        tbody.addEventListener('click', async (e) => {
                            const tr = e.target.closest('tr.clickable');
                            if (!tr) return;
                            // 既存の展開が直後にあれば閉じる
                            if (tr.nextElementSibling && tr.nextElementSibling.classList.contains('expand-row')) {
                                tr.nextElementSibling.remove();
                                return;
                            }
                            // 一旦、同テーブル内の他の展開を閉じる
                            Array.from(tbody.querySelectorAll('tr.expand-row')).forEach(x => x.remove());
                            const kind = tr.getAttribute('data-kind');
                            const date = tr.getAttribute('data-date') || '';
                            const hours = parseFloat(tr.getAttribute('data-hours') || '0') || 0;
                            const reason = tr.getAttribute('data-reason') || '';
                            const expire = tr.getAttribute('data-expire') || '';
                            const grantId = tr.getAttribute('data-id');
                            const eid = tr.getAttribute('data-eid');
                            const legacy = tr.getAttribute('data-legacy') === '1';
                            const expTr = document.createElement('tr');
                            expTr.className = 'expand-row';
                            expTr.innerHTML = `<td colspan="${colCount}">
                                <div style="display:flex;flex-direction:column;gap:0.6em;">
                                  ${kind === 'grant' ? `
                                    <div style="font-weight:600;color:#1976d2;">付与の編集</div>
                                    <div style="display:flex;gap:1em;flex-wrap:wrap;align-items:center;">
                                      <label>付与日 <input type="date" id="gr-ed-date" value="${date}"></label>
                                      <label>時間 <input type="number" step="0.25" min="0" id="gr-ed-hours" value="${hours}" style="width:90px;text-align:right;"> h</label>
                                      <label>有効期限 <input type="date" id="gr-ed-exp" value="${expire}"></label>
                                    </div>
                                    <div style="display:flex;gap:0.6em;justify-content:flex-end;">
                                      <button class="btn" id="gr-save">保存</button>
                                      <button class="btn" id="gr-del" style="background:#e57373;">削除</button>
                                      <button class="btn" id="gr-cancel">閉じる</button>
                                    </div>
                                  ` : (kind === 'use' ? `
                                    <div style="font-weight:600;color:#1976d2;">利用の編集</div>
                                    <div style="display:flex;gap:1em;flex-wrap:wrap;align-items:center;">
                                      <label>利用日 <input type="date" id="us-ed-date" value="${date}"></label>
                                      <label>時間 <input type="number" step="0.25" min="0.25" id="us-ed-hours" value="${hours}" style="width:90px;text-align:right;"> h</label>
                                      <label>理由 <input type="text" id="us-ed-reason" value="${reason}" style="min-width:200px;"></label>
                                    </div>
                                    <div style="display:flex;gap:0.6em;justify-content:flex-end;">
                                      ${eid ? `<button class="btn" id="us-save">保存</button><button class="btn" id="us-del" style="background:#e57373;">削除</button>` : `<button class="btn" id="us-del-legacy" style="background:#e57373;">このログを削除</button>`}
                                      <button class="btn" id="us-cancel">閉じる</button>
                                    </div>
                                  ` : `
                                    <div class="muted">失効履歴は編集できません。</div>
                                    <div style="text-align:right;"><button class="btn" id="ex-cancel">閉じる</button></div>
                                  `)}
                                </div>
                              </td>`;
                            tr.insertAdjacentElement('afterend', expTr);

                            // ボタン動作
                            if (kind === 'grant') {
                                expTr.querySelector('#gr-cancel').onclick = () => expTr.remove();
                                expTr.querySelector('#gr-save').onclick = async () => {
                                    const body = {
                                        id: parseInt(grantId),
                                        grant_date: expTr.querySelector('#gr-ed-date').value,
                                        grant_hours: parseFloat(expTr.querySelector('#gr-ed-hours').value || '0') || 0,
                                        expire_date: (function (v) { return v === '' ? null : v; })(expTr.querySelector('#gr-ed-exp').value)
                                    };
                                    const res = await fetchWithAuth('api/paid_leave_grant_update.php', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
                                    if (res && res.ok) { await mountLeaveBalance(userId); }
                                    else if (res) { const j = await res.json(); alert(j.error || '更新に失敗しました'); }
                                };
                                expTr.querySelector('#gr-del').onclick = async () => {
                                    if (!confirm('この付与を削除します。消化済みの付与は削除できません。実行しますか？')) return;
                                    const res = await fetchWithAuth('api/paid_leave_grant_delete.php', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id: parseInt(grantId) }) });
                                    if (res && res.ok) { await mountLeaveBalance(userId); }
                                    else if (res) { const j = await res.json(); alert(j.error || '削除に失敗しました'); }
                                };
                            } else if (kind === 'use') {
                                const close = () => expTr.remove();
                                const eidNum = eid ? parseInt(eid) : 0;
                                const saveBtn = expTr.querySelector('#us-save');
                                const delBtn = expTr.querySelector('#us-del');
                                const delLegacyBtn = expTr.querySelector('#us-del-legacy');
                                const cancelBtn = expTr.querySelector('#us-cancel');
                                if (cancelBtn) cancelBtn.onclick = close;
                                if (eidNum && saveBtn) saveBtn.onclick = async () => {
                                    const body = {
                                        event_id: eidNum,
                                        user_id: userId,
                                        used_date: expTr.querySelector('#us-ed-date').value,
                                        used_hours: parseFloat(expTr.querySelector('#us-ed-hours').value || '0') || 0,
                                        reason: expTr.querySelector('#us-ed-reason').value || ''
                                    };
                                    const res = await fetchWithAuth('api/paid_leave_use_event_update.php', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
                                    if (res && res.ok) { await mountLeaveBalance(userId); }
                                    else if (res) { const j = await res.json(); alert(j.error || '更新に失敗しました'); }
                                };
                                if (eidNum && delBtn) delBtn.onclick = async () => {
                                    if (!confirm('この利用イベント（複数明細）を削除します。実行しますか？')) return;
                                    const res = await fetchWithAuth('api/paid_leave_use_event_delete.php', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ event_id: eidNum, user_id: userId }) });
                                    if (res && res.ok) { await mountLeaveBalance(userId); }
                                    else if (res) { const j = await res.json(); alert(j.error || '削除に失敗しました'); }
                                };
                                if (legacy && delLegacyBtn) delLegacyBtn.onclick = async () => {
                                    const logId = parseInt(grantId || '0'); // data-idにlog idを格納
                                    if (!logId) { alert('削除対象が見つかりません'); return; }
                                    if (!confirm('この利用ログを削除します。実行しますか？')) return;
                                    const res = await fetchWithAuth('api/paid_leave_use_delete.php', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id: logId }) });
                                    if (res && res.ok) { await mountLeaveBalance(userId); }
                                    else if (res) { const j = await res.json(); alert(j.error || '削除に失敗しました'); }
                                };
                            } else {
                                const btn = expTr.querySelector('#ex-cancel');
                                if (btn) btn.onclick = () => expTr.remove();
                            }
                        });
                    }

                    if (mode === 'split') {
                        attachRowHandler(`#lv-grants-${userId}`, 3);
                        attachRowHandler(`#lv-uses-${userId}`, 3);
                    } else {
                        attachRowHandler(`#lv-unified-${userId}`, 5);
                    }
                }

                renderAll();
            } catch (e) {
                wrap.innerHTML = `<span class='danger'>残高・履歴の読み込みに失敗しました</span>`;
            }
        }

        (async function init() {
            await loadOrgSettings();
            await renderTable();
        })();
    </script>
</body>

</html>